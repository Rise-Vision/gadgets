function Venue(){var a=new gadgets.Prefs;this.location=a.getString("location"),this.showCrown=a.getBool("showCrown"),this.showTips=a.getBool("showTips"),this.showSpecials=a.getBool("showSpecials"),this.showPhotos=a.getBool("showPhotos"),this.showMayor=a.getBool("showMayor"),this.showCheckIns=a.getBool("showCheckIns"),this.showQR=a.getBool("showQR"),this.layoutURL=a.getString("layoutURL")?a.getString("layoutURL"):"https://s3.amazonaws.com/Gadget-Foursquare/Default.xml",this.rsW=a.getInt("rsW"),this.rsH=a.getInt("rsH"),this.mayor=new Object,this.tips=[],this.specials=[],this.photos=[],this.tipsIndex=0,this.specialsIndex=0,this.photosIndex=0,this.hasTips=!1,this.hasSpecials=!1,this.hasPhotos=!1,this.contentTimer=null,this.updateTimerExpired=!1,this.refreshInterval=1e4,this.updateInterval=6e4,this.isLoading=!0,this.isUpdating=!1,this.currentContentType=null,this.contentTypes={tips:"tips",specials:"specials",photos:"photos"}}Venue.prototype.loadLayout=function(){var a={},b=this,c=$("<link>");this.styleURL&&(c.attr({type:"text/css",rel:"stylesheet",href:this.styleURL}),$("head").append(c)),this.layoutURL&&(a[gadgets.io.RequestParameters.CONTENT_TYPE]=gadgets.io.ContentType.DOM,gadgets.io.makeRequest(this.layoutURL,function(a){var c=a.data;if(c.getElementsByTagName("Style").length>0){var d=document.getElementsByTagName("head")[0],e=document.createElement("style");e.type="text/css",e.innerHTML=c.getElementsByTagName("Style")[0].childNodes[1].nodeValue,d.appendChild(e)}0!=c.getElementsByTagName("Layout").length&&($("#container").html(c.getElementsByTagName("Layout")[0].childNodes[1].nodeValue),$("#container").append("<div class='error'></div>"),b.getData())},a))},Venue.prototype.getData=function(){gadgets.rpc.call("","rsparam_get",null,(new gadgets.Prefs).getString("id"),"social:foursquare")},Venue.prototype.processData=function(a,b,c){if(c){var d=JSON.parse(c);a.token=d.access,d.access?("display"==a.location&&d.displayLocation?a.venueID=d.displayLocation:a.venueID=d.companyLocation,a.getVenue()):(a.showError("Please create a Foursquare Social Connection for your Company or Display before using this Gadget."),readyEvent())}else a.isLoading=!1,a.showError("Please create a Foursquare Social Connection for your Company or Display before using this Gadget."),readyEvent()},Venue.prototype.getVenue=function(){var a={},b=this;this.tips=[],this.specials=[],this.photos=[],this.hasTips=!1,this.hasSpecials=!1,this.hasPhotos=!1,a[gadgets.io.RequestParameters.CONTENT_TYPE]=gadgets.io.ContentType.JSON,a[gadgets.io.RequestParameters.REFRESH_INTERVAL]=60,gadgets.io.makeRequest("https://api.foursquare.com/v2/venues/"+this.venueID+"?oauth_token="+this.token+"&v=20131212",function(a){if(a.data){var c,d,h=a.data.response.venue,i=0;if($("#content").show(),$(".error").hide(),0==h.mayor.count?($("#crown").hide(),$("#mayor").hide(),$(".mayor").hide(),$(".noMayor").show()):h.mayor.user&&(b.showMayor?$(".photo").attr("src",h.mayor.user.photo?h.mayor.user.photo.prefix+"110x110"+h.mayor.user.photo.suffix:""):$(".photo").remove(),$(".message").show(),$(".noMayor").hide(),$(".mayorName").text(h.mayor.user.firstName?h.mayor.user.firstName:""),$(".mayorCheckins").text(h.mayor.count)),b.showCrown||$("#crown").hide(),b.showCheckIns||$("#description").hide(),h.stats&&$(".checkins").text(h.stats.checkinsCount?h.stats.checkinsCount:0),b.showQR?$(".qrCode").attr("src","https://chart.googleapis.com/chart?cht=qr&chs=110x110&chld=H|0&chl="+encodeURIComponent("https://foursquare.com/mobile/venue/"+b.venueID)):$("#qr").remove(),b.showTips)for(c=0;c<h.tips.groups.length;c++)for(d=0;d<h.tips.groups[c].items.length;d++){var j=new Date(1e3*h.tips.groups[c].items[d].createdAt);b.tips[i]=new Object,b.tips[i].name=h.tips.groups[c].items[d].user.firstName,b.tips[i].photo=h.tips.groups[c].items[d].user.photo,b.tips[i].text=h.tips.groups[c].items[d].text,b.tips[i].date=j.toString("MMMM d, yyyy"),b.hasTips=!0,i++}if(b.showSpecials)for(c=0;c<h.specials.length;c++,d++)b.specials[c]=new Object,b.specials[c].icon=h.specials[c].icon,b.specials[c].title=h.specials[c].title,b.specials[c].text=h.specials[c].message,b.hasSpecials=!0;if(i=0,b.showPhotos){for(c=0;c<h.photos.groups.length;c++)for(d=0;d<h.photos.groups[c].items.length;d++)b.photos[i]=new Object,b.photos[i].url=h.photos.groups[c].items[d].prefix+"original"+h.photos.groups[c].items[d].suffix,b.photos[i].width=h.photos.groups[c].items[d].width,b.photos[i].height=h.photos.groups[c].items[d].height,b.hasPhotos=!0,i++;if(b.hasPhotos){b.rsW>b.rsH?($("#lower").height($("#container").height()-$("#upper").outerHeight(!0)),b.cf&&(b.cf=null,$(".flow").empty()),b.cf=new ContentFlow("cf",{flowSpeedFactor:2,scaleFactor:1,maxItemHeight:.5*$("#lower").height(),reflectionHeight:0})):b.cf=new ContentFlow("cf",{flowSpeedFactor:2,scaleFactor:1,reflectionHeight:0});var k=0,l=b.photos.length;$.each(b.photos,function(a,c){var d=$("<div class='item'>"),e=$("<img class='content'>");e.load(function(){d.append(e),b.cf.addItem(d.get(0),"last",function(){k++,k==l&&(1==l?(b.hideCoverFlow(),b.setContentType(),b.isLoading=!1,readyEvent()):b.cf.moveTo("first",function(){b.hideCoverFlow(),b.setContentType(),b.isLoading=!1,readyEvent()}))})}),e.error(function(){console.log("Image could not be loaded: "+c.url),k++}),e.attr("src",c.url)})}else b.setContentType(),b.isLoading=!1,readyEvent()}else b.setContentType(),b.isLoading=!1,readyEvent();setTimeout(function(){b.expireUpdatesTimer(b)},b.updateInterval)}else a.errors.length>0&&("400 Error"==a.errors[0]?b.showError(b.venueID+" is not a valid Venue ID."):"401 Error"==a.errors[0]&&b.showError("The Foursquare token has been revoked. Please generate a new one.")),b.isLoading=!1,readyEvent()},a)},Venue.prototype.showError=function(a){var b=this;$("#content").hide(),$(".error").text(a).show(),setTimeout(function(){b.getData()},this.updateInterval)},Venue.prototype.setContentType=function(){this.currentContentType?this.currentContentType==this.contentTypes.tips?this.hasSpecials?this.currentContentType=this.contentTypes.specials:this.hasPhotos&&(this.currentContentType=this.contentTypes.photos):this.currentContentType==this.contentTypes.specials?this.hasPhotos?this.currentContentType=this.contentTypes.photos:this.hasTips&&(this.currentContentType=this.contentTypes.tips):this.hasTips?(this.currentContentType=this.contentTypes.tips,$("#wrapper").show()):this.hasSpecials&&(this.currentContentType=this.contentTypes.specials,$("#wrapper").show()):this.hasTips?this.currentContentType=this.contentTypes.tips:this.hasSpecials?this.currentContentType=this.contentTypes.specials:this.hasPhotos?this.currentContentType=this.contentTypes.photos:($("#tips").hide(),$("#specials").hide(),this.hideCoverFlow()),this.showContent()},Venue.prototype.showContent=function(){switch(this.currentContentType){case this.contentTypes.tips:this.displayTips();break;case this.contentTypes.specials:this.displaySpecials();break;case this.contentTypes.photos:this.showNextPhoto()}},Venue.prototype.displayTips=function(){$("#wrapper");this.tipsIndex==this.tips.length?(this.tipsIndex=0,this.setContentType()):this.isLoading||(0==this.tipsIndex?!this.hasSpecials&&!this.hasPhotos&&this.tips.length<=2?this.fadeInTips():$("#wrapper").hasClass("fadeOut")?this.fadeInTips():this.fadeOutTips():this.fadeOutTips())},Venue.prototype.fadeOutTips=function(){var a=this;$("#wrapper").bind("webkitTransitionEnd",function(b){a.fadeInTips(),$(this).unbind(b)}),$("#wrapper").addClass("fadeOut").removeClass("fadeIn")},Venue.prototype.fadeInTips=function(){var a=this,b=$("#wrapper");this.hideCoverFlow(),b.show(),$("#specials").hide(),$("#tips").show(),$(".tipPhotoWrapper").show(),$(".tipWrapper").show(),this.loadTips(),b.hasClass("fadeIn")?a.startTimer():(b.bind("webkitTransitionEnd",function(b){a.startTimer(),$(this).unbind(b)}),b.addClass("fadeIn").removeClass("fadeOut"))},Venue.prototype.loadTips=function(){var a=this;$(".tipPhoto").each(function(b){return a.tipsIndex==a.tips.length&&b==$(".tipPhoto").length-1?($(".tipPhotoWrapper").slice(b).hide(),$(".tipWrapper").slice(b).hide(),!1):($(this).attr("src",a.tips[a.tipsIndex].photo.prefix+"110x110"+a.tips[a.tipsIndex].photo.suffix),$(".tip").eq(b).text(a.tips[a.tipsIndex].text),$(".tipName").eq(b).text(a.tips[a.tipsIndex].name),$(".tipDate").eq(b).text(a.tips[a.tipsIndex].date),void a.tipsIndex++)})},Venue.prototype.displaySpecials=function(){$("#wrapper");this.specialsIndex==this.specials.length?(this.specialsIndex=0,this.setContentType()):this.isLoading||(0==this.specialsIndex?!this.hasTips&&!this.hasPhotos&&this.specials.length<=2?this.fadeInSpecials():$("#wrapper").hasClass("fadeOut")?this.fadeInSpecials():this.fadeOutSpecials():this.fadeOutSpecials())},Venue.prototype.fadeOutSpecials=function(){var a=this;$("#wrapper").bind("webkitTransitionEnd",function(b){a.fadeInSpecials(),$(this).unbind(b)}),$("#wrapper").addClass("fadeOut").removeClass("fadeIn")},Venue.prototype.fadeInSpecials=function(){var a=this,b=$("#wrapper");this.hideCoverFlow(),b.show(),$("#tips").hide(),$("#specials").show(),$(".specialLogoWrapper").show(),$(".specialWrapper").show(),this.loadSpecials(),b.hasClass("fadeIn")?a.startTimer():(b.bind("webkitTransitionEnd",function(b){a.startTimer(),$(this).unbind(b)}),b.addClass("fadeIn").removeClass("fadeOut"))},Venue.prototype.loadSpecials=function(){var a=this;$(".specialLogo").each(function(b){return a.specialsIndex==a.specials.length&&b==$(".specialLogo").length-1?($(".specialLogoWrapper").slice(b).hide(),$(".specialWrapper").slice(b).hide(),!1):($(this).attr("src","https://foursquare.com/img/specials/"+a.specials[a.specialsIndex].icon+".png"),$(".specialTitle").eq(b).text(a.specials[a.specialsIndex].title),$(".special").eq(b).text(a.specials[a.specialsIndex].text),void a.specialsIndex++)})},Venue.prototype.showNextPhoto=function(){var a=this,b=$("#wrapper");this.photosIndex==this.photos.length?(this.photosIndex=0,this.setContentType()):this.isLoading||(this.cf.moveTo(this.photosIndex),0==this.photosIndex&&(b.hasClass("fadeIn")?(b.bind("webkitTransitionEnd",function(c){b.hide(),a.showCoverFlow(),$(this).unbind(c)}),b.addClass("fadeOut").removeClass("fadeIn")):(b.hide(),this.showCoverFlow())),this.photosIndex++,this.startTimer())},Venue.prototype.startTimer=function(){var a=this;this.contentTimer=setTimeout(function(){a.checkForUpdates(),a.isUpdating?(a.currentContentType==a.contentTypes.tips?a.tipsIndex=0:a.currentContentType==a.contentTypes.specials?a.specialsIndex=0:a.photosIndex=0,a.updateTimerExpired=!1,a.getData()):a.currentContentType==a.contentTypes.tips?a.displayTips():a.currentContentType==a.contentTypes.specials?a.displaySpecials():a.showNextPhoto()},this.refreshInterval)},Venue.prototype.hideCoverFlow=function(){$("#cf").css({top:"10000px"}),$("#photos").addClass("photoFadeOut").removeClass("fadeIn")},Venue.prototype.showCoverFlow=function(){$("#cf").css({top:""}),$("#photos").addClass("fadeIn").removeClass("photoFadeOut")},Venue.prototype.startContentTimer=function(){this.currentContentType==this.contentTypes.tips?this.fadeInTips():this.currentContentType==this.contentTypes.specials?this.fadeInSpecials():this.currentContentType==this.contentTypes.photos&&this.showNextPhoto()},Venue.prototype.stopContentTimer=function(){clearTimeout(this.contentTimer)},Venue.prototype.expireUpdatesTimer=function(a){a.updateTimerExpired=!0},Venue.prototype.checkForUpdates=function(){this.isUpdating=!1,this.updateTimerExpired&&(this.currentContentType==this.contentTypes.tips&&this.tipsIndex==this.tips.length?this.isUpdating=!0:this.currentContentType==this.contentTypes.specials&&this.specialsIndex==this.specials.length&&0==this.tips.length?this.isUpdating=!0:this.currentContentType==this.contentTypes.photos&&this.photosIndex==this.photos.length&&0==this.tips.length&&0==this.specials.length?this.isUpdating=!0:this.currentContentType||(this.isUpdating=!0))};