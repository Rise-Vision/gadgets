function PhotoAlbum(){var a=new gadgets.Prefs;this.url=a.getString("url"),this.visualOption=a.getString("visualOption"),this.maxImages=a.getInt("maxImages"),this.entries=null,this.isLoading=!0,this.isFeedLoaded=!1,this.isLastPhoto=!1,this.isStarted=!1,this.feedLoadFailedTimer=null,this.feedLoadFailedCount=0,this.images=[],this.captions=[],this.imageCount=0}PhotoAlbum.prototype.initialize=function(){var a=this;$.ajaxSetup({cache:!0}),"slideShow"==this.visualOption?($("<link/>",{rel:"stylesheet",type:"text/css",href:"https://s3.amazonaws.com/Gadget-Photo-Album/SlideShow/css/SlideShow.css"}).appendTo("head"),$.getScript("https://s3.amazonaws.com/Gadget-Photo-Album/SlideShow/js/SlideShow.min.js",function(){a.loadFeed()})):"collage"==this.visualOption?($("<link/>",{rel:"stylesheet",type:"text/css",href:"https://s3.amazonaws.com/Gadget-Photo-Album/Collage/css/Collage.css"}).appendTo("head"),$.getScript("https://s3.amazonaws.com/Gadget-Photo-Album/Collage/js/Collage.min.js",function(){a.loadFeed()})):"coverFlow"==this.visualOption&&this.loadFeed()},PhotoAlbum.prototype.loadFeed=function(){var a=this,b={};b[gadgets.io.RequestParameters.CONTENT_TYPE]=gadgets.io.ContentType.DOM,b[gadgets.io.RequestParameters.REFRESH_INTERVAL]=60,this.feedLoadFailedTimer=setTimeout(function(){a.feedLoadFailed()},5e3),gadgets.io.makeRequest(this.url,function(b){0==b.errors.length&&(clearTimeout(a.feedLoadFailedTimer),a.onFeedLoaded(b))},b)},PhotoAlbum.prototype.onFeedLoaded=function(a){var b;this.isFeedLoaded=!0;for(var c=a.data.getElementsByTagName("item").length-1;c>=this.maxImages;c--)b=a.data.getElementsByTagName("item")[c],b.parentNode.removeChild(b);a.data&&a.data.getElementsByTagName("item").length>0?(this.entries=a.data.getElementsByTagName("item"),this.loadPhotos()):(console.log("This feed has no items."),readyEvent())},PhotoAlbum.prototype.loadPhotos=function(){var a,b,c,d,e,f;self=this,prefs=new gadgets.Prefs,rsW=prefs.getInt("rsW"),rsH=prefs.getInt("rsH"),supportedTypes=new Array("image/bmp","image/gif","image/jpeg","image/png","image/tiff"),this.oldImages=this.images,this.images=new Array,this.captions=new Array,$.each(this.entries,function(g,h){if(a=$(this).find("group"),a.length>0){if(b=a.find("content"),b.length>0)for(var i in supportedTypes)if(b.attr("type")==supportedTypes[i]){f={},e=b.attr("url"),self.addCaption(a.find("title").text(),a.find("description").text(),e),f.src=e,f.caption=self.captions[g].caption,self.images.push(f),self.load(f.src,g);break}}else if(b=$(this).find("content"),b.length>0){for(var i in supportedTypes)if(b.attr("type")==supportedTypes[i]){f={},c=$(this).find("title"),d=$(this).find("description"),e=b.attr("url"),c=c.length>1?$(c[1]).text():$(c).text(),d=d.length>1?$(d[1]).text():$(d).text(),self.addCaption(c,d,e),f.src=e,f.caption=self.captions[g].caption,self.images.push(f),self.load(f.src,g);break}}else self.isLoading&&(self.isLoading=!1,readyEvent())})},PhotoAlbum.prototype.addCaption=function(a,b,c,d){var e,f=this.url.indexOf("https://picasaweb.google.com",0)!=-1;e=f?null==b||""==b?a:b:null==a||""==a?b:a,d?this.captions.unshift({src:c,caption:e}):this.captions.push({src:c,caption:e})},PhotoAlbum.prototype.load=function(a,b){"slideShow"==this.visualOption?this.loadSlideShow(a,b):"coverFlow"==this.visualOption?this.loadCoverFlow(a,b):this.loadCollage(a,b)},PhotoAlbum.prototype.loadSlideShow=function(a,b){var c=this,d=new gadgets.Prefs,e=d.getInt("rsW"),f=d.getInt("rsH"),g={url:a+"?imgmax=1600&dummy="+Math.ceil(100*Math.random()),rsW:e,rsH:f,callback:function(d,e){for(var f=!1,g=0;g<c.oldImages.length;g++)if(a==c.oldImages[g].src){c.images[b].width=c.oldImages[g].width,c.images[b].height=c.oldImages[g].height,c.images[b].marginTop=c.oldImages[g].marginTop,c.images[b].marginLeft=c.oldImages[g].marginLeft,f=!0;break}f||(c.images[b].width=d,c.images[b].height=e,c.images[b].marginTop=-(e/2)+"px",c.images[b].marginLeft=-(d/2)+"px"),window.slideShow||(window.slideShow=new SlideShow(c.onLastPhotoShown),window.slideShow.initialize()),c.isLoading&&window.slideShow.addImage(c.images[b]),c.imageCount++,c.onImageLoaded()},onerror:function(){for(var d=0;d<c.oldImages.length;d++)if(a==c.oldImages[d].src){c.images[b].width=c.oldImages[d].width,c.images[b].height=c.oldImages[d].height,c.images[b].marginTop=c.oldImages[d].marginTop,c.images[b].marginLeft=c.oldImages[d].marginLeft;break}c.imageCount++,c.onImageLoaded(),console.log("Error loading image "+a)}};RiseVision.Common.Utility.scaleToFit(g)},PhotoAlbum.prototype.loadCoverFlow=function(a,b){var c=this,d=new gadgets.Prefs,e=d.getInt("rsW"),f=d.getInt("rsH"),g={url:a+"?imgmax=1600&dummy="+Math.ceil(100*Math.random()),rsW:e,rsH:f,callback:function(d,e){for(var f=!1,g=0;g<c.oldImages.length;g++)if(a==c.oldImages[g].src){c.images[b].width=c.oldImages[g].width,c.images[b].height=c.oldImages[g].height,c.images[b].marginTop=c.oldImages[g].marginTop,c.images[b].marginLeft=c.oldImages[g].marginLeft,f=!0;break}f||(c.images[b].width=d,c.images[b].height=e,c.images[b].marginTop=-(e/2)+"px",c.images[b].marginLeft=-(d/2)+"px"),c.imageCount++,c.onImageLoaded()},onerror:function(){for(var d=0;d<c.oldImages.length;d++)if(a==c.oldImages[d].src){c.images[b].width=c.oldImages[d].width,c.images[b].height=c.oldImages[d].height,c.images[b].marginTop=c.oldImages[d].marginTop,c.images[b].marginLeft=c.oldImages[d].marginLeft;break}c.imageCount++,c.onImageLoaded(),console.log("Error loading image "+a)}};RiseVision.Common.Utility.scaleToFit(g)},PhotoAlbum.prototype.loadCollage=function(a,b){var c=this,d=new gadgets.Prefs,e=d.getInt("maxSize"),f={url:a+"?imgmax=1600&dummy="+Math.ceil(100*Math.random()),rsW:e,rsH:e,callback:function(d,e){for(var f=!1,g=0;g<c.oldImages.length;g++)if(a==c.oldImages[g].src){c.images[b].width=c.oldImages[g].width,c.images[b].height=c.oldImages[g].height,f=!0;break}f||(c.images[b].width=d,c.images[b].height=e),window.collage||(window.collage=new Collage(c.onLastPhotoShown),window.collage.initialize()),c.isLoading&&window.collage.addImage(c.images[b]),c.imageCount++,c.onImageLoaded()},onerror:function(){for(var d=0;d<c.oldImages.length;d++)if(a==c.oldImages[d].src){c.images[b].width=c.oldImages[d].width,c.images[b].height=c.oldImages[d].height;break}c.imageCount++,c.onImageLoaded(),console.log("Error loading image "+a)}};RiseVision.Common.Utility.scaleToFit(f)},PhotoAlbum.prototype.onImageLoaded=function(){var a=0,b=this.images.length;if("slideShow"==this.visualOption){if(this.isLoading)(10==this.imageCount||this.imageCount==b&&!this.isStarted)&&(this.isStarted=!0,readyEvent());else if(this.imageCount==b){for(a=0;a<b;a++)window.slideShow.addImage(this.images[a]);window.slideShow.play()}this.imageCount==b&&(this.imageCount=0,this.isStarted=!1,this.isLoading=!1)}else if("coverFlow"==this.visualOption)this.imageCount==b&&(window.coverFlow?window.coverFlow.setPhotos(this.images):window.coverFlow=new CoverFlow(this.images,this.onLastPhotoShown),window.coverFlow.render(this.onRendered,this),this.imageCount=0);else{if(this.isLoading)(10==this.imageCount||this.imageCount==b&&!this.isStarted)&&(this.isStarted=!0,readyEvent());else if(this.imageCount==b){for(a=b-1;a>=0;a--)window.collage.addImage(this.images[a]);window.collage.play()}this.imageCount==b&&(this.imageCount=0,this.isStarted=!1,this.isLoading=!1)}},PhotoAlbum.prototype.onRendered=function(a){a.isLoading?(a.isLoading=!1,readyEvent()):"slideShow"==a.visualOption?window.slideShow.play():"coverFlow"==a.visualOption&&window.coverFlow.play()},PhotoAlbum.prototype.onLastPhotoShown=function(){this.isFeedLoaded=!1,this.isLastPhoto=!0,doneEvent()},PhotoAlbum.prototype.feedLoadFailed=function(){var a,b=this.images.length;if(this.feedLoadFailedCount++,"slideShow"==this.visualOption){if(null!=window.slideShow){for(a=0;a<b;a++)window.slideShow.addImage(this.images[a]);window.slideShow.play()}}else if("coverFlow"==this.visualOption)null!=window.coverFlow&&window.coverFlow.render(this.onRendered,this);else if("collage"==this.visualOption&&null!=window.collage){for(a=b-1;a>=0;a--)window.collage.addImage(this.images[a]);window.collage.play()}},PhotoAlbum.prototype.play=function(){this.isFeedLoaded?"slideShow"==this.visualOption?window.slideShow.play():"coverFlow"==this.visualOption?window.coverFlow.play():window.collage.play():this.loadFeed()},PhotoAlbum.prototype.pause=function(){"slideShow"==this.visualOption?window.slideShow.pause():"coverFlow"==this.visualOption?window.coverFlow.pause():window.collage.pause()};