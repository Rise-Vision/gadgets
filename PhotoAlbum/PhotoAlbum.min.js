function PhotoAlbum(){var e=new gadgets.Prefs;this.url=e.getString("url"),this.visualOption=e.getString("visualOption"),this.maxImages=e.getInt("maxImages"),this.entries=null,this.isLoading=!0,this.isFeedLoaded=!1,this.isLastPhoto=!1,this.isStarted=!1,this.feedLoadFailedTimer=null,this.feedLoadFailedCount=0,this.images=[],this.captions=[],this.imageCount=0}PhotoAlbum.prototype.initialize=function(){var e=this;$.ajaxSetup({cache:!0}),"slideShow"==this.visualOption?($("<link/>",{rel:"stylesheet",type:"text/css",href:"//s3.amazonaws.com/Gadget-Photo-Album/SlideShow/css/SlideShow.css"}).appendTo("head"),$.getScript("//s3.amazonaws.com/Gadget-Photo-Album/SlideShow/js/SlideShow.min.js",function(){e.loadFeed()})):"collage"==this.visualOption?($("<link/>",{rel:"stylesheet",type:"text/css",href:"//s3.amazonaws.com/Gadget-Photo-Album/Collage/css/Collage.css"}).appendTo("head"),$.getScript("//s3.amazonaws.com/Gadget-Photo-Album/Collage/js/Collage.min.js",function(){e.loadFeed()})):"coverFlow"==this.visualOption&&this.loadFeed()},PhotoAlbum.prototype.loadFeed=function(){var e=this,i={};i[gadgets.io.RequestParameters.CONTENT_TYPE]=gadgets.io.ContentType.DOM,i[gadgets.io.RequestParameters.REFRESH_INTERVAL]=60,this.feedLoadFailedTimer=setTimeout(function(){e.feedLoadFailed()},5e3),gadgets.io.makeRequest(this.url,function(i){0==i.errors.length&&(clearTimeout(e.feedLoadFailedTimer),e.onFeedLoaded(i))},i)},PhotoAlbum.prototype.onFeedLoaded=function(e){var i;this.isFeedLoaded=!0;for(var o=e.data.getElementsByTagName("item").length-1;o>=this.maxImages;o--)i=e.data.getElementsByTagName("item")[o],i.parentNode.removeChild(i);e.data&&e.data.getElementsByTagName("item").length>0?(this.entries=e.data.getElementsByTagName("item"),this.loadPhotos()):(console.log("This feed has no items."),readyEvent())},PhotoAlbum.prototype.loadPhotos=function(){var e,i,o,t,a,s;self=this,prefs=new gadgets.Prefs,rsW=prefs.getInt("rsW"),rsH=prefs.getInt("rsH"),supportedTypes=new Array("image/bmp","image/gif","image/jpeg","image/png","image/tiff"),this.oldImages=this.images,this.images=new Array,this.captions=new Array,$.each(this.entries,function(n){if(e=$(this).find("group"),e.length>0){if(i=e.find("content"),i.length>0)for(var l in supportedTypes)if(i.attr("type")==supportedTypes[l]){s={},a=i.attr("url"),self.addCaption(e.find("title").text(),e.find("description").text(),a),s.src=a,s.caption=self.captions[n].caption,self.images.push(s),self.load(s.src,n);break}}else if(i=$(this).find("content"),i.length>0){for(var l in supportedTypes)if(i.attr("type")==supportedTypes[l]){s={},o=$(this).find("title"),t=$(this).find("description"),a=i.attr("url"),o=o.length>1?$(o[1]).text():$(o).text(),t=t.length>1?$(t[1]).text():$(t).text(),self.addCaption(o,t,a),s.src=a,s.caption=self.captions[n].caption,self.images.push(s),self.load(s.src,n);break}}else self.isLoading&&(self.isLoading=!1,readyEvent())})},PhotoAlbum.prototype.addCaption=function(e,i,o,t){var a,s=-1!=this.url.indexOf("//picasaweb.google.com",0)?!0:!1;a=s?null==i||""==i?e:i:null==e||""==e?i:e,t?this.captions.unshift({src:o,caption:a}):this.captions.push({src:o,caption:a})},PhotoAlbum.prototype.load=function(e,i){"slideShow"==this.visualOption?this.loadSlideShow(e,i):"coverFlow"==this.visualOption?this.loadCoverFlow(e,i):this.loadCollage(e,i)},PhotoAlbum.prototype.loadSlideShow=function(e,i){var o=this,t=new gadgets.Prefs,a=t.getInt("rsW"),s=t.getInt("rsH"),n={url:e+"?imgmax=1600&dummy="+Math.ceil(100*Math.random()),rsW:a,rsH:s,callback:function(t,a){for(var s=!1,n=0;n<o.oldImages.length;n++)if(e==o.oldImages[n].src){o.images[i].width=o.oldImages[n].width,o.images[i].height=o.oldImages[n].height,o.images[i].marginTop=o.oldImages[n].marginTop,o.images[i].marginLeft=o.oldImages[n].marginLeft,s=!0;break}s||(o.images[i].width=t,o.images[i].height=a,o.images[i].marginTop=-(a/2)+"px",o.images[i].marginLeft=-(t/2)+"px"),window.slideShow||(window.slideShow=new SlideShow(o.onLastPhotoShown),window.slideShow.initialize()),o.isLoading&&window.slideShow.addImage(o.images[i]),o.imageCount++,o.onImageLoaded()},onerror:function(){for(var t=0;t<o.oldImages.length;t++)if(e==o.oldImages[t].src){o.images[i].width=o.oldImages[t].width,o.images[i].height=o.oldImages[t].height,o.images[i].marginTop=o.oldImages[t].marginTop,o.images[i].marginLeft=o.oldImages[t].marginLeft;break}o.imageCount++,o.onImageLoaded(),console.log("Error loading image "+e)}};RiseVision.Common.Utility.scaleToFit(n)},PhotoAlbum.prototype.loadCoverFlow=function(e,i){var o=this,t=new gadgets.Prefs,a=t.getInt("rsW"),s=t.getInt("rsH"),n={url:e+"?imgmax=1600&dummy="+Math.ceil(100*Math.random()),rsW:a,rsH:s,callback:function(t,a){for(var s=!1,n=0;n<o.oldImages.length;n++)if(e==o.oldImages[n].src){o.images[i].width=o.oldImages[n].width,o.images[i].height=o.oldImages[n].height,o.images[i].marginTop=o.oldImages[n].marginTop,o.images[i].marginLeft=o.oldImages[n].marginLeft,s=!0;break}s||(o.images[i].width=t,o.images[i].height=a,o.images[i].marginTop=-(a/2)+"px",o.images[i].marginLeft=-(t/2)+"px"),o.imageCount++,o.onImageLoaded()},onerror:function(){for(var t=0;t<o.oldImages.length;t++)if(e==o.oldImages[t].src){o.images[i].width=o.oldImages[t].width,o.images[i].height=o.oldImages[t].height,o.images[i].marginTop=o.oldImages[t].marginTop,o.images[i].marginLeft=o.oldImages[t].marginLeft;break}o.imageCount++,o.onImageLoaded(),console.log("Error loading image "+e)}};RiseVision.Common.Utility.scaleToFit(n)},PhotoAlbum.prototype.loadCollage=function(e,i){var o=this,t=new gadgets.Prefs,a=t.getInt("maxSize"),s={url:e+"?imgmax=1600&dummy="+Math.ceil(100*Math.random()),rsW:a,rsH:a,callback:function(t,a){for(var s=!1,n=0;n<o.oldImages.length;n++)if(e==o.oldImages[n].src){o.images[i].width=o.oldImages[n].width,o.images[i].height=o.oldImages[n].height,s=!0;break}s||(o.images[i].width=t,o.images[i].height=a),window.collage||(window.collage=new Collage(o.onLastPhotoShown),window.collage.initialize()),o.isLoading&&window.collage.addImage(o.images[i]),o.imageCount++,o.onImageLoaded()},onerror:function(){for(var t=0;t<o.oldImages.length;t++)if(e==o.oldImages[t].src){o.images[i].width=o.oldImages[t].width,o.images[i].height=o.oldImages[t].height;break}o.imageCount++,o.onImageLoaded(),console.log("Error loading image "+e)}};RiseVision.Common.Utility.scaleToFit(s)},PhotoAlbum.prototype.onImageLoaded=function(){var e=0,i=this.images.length;if("slideShow"==this.visualOption){if(this.isLoading)(10==this.imageCount||this.imageCount==i&&!this.isStarted)&&(this.isStarted=!0,readyEvent());else if(this.imageCount==i){for(e=0;i>e;e++)window.slideShow.addImage(this.images[e]);window.slideShow.play()}this.imageCount==i&&(this.imageCount=0,this.isStarted=!1,this.isLoading=!1)}else if("coverFlow"==this.visualOption)this.imageCount==i&&(window.coverFlow?window.coverFlow.setPhotos(this.images):window.coverFlow=new CoverFlow(this.images,this.onLastPhotoShown),window.coverFlow.render(this.onRendered,this),this.imageCount=0);else{if(this.isLoading)(10==this.imageCount||this.imageCount==i&&!this.isStarted)&&(this.isStarted=!0,readyEvent());else if(this.imageCount==i){for(e=i-1;e>=0;e--)window.collage.addImage(this.images[e]);window.collage.play()}this.imageCount==i&&(this.imageCount=0,this.isStarted=!1,this.isLoading=!1)}},PhotoAlbum.prototype.onRendered=function(e){e.isLoading?(e.isLoading=!1,readyEvent()):"slideShow"==e.visualOption?window.slideShow.play():"coverFlow"==e.visualOption&&window.coverFlow.play()},PhotoAlbum.prototype.onLastPhotoShown=function(){this.isFeedLoaded=!1,this.isLastPhoto=!0,doneEvent()},PhotoAlbum.prototype.feedLoadFailed=function(){var e,i=this.images.length;if(this.feedLoadFailedCount++,"slideShow"==this.visualOption){if(null!=window.slideShow){for(e=0;i>e;e++)window.slideShow.addImage(this.images[e]);window.slideShow.play()}}else if("coverFlow"==this.visualOption)null!=window.coverFlow&&window.coverFlow.render(this.onRendered,this);else if("collage"==this.visualOption&&null!=window.collage){for(e=i-1;e>=0;e--)window.collage.addImage(this.images[e]);window.collage.play()}},PhotoAlbum.prototype.play=function(){this.isFeedLoaded?"slideShow"==this.visualOption?window.slideShow.play():"coverFlow"==this.visualOption?window.coverFlow.play():window.collage.play():this.loadFeed()},PhotoAlbum.prototype.pause=function(){"slideShow"==this.visualOption?window.slideShow.pause():"coverFlow"==this.visualOption?window.coverFlow.pause():window.collage.pause()};