var RiseVision=RiseVision||{};RiseVision.ReutersNews={};RiseVision.ReutersNews.Controller={};
RiseVision.ReutersNews.Controller=function(a){var b="";a="cc12342d-fbcc-4ae7-8c0c-eb0b74bdbf23";this.isFeedLoaded=!1;this.imageCount=this.nextIndex=this.currentIndex=0;this.feedLoadFailedInterval=5E3;this.refreshInterval=6E4;this.images=[];this.layout=prefs.getString("layout");this.itemsCount=prefs.getInt("itemsCount");this.transition=prefs.getString("transition");this.transitionHold=1E3*prefs.getInt("transitionHold");this.transitionResumes=1E3*prefs.getInt("transitionResumes");this.scrollDirection=
prefs.getString("scrollDirection");this.startTimeout=new Date;this.timeLeft=0;this.isLoading=!0;this.isFadingOut=this.isFadingIn=this.isDone=this.isPaused=this.isPlaying=!1;this.util=RiseVision.Common.Utility;this.url="http://content-news.appspot.com/news/data?DisplayId="+a+"&CategoryCodeList=";prefs.getBool("entertainment")&&(b="OLUSENT");prefs.getBool("sports")&&(b+=""==b?"OLUSSPORT":"|OLUSSPORT");prefs.getBool("top")&&(b+=""==b?"OLUSTOPNEWS":"|OLUSTOPNEWS");this.url+=b;"custom"==prefs.getString("layout")?
this.layoutURL=prefs.getString("layoutURL"):this.layoutURL="https://s3.amazonaws.com/Gadget-Reuters-News/layouts/"+prefs.getString("layout");"4x1-no-image-no-headline"==prefs.getString("layout")||"4x1-no-image"==prefs.getString("layout")?this.isMediaLayout=!1:this.isMediaLayout=!0};
RiseVision.ReutersNews.Controller.prototype.getAdditionalParams=function(a,b){if("additionalParams"==a&&b){var d=document.createElement("style");b=JSON.parse(b);d.appendChild(document.createTextNode(b["headline_font-style"]));d.appendChild(document.createTextNode("a:active"+b["headline_font-style"]));d.appendChild(document.createTextNode("a:visited"+b["headline_font-style"]));d.appendChild(document.createTextNode(b["story_font-style"]));d.appendChild(document.createTextNode(b["date_font-style"]));
document.getElementsByTagName("head")[0].appendChild(d);controller.headlinePadding=parseInt(b.headlinePadding);controller.headlineColor=b.headlineColor;controller.storyPadding=parseInt(b.storyPadding);controller.storyColor=b.storyColor;controller.mediaPadding=parseInt(b.mediaPadding);controller.datePadding=parseInt(b.datePadding);controller.dateColor=b.dateColor}controller.initialize()};
RiseVision.ReutersNews.Controller.prototype.initialize=function(){var a=this,b={};this.layoutURL&&(b[gadgets.io.RequestParameters.CONTENT_TYPE]=gadgets.io.ContentType.DOM,gadgets.io.makeRequest(this.layoutURL,function(b){b=b.data;if(0<b.getElementsByTagName("Style").length){var c=document.getElementsByTagName("head")[0],e=document.createElement("style");e.type="text/css";e.innerHTML=b.getElementsByTagName("Style")[0].childNodes[1].nodeValue;c.appendChild(e)}0!=b.getElementsByTagName("Layout").length&&
(a.item=b.getElementsByTagName("Layout")[0].childNodes[1].nodeValue,$.ajax({url:a.url,success:function(b){a.onFeedLoaded(b)},dataType:"xml"}))},b))};RiseVision.ReutersNews.Controller.prototype.loadFeed=function(){var a=this;this.feedLoadFailedTimer=setTimeout(function(){a.feedLoadFailed()},this.feedLoadFailedInterval);$.ajax({url:this.url,success:function(b){a.isFeedLoaded||(clearTimeout(a.feedLoadFailedTimer),a.onFeedLoaded(b))},dataType:"xml"})};
RiseVision.ReutersNews.Controller.prototype.onFeedLoaded=function(a){var b=prefs.getInt("queue"),d,c,e;this.isFeedLoaded=!0;for(var g=0;g<a.getElementsByTagName("Headline").length-1;g++){d=a.getElementsByTagName("Headline")[g];d=this.util.getNodeValue(d.getElementsByTagName("Title"));for(var h=g+1;h<a.getElementsByTagName("Headline").length;h++)e=a.getElementsByTagName("Headline")[h],c=this.util.getNodeValue(e.getElementsByTagName("Title")),d==c&&e.parentNode.removeChild(e)}for(g=a.getElementsByTagName("Headline").length-
1;g>=b;g--)item=a.getElementsByTagName("Headline")[g],item.parentNode.removeChild(item);a&&0<a.getElementsByTagName("Headlines").length?this.showFeed(a):(console.log("No news stories found."),readyEvent())};RiseVision.ReutersNews.Controller.prototype.feedLoadFailed=function(){this.isFeedLoaded=!0;"fade"==this.transition?(this.isFadingOut=this.isFadingIn=!1,this.isPaused||this.showHeadline()):"none"==this.transition&&(this.isPaused||this.showHeadline())};
RiseVision.ReutersNews.Controller.prototype.showFeed=function(a){var b=[];if(this.isHorizontal())if(this.isLoading){this.feedData=a;this.headlines=this.feedData.getElementsByTagName("Headline");$("#hiddenContainer").remove();$("#container").remove();for(a=0;a<this.headlines.length;a++)b.push(this.getHorizontalScrollData(this.headlines[a]));a={width:prefs.getInt("rsW"),height:prefs.getInt("rsH"),scrollBy:this.transition,scrollDirection:this.scrollDirection,speed:prefs.getString("scrollSpeed"),duration:this.transitionHold,
interactivityTimeout:this.transitionResumes};this.horizontalScroll=new RiseVision.Common.HorizontalScroll(a,b);$(this.horizontalScroll).bind({done:function(){doneEvent()}});readyEvent()}else this.oldData=this.feedData,this.feedData=a,this.headlines=this.feedData.getElementsByTagName("Headline"),this.updateHorizontalScrollData();else null!=this.feedData&&(this.oldData=this.feedData),this.feedData=a,this.headlines=this.feedData.getElementsByTagName("Headline"),this.imageURLs=[],this.isMediaLayout&&
this.getMedia(),this.hasImage()&&this.isMediaLayout?this.preloadImages():"fade"==this.transition?(this.isFadingOut=this.isFadingIn=!1,this.isLoading?this.init():this.showHeadline()):"none"==this.transition?this.isLoading?this.init():this.showHeadline():this.isLoading?this.init():this.updateVerticalScrollData()};
RiseVision.ReutersNews.Controller.prototype.init=function(){var a=this;$("#container").width(prefs.getString("rsW"));$("#container").height(prefs.getString("rsH"));"fade"==this.transition||"none"==this.transition?($(".page").bind({touchstart:function(b){clearTimeout(a.showFeedTimer);a.showFeedTimer=setTimeout(function(){a.showNext()},a.transitionResumes)}}),this.addItems(),$(".item").each(function(b){a.nextIndex<a.headlines.length&&(a.populateItem(a.headlines[a.nextIndex],b,a.nextIndex),a.nextIndex++)})):
(this.showAllHeadlines(),$(".item").height(this.getItemHeight()));this.isLoading&&("fade"!=this.transition&&"none"!=this.transition&&$("#container").infiniteScroll({direction:this.scrollDirection,scrollBy:this.transition,duration:this.transitionHold,speed:prefs.getString("scrollSpeed"),swipingTimeout:this.transitionResumes}).bind("onLastItemScrolled",function(a){doneEvent()}),readyEvent())};
RiseVision.ReutersNews.Controller.prototype.addItems=function(){$(".item").remove();for(var a=0;a<this.itemsCount;a++)$(".page").append(this.item);this.applyStyle();$(".item").height(this.getItemHeight())};
RiseVision.ReutersNews.Controller.prototype.applyStyle=function(){$(".headline").css({padding:this.headlinePadding,"background-color":this.headlineColor});$(".story").css({padding:this.storyPadding,"background-color":this.storyColor});$(".image").css({padding:this.mediaPadding});$(".date").css({padding:this.datePadding,"background-color":this.dateColor})};
RiseVision.ReutersNews.Controller.prototype.getMedia=function(){for(var a=this.feedData.getElementsByTagName("Headline").length,b,d,c=0;c<a;c++)b=!1,d=this.util.getNodeValue(this.headlines[c].getElementsByTagName("ImageIncluded")),"1"==d&&(d=this.util.getNodeValue(this.headlines[c].getElementsByTagName("ImageURL")),""!=d&&(this.imageURLs.push(d),b=!0)),b||this.imageURLs.push(null)};
RiseVision.ReutersNews.Controller.prototype.preloadImages=function(){var a=this.imageURLs.length;this.imageCount=0;this.images=[];this.loadImage(a)};RiseVision.ReutersNews.Controller.prototype.loadImage=function(a){var b=this,d;if(null==this.imageURLs[this.imageCount])this.onImageLoaded(null,a);else d=new Image,d.onload=function(){b.onImageLoaded(d,a)},d.onerror=function(){console.log("Unable to load "+this.src);b.onImageLoaded(null,a)},d.src=this.imageURLs[this.imageCount]};
RiseVision.ReutersNews.Controller.prototype.onImageLoaded=function(a,b){this.images.push(a);this.imageCount++;b--;0==b?this.isLoading?this.init():"fade"==this.transition?(this.isFadingOut=this.isFadingIn=!1,this.showHeadline()):"none"==this.transition?this.showHeadline():this.updateVerticalScrollData():this.loadImage(b)};
RiseVision.ReutersNews.Controller.prototype.populateItem=function(a,b,d){var c=this.util.getNodeValue(a.getElementsByTagName("Title")),e=this.util.getNodeValue(a.getElementsByTagName("Summary"));a=this.util.getNodeValue(a.getElementsByTagName("SourceTimeStamp"));""==c?$(".headline").eq(b).hide():($(".headline a").eq(b).html(c),$(".headline").eq(b).show());""!=e?("summary"==prefs.getString("contentType")?$(".story").eq(b).text(this.util.truncate($("<div/>").html(e).text(),120)):$(".story").eq(b).html(e),
$(".story").eq(b).show()):$(".story").eq(b).hide();prefs.getBool("date")&&""!=a?($(".date").eq(b).text((new Date(a)).toString("MMMM dS, yyyy")),$(".date").eq(b).attr("datetime",(new Date(a)).toString("yyyy-MM-dd")),$(".date").eq(b).show()):$(".date").eq(b).hide();this.showSeparator()&&$(".item").css("border-bottom","solid "+prefs.getInt("separatorSize")+"px "+prefs.getString("separatorColor"));null!=this.images[d]&&this.images[d].src?($(".image").eq(b).attr("src",this.images[d].src),$(".image").eq(b).show(),
this.getMediaDimensions(b,this.images[d],$("#container .image").eq(b))):$(".image").eq(b).hide();("fade"!=this.transition&&"none"!=this.transition||this.isLoading)&&$(".item").eq(b).dotdotdot({height:this.getItemHeight()})};
RiseVision.ReutersNews.Controller.prototype.getMediaDimensions=function(a,b,d){var c={},e;$("#hiddenContainer").empty();$("#hiddenContainer").append($(".item").clone());"2x1-headline.xml"==prefs.getString("layout")||"2x1-no-headline.xml"==prefs.getString("layout")?(c.width=0.5*prefs.getString("rsW"),c.height=prefs.getString("rsH")/this.itemsCount-$("#hiddenContainer .textWrapper").eq(a).outerHeight(!0)-2*this.mediaPadding,0==$("#hiddenContainer .story").eq(a).length&&"2x1-headline.xml"==prefs.getString("layout")&&
(c.width=prefs.getString("rsW")-2*this.mediaPadding)):"1x2-headline.xml"==prefs.getString("layout")||"1x2-no-headline.xml"==prefs.getString("layout")?(c.width=prefs.getString("rsW")-2*this.mediaPadding,c.height=(prefs.getString("rsH")/this.itemsCount-2*this.mediaPadding)/2):"4x1-headline.xml"==prefs.getString("layout")||"4x1-no-headline.xml"==prefs.getString("layout")?(c.width=0.33*prefs.getString("rsW"),c.height=prefs.getString("rsH")/this.itemsCount-2*this.mediaPadding):"background.xml"==prefs.getString("layout")&&
(c.width=prefs.getString("rsW")-2*this.mediaPadding,c.height=prefs.getString("rsH")/this.itemsCount-prefs.getInt("separatorSize")-2*this.mediaPadding);$.isEmptyObject(c)||(a=c.width/parseInt(b.width),e=c.height/parseInt(b.height),a=a<e?a:e,c.width=parseInt(parseInt(b.width)*a),c.height=parseInt(parseInt(b.height)*a),null!=d&&(d.width(c.width),d.height(c.height)));$("#hiddenContainer").empty();return c};
RiseVision.ReutersNews.Controller.prototype.getHorizontalScrollData=function(a){var b=[],d=this.util.getNodeValue(a.getElementsByTagName("Title")),c=this.util.getNodeValue(a.getElementsByTagName("Summary"));a=this.util.getNodeValue(a.getElementsByTagName("SourceTimeStamp"));for(var e,g,h,k=0;k<document.styleSheets[2].cssRules.length;k++){var f=document.styleSheets[2].cssRules[k].cssText;-1==f.indexOf("@font-face")&&(-1!=f.indexOf("headline_font-style")&&(e=document.styleSheets[2].cssRules[k].cssText),
-1!=f.indexOf("story_font-style")&&(g=document.styleSheets[2].cssRules[k].cssText),-1!=f.indexOf("date_font-style")&&(h=document.styleSheets[2].cssRules[k].cssText))}""!=d&&b.push({type:"text",value:d,fontRule:e,padding:this.headlinePadding,background:prefs.getString("headlineColor")});prefs.getBool("date")&&""!=a&&b.push({type:"text",value:(new Date(a)).toString("MMMM dS, yyyy"),fontRule:h,padding:this.datePadding,background:prefs.getString("dateColor")});null!=c&&(c="summary"==prefs.getString("contentType")?
this.util.truncate($("<div/>").html(c).text(),120):this.util.unescapeHTML(c),b.push({type:"text",value:c,fontRule:g,padding:this.storyPadding,background:prefs.getString("storyColor")}));return b};
RiseVision.ReutersNews.Controller.prototype.updateHorizontalScrollData=function(){var a=this,b=this.oldData.getElementsByTagName("Headline");null!=b&&null!=this.headlines&&(this.headlines.length!=b.length?$.each(this.headlines,function(b,c){a.updateItem(b,c)}):$.each(this.headlines,function(d,c){var e=b[d],g=!1;a.util.getNodeValue(c.getElementsByTagName("headline"))!=a.util.getNodeValue(e.getElementsByTagName("headline"))&&(g=!0);prefs.getBool("date")&&a.util.getNodeValue(c.getElementsByTagName("SourceTimeStamp"))!=
a.util.getNodeValue(e.getElementsByTagName("SourceTimeStamp"))&&(g=!0);a.util.getNodeValue(c.getElementsByTagName("description"))!=a.util.getNodeValue(e.getElementsByTagName("description"))&&(g=!0);g&&a.updateItem(d,c)}))};RiseVision.ReutersNews.Controller.prototype.updateItem=function(a,b){var d=[],d=this.getHorizontalScrollData(b);this.horizontalScroll.updateItem(a,d)};
RiseVision.ReutersNews.Controller.prototype.showAllHeadlines=function(){for(var a=this.headlines.length,b=0;b<a;b++)$(".page").append(this.item);this.applyStyle();for(b=0;b<a;b++)this.populateItem(this.headlines[b],b,b)};
RiseVision.ReutersNews.Controller.prototype.updateVerticalScrollData=function(){var a=this,b=this.oldData.getElementsByTagName("Headline"),d,c,e,g,h,k;$.each(this.headlines,function(f,m){d=b[f];c=a.util.getNodeValue(d.getElementsByTagName("Id"));e=a.util.getNodeValue(m.getElementsByTagName("Id"));g=a.util.getNodeValue(m.getElementsByTagName("Title"));h=a.util.getNodeValue(m.getElementsByTagName("Summary"));k=a.util.getNodeValue(m.getElementsByTagName("SourceTimeStamp"));if(e!=c){var l=$(".item").eq(f);
l.find(".headline a").text(a.util.unescapeHTML(g));l.find(".headline").show();""!=h?("summary"==prefs.getString("contentType")?l.find(".story").eq(f).text(a.util.truncate($("<div/>").html(h).text(),120)):l.find(".story").eq(f).html(h),l.find(".story").eq(f).show()):l.find(".story").eq(f).hide();prefs.getBool("date")&&""!=k?(l.find(".date").eq(f).text((new Date(k)).toString("MMMM dS, yyyy")),l.find(".date").eq(f).attr("datetime",(new Date(k)).toString("yyyy-MM-dd")),l.find(".date").eq(f).show()):l.find(".date").eq(f).hide();
null!=a.images[f]&&a.images[f].src?($(".image").eq(f).attr("src",a.images[f].src),$(".image").eq(f).show(),a.getMediaDimensions(f,a.images[f],$("#container .image").eq(f))):$(".image").eq(f).hide();l.dotdotdot({height:a.getItemHeight()})}})};
RiseVision.ReutersNews.Controller.prototype.showHeadline=function(){var a=this;this.currentIndex>=this.headlines.length?(this.nextIndex=this.currentIndex=this.timeLeft=0,this.isDone=!0,doneEvent()):this.isLoading?("fade"==this.transition&&(this.transitionHold=1E3*prefs.getInt("transitionHold")-600),this.startTimer()):(this.addItems(),$(".item").each(function(b){a.nextIndex<a.headlines.length?(a.populateItem(a.headlines[a.nextIndex],b,a.nextIndex),$(".item").eq(b).show()):$(".item").eq(b).hide();a.nextIndex++}),
"fade"==this.transition?(this.transitionHold=1E3*prefs.getInt("transitionHold")-1200,this.isFadingIn||this.isFadingOut||(this.isFadingIn=!0,$("#container").css({visibility:"hidden"}),$(".item").dotdotdot({height:this.getItemHeight()}),$("#container").css({visibility:"visible"}),$("#container").fadeTo("slow",1,function(){a.isFadingIn=!1;a.isPaused||a.startTimer()}))):($(".item").dotdotdot({height:this.getItemHeight()}),this.isPaused||this.startTimer()))};
RiseVision.ReutersNews.Controller.prototype.showNext=function(){"fade"==this.transition?this.fadeOut():this.transitionOut()};RiseVision.ReutersNews.Controller.prototype.transitionOut=function(){this.showFeedTimer=null;this.currentIndex=this.nextIndex;this.isPaused||this.showHeadline()};
RiseVision.ReutersNews.Controller.prototype.fadeOut=function(){var a=this;this.isFadingIn||this.isFadingOut||(this.showFeedTimer=null,this.isFadingOut=!0,$("#container").fadeTo("slow",0.01,function(){a.isFadingOut=!1;a.currentIndex=a.nextIndex;a.isPaused||a.showHeadline()}))};RiseVision.ReutersNews.Controller.prototype.startTimer=function(){var a=this;clearTimeout(this.showFeedTimer);this.showFeedTimer=setTimeout(function(){a.showNext()},this.transitionHold);this.isPaused||(this.startTimeout=new Date)};
RiseVision.ReutersNews.Controller.prototype.pauseTimer=function(){var a;this.isPlaying&&(clearTimeout(this.showFeedTimer),$(".item:first").is(":visible")&&(this.timeLeft=this.transitionHold,this.timeLeft-=new Date-this.startTimeout,a=Math.round(this.timeLeft/1E3),this.timeLeft=1E3*a,this.isDone||20<=prefs.getInt("transitionHold")&&10>=a))&&(this.timeLeft=0,this.isDone?this.isFeedLoaded?this.showHeadline():this.loadFeed():this.showNext())};
RiseVision.ReutersNews.Controller.prototype.resumeTimer=function(){var a=this;this.isLoading?(this.timeLeft=this.transitionHold,this.showHeadline()):(this.isDone&&(this.timeLeft=this.transitionHold,this.isDone=!1),clearTimeout(this.showFeedTimer),this.showFeedTimer=setTimeout(function(){a.showNext()},this.timeLeft))};
RiseVision.ReutersNews.Controller.prototype.getItemHeight=function(){return this.showSeparator()?prefs.getInt("rsH")/this.itemsCount-prefs.getInt("separatorSize"):prefs.getInt("rsH")/this.itemsCount};RiseVision.ReutersNews.Controller.prototype.expireUpdatesTimer=function(){this.refresh=!0};RiseVision.ReutersNews.Controller.prototype.isHorizontal=function(){return"fade"!=this.transition&&"none"!=this.transition?"ltr"==this.scrollDirection||"rtl"==this.scrollDirection:!1};
RiseVision.ReutersNews.Controller.prototype.showSeparator=function(){return!prefs.getBool("separator")||"item"!=this.transition&&"continuous"!=this.transition||"up"!=this.scrollDirection&&"down"!=this.scrollDirection?!1:!0};RiseVision.ReutersNews.Controller.prototype.hasImage=function(){if(0<this.imageURLs.length)for(var a=0;a<this.imageURLs.length;a++)if(null!=this.imageURLs[a])return!0;return!1};
RiseVision.ReutersNews.Controller.prototype.play=function(){var a=this;this.isPlaying=!0;"fade"==this.transition||"none"==this.transition?(this.isPaused=!1,this.resumeTimer()):this.isHorizontal()?(this.isLoading&&setTimeout(function(){a.horizontalScroll.initialize();a.horizontalScroll.tick()},1E3),this.isPaused&&(this.horizontalScroll.tick(),this.isPaused=!1)):(this.isPaused=!1,$("#container").infiniteScroll.start());this.isLoading&&(this.isLoading=!1,setInterval(function(){a.isFeedLoaded=!1;"fade"!=
a.transition&&"none"!=a.transition&&a.loadFeed()},this.refreshInterval))};RiseVision.ReutersNews.Controller.prototype.pause=function(){"fade"==this.transition||"none"==this.transition?this.pauseTimer():this.isHorizontal()?this.horizontalScroll.pause():$("#container").infiniteScroll.pause();this.isPaused=!0};