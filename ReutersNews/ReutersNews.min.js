var RiseVision=RiseVision||{};RiseVision.ReutersNews={},RiseVision.ReutersNews.Controller={},RiseVision.ReutersNews.Controller=function(e){var t="";e="cc12342d-fbcc-4ae7-8c0c-eb0b74bdbf23",this.isFeedLoaded=!1,this.currentIndex=0,this.nextIndex=0,this.imageCount=0,this.feedLoadFailedInterval=5e3,this.refreshInterval=6e4,this.images=new Array,this.layout=prefs.getString("layout"),this.itemsCount=prefs.getInt("itemsCount"),this.transition=prefs.getString("transition"),this.transitionHold=1e3*prefs.getInt("transitionHold"),this.transitionResumes=1e3*prefs.getInt("transitionResumes"),this.scrollDirection=prefs.getString("scrollDirection"),this.startTimeout=new Date,this.timeLeft=0,this.isLoading=!0,this.isPlaying=!1,this.isPaused=!1,this.isDone=!1,this.isFadingIn=!1,this.isFadingOut=!1,this.util=RiseVision.Common.Utility,this.url="http://content-news.appspot.com/news/data?DisplayId="+e+"&CategoryCodeList=",prefs.getBool("entertainment")&&(t="OLUSENT"),prefs.getBool("sports")&&(t+=""==t?"OLUSSPORT":"|OLUSSPORT"),prefs.getBool("top")&&(t+=""==t?"OLUSTOPNEWS":"|OLUSTOPNEWS"),this.url+=t,this.layoutURL="custom"==prefs.getString("layout")?prefs.getString("layoutURL"):"https://s3.amazonaws.com/Gadget-Reuters-News/layouts/"+prefs.getString("layout"),this.isMediaLayout="4x1-no-image-no-headline"==prefs.getString("layout")||"4x1-no-image"==prefs.getString("layout")?!1:!0},RiseVision.ReutersNews.Controller.prototype.getAdditionalParams=function(e,t){if("additionalParams"==e&&t){var i=document.createElement("style");t=JSON.parse(t),i.appendChild(document.createTextNode(t["headline_font-style"])),i.appendChild(document.createTextNode("a:active"+t["headline_font-style"])),i.appendChild(document.createTextNode("a:visited"+t["headline_font-style"])),i.appendChild(document.createTextNode(t["story_font-style"])),i.appendChild(document.createTextNode(t["date_font-style"])),document.getElementsByTagName("head")[0].appendChild(i),controller.headlinePadding=parseInt(t.headlinePadding),controller.headlineColor=t.headlineColor,controller.storyPadding=parseInt(t.storyPadding),controller.storyColor=t.storyColor,controller.mediaPadding=parseInt(t.mediaPadding),controller.datePadding=parseInt(t.datePadding),controller.dateColor=t.dateColor}controller.initialize()},RiseVision.ReutersNews.Controller.prototype.initialize=function(){var e=this,t={};this.layoutURL&&(t[gadgets.io.RequestParameters.CONTENT_TYPE]=gadgets.io.ContentType.DOM,gadgets.io.makeRequest(this.layoutURL,function(t){var i=t.data;if(i.getElementsByTagName("Style").length>0){var s=document.getElementsByTagName("head")[0],n=document.createElement("style");n.type="text/css",n.innerHTML=i.getElementsByTagName("Style")[0].childNodes[1].nodeValue,s.appendChild(n)}0!=i.getElementsByTagName("Layout").length&&(e.item=i.getElementsByTagName("Layout")[0].childNodes[1].nodeValue,$.ajax({url:e.url,success:function(t){e.onFeedLoaded(t)},dataType:"xml"}))},t))},RiseVision.ReutersNews.Controller.prototype.loadFeed=function(){var e=this;this.feedLoadFailedTimer=setTimeout(function(){e.feedLoadFailed()},this.feedLoadFailedInterval),$.ajax({url:this.url,success:function(t){e.isFeedLoaded||(clearTimeout(e.feedLoadFailedTimer),e.onFeedLoaded(t))},dataType:"xml"})},RiseVision.ReutersNews.Controller.prototype.onFeedLoaded=function(e){var t,i,s,n,o=prefs.getInt("queue");this.isFeedLoaded=!0;for(var a=0;a<e.getElementsByTagName("Headline").length-1;a++){s=e.getElementsByTagName("Headline")[a],t=this.util.getNodeValue(s.getElementsByTagName("Title"));for(var r=a+1;r<e.getElementsByTagName("Headline").length;r++)n=e.getElementsByTagName("Headline")[r],i=this.util.getNodeValue(n.getElementsByTagName("Title")),t==i&&n.parentNode.removeChild(n)}for(var a=e.getElementsByTagName("Headline").length-1;a>=o;a--)item=e.getElementsByTagName("Headline")[a],item.parentNode.removeChild(item);e&&e.getElementsByTagName("Headlines").length>0?this.showFeed(e):(console.log("No news stories found."),readyEvent())},RiseVision.ReutersNews.Controller.prototype.feedLoadFailed=function(){this.isFeedLoaded=!0,"fade"==this.transition?(this.isFadingIn=!1,this.isFadingOut=!1,this.isPaused||this.showHeadline()):"none"==this.transition&&(this.isPaused||this.showHeadline())},RiseVision.ReutersNews.Controller.prototype.showFeed=function(e){var t=[];if(this.isHorizontal())if(this.isLoading){this.feedData=e,this.headlines=this.feedData.getElementsByTagName("Headline"),$("#hiddenContainer").remove(),$("#container").remove();for(var i=0;i<this.headlines.length;i++)t.push(this.getHorizontalScrollData(this.headlines[i]));var s={width:prefs.getInt("rsW"),height:prefs.getInt("rsH"),scrollBy:this.transition,scrollDirection:this.scrollDirection,speed:prefs.getString("scrollSpeed"),duration:this.transitionHold,interactivityTimeout:this.transitionResumes};this.horizontalScroll=new RiseVision.Common.HorizontalScroll(s,t),$(this.horizontalScroll).bind({done:function(){doneEvent()}}),readyEvent()}else this.oldData=this.feedData,this.feedData=e,this.headlines=this.feedData.getElementsByTagName("Headline"),this.updateHorizontalScrollData();else null!=this.feedData&&(this.oldData=this.feedData),this.feedData=e,this.headlines=this.feedData.getElementsByTagName("Headline"),this.imageURLs=new Array,this.isMediaLayout&&this.getMedia(),this.hasImage()&&this.isMediaLayout?this.preloadImages():"fade"==this.transition?(this.isFadingIn=!1,this.isFadingOut=!1,this.isLoading?this.init():this.showHeadline()):"none"==this.transition?this.isLoading?this.init():this.showHeadline():this.isLoading?this.init():this.updateVerticalScrollData()},RiseVision.ReutersNews.Controller.prototype.init=function(){var e=this;$("#container").width(prefs.getString("rsW")),$("#container").height(prefs.getString("rsH")),"fade"==this.transition||"none"==this.transition?($(".page").bind({touchstart:function(){clearTimeout(e.showFeedTimer),e.showFeedTimer=setTimeout(function(){e.showNext()},e.transitionResumes)}}),this.addItems(),$(".item").each(function(t){e.nextIndex<e.headlines.length&&(e.populateItem(e.headlines[e.nextIndex],t,e.nextIndex),e.nextIndex++)})):(this.showAllHeadlines(),$(".item").height(this.getItemHeight())),this.isLoading&&("fade"!=this.transition&&"none"!=this.transition&&$("#container").infiniteScroll({direction:this.scrollDirection,scrollBy:this.transition,duration:this.transitionHold,speed:prefs.getString("scrollSpeed"),swipingTimeout:this.transitionResumes}).bind("onLastItemScrolled",function(){doneEvent()}),readyEvent())},RiseVision.ReutersNews.Controller.prototype.addItems=function(){$(".item").remove();for(var e=0;e<this.itemsCount;e++)$(".page").append(this.item);this.applyStyle(),$(".item").height(this.getItemHeight())},RiseVision.ReutersNews.Controller.prototype.applyStyle=function(){$(".headline").css({padding:this.headlinePadding,"background-color":this.headlineColor}),$(".story").css({padding:this.storyPadding,"background-color":this.storyColor}),$(".image").css({padding:this.mediaPadding}),$(".date").css({padding:this.datePadding,"background-color":this.dateColor})},RiseVision.ReutersNews.Controller.prototype.getMedia=function(){for(var e,t,i,s=this.feedData.getElementsByTagName("Headline").length,n=0;s>n;n++)e=!1,t=this.util.getNodeValue(this.headlines[n].getElementsByTagName("ImageIncluded")),"1"==t&&(i=this.util.getNodeValue(this.headlines[n].getElementsByTagName("ImageURL")),""!=i&&(this.imageURLs.push(i),e=!0)),e||this.imageURLs.push(null)},RiseVision.ReutersNews.Controller.prototype.preloadImages=function(){var e=this.imageURLs.length;this.imageCount=0,this.images=new Array,this.loadImage(e)},RiseVision.ReutersNews.Controller.prototype.loadImage=function(e){var t,i=this;null==this.imageURLs[this.imageCount]?this.onImageLoaded(null,e):(t=new Image,t.onload=function(){i.onImageLoaded(t,e)},t.onerror=function(){console.log("Unable to load "+this.src),i.onImageLoaded(null,e)},t.src=this.imageURLs[this.imageCount])},RiseVision.ReutersNews.Controller.prototype.onImageLoaded=function(e,t){this.images.push(e),this.imageCount++,t--,0==t?this.isLoading?this.init():"fade"==this.transition?(this.isFadingIn=!1,this.isFadingOut=!1,this.showHeadline()):"none"==this.transition?this.showHeadline():this.updateVerticalScrollData():this.loadImage(t)},RiseVision.ReutersNews.Controller.prototype.populateItem=function(e,t,i){var s=this.util.getNodeValue(e.getElementsByTagName("Title")),n=this.util.getNodeValue(e.getElementsByTagName("Summary")),o=this.util.getNodeValue(e.getElementsByTagName("SourceTimeStamp"));""==s?$(".headline").eq(t).hide():($(".headline a").eq(t).html(s),$(".headline").eq(t).show()),""!=n?("summary"==prefs.getString("contentType")?$(".story").eq(t).text(this.util.truncate($("<div/>").html(n).text(),120)):$(".story").eq(t).html(n),$(".story").eq(t).show()):$(".story").eq(t).hide(),prefs.getBool("date")&&""!=o?($(".date").eq(t).text(new Date(o).toString("MMMM dS, yyyy")),$(".date").eq(t).attr("datetime",new Date(o).toString("yyyy-MM-dd")),$(".date").eq(t).show()):$(".date").eq(t).hide(),this.showSeparator()&&$(".item").css("border-bottom","solid "+prefs.getInt("separatorSize")+"px "+prefs.getString("separatorColor")),null!=this.images[i]&&this.images[i].src?($(".image").eq(t).attr("src",this.images[i].src),$(".image").eq(t).show(),this.getMediaDimensions(t,this.images[i],$("#container .image").eq(t))):$(".image").eq(t).hide(),("fade"!=this.transition&&"none"!=this.transition||this.isLoading)&&$(".item").eq(t).dotdotdot({height:this.getItemHeight()})},RiseVision.ReutersNews.Controller.prototype.getMediaDimensions=function(e,t,i){var s,n,o,a={};return $("#hiddenContainer").empty(),$("#hiddenContainer").append($(".item").clone()),"2x1-headline.xml"==prefs.getString("layout")||"2x1-no-headline.xml"==prefs.getString("layout")?(a.width=.5*prefs.getString("rsW"),a.height=prefs.getString("rsH")/this.itemsCount-$("#hiddenContainer .textWrapper").eq(e).outerHeight(!0)-2*this.mediaPadding,0==$("#hiddenContainer .story").eq(e).length&&"2x1-headline.xml"==prefs.getString("layout")&&(a.width=prefs.getString("rsW")-2*this.mediaPadding)):"1x2-headline.xml"==prefs.getString("layout")||"1x2-no-headline.xml"==prefs.getString("layout")?(a.width=prefs.getString("rsW")-2*this.mediaPadding,a.height=(prefs.getString("rsH")/this.itemsCount-2*this.mediaPadding)/2):"4x1-headline.xml"==prefs.getString("layout")||"4x1-no-headline.xml"==prefs.getString("layout")?(a.width=.33*prefs.getString("rsW"),a.height=prefs.getString("rsH")/this.itemsCount-2*this.mediaPadding):"background.xml"==prefs.getString("layout")&&(a.width=prefs.getString("rsW")-2*this.mediaPadding,a.height=prefs.getString("rsH")/this.itemsCount-prefs.getInt("separatorSize")-2*this.mediaPadding),$.isEmptyObject(a)||(s=a.width/parseInt(t.width),n=a.height/parseInt(t.height),o=n>s?s:n,a.width=parseInt(parseInt(t.width)*o),a.height=parseInt(parseInt(t.height)*o),null!=i&&(i.width(a.width),i.height(a.height))),$("#hiddenContainer").empty(),a},RiseVision.ReutersNews.Controller.prototype.getHorizontalScrollData=function(e){for(var t,i,s,n=[],o=this.util.getNodeValue(e.getElementsByTagName("Title")),a=this.util.getNodeValue(e.getElementsByTagName("Summary")),r=this.util.getNodeValue(e.getElementsByTagName("SourceTimeStamp")),l=0;l<document.styleSheets[2].cssRules.length;l++){var d=document.styleSheets[2].cssRules[l].cssText;-1==d.indexOf("@font-face")&&(-1!=d.indexOf("headline_font-style")&&(t=document.styleSheets[2].cssRules[l].cssText),-1!=d.indexOf("story_font-style")&&(i=document.styleSheets[2].cssRules[l].cssText),-1!=d.indexOf("date_font-style")&&(s=document.styleSheets[2].cssRules[l].cssText))}return""!=o&&n.push({type:"text",value:o,fontRule:t,padding:this.headlinePadding,background:prefs.getString("headlineColor")}),prefs.getBool("date")&&""!=r&&n.push({type:"text",value:new Date(r).toString("MMMM dS, yyyy"),fontRule:s,padding:this.datePadding,background:prefs.getString("dateColor")}),null!=a&&(a="summary"==prefs.getString("contentType")?this.util.truncate($("<div/>").html(a).text(),120):this.util.unescapeHTML(a),n.push({type:"text",value:a,fontRule:i,padding:this.storyPadding,background:prefs.getString("storyColor")})),n},RiseVision.ReutersNews.Controller.prototype.updateHorizontalScrollData=function(){var e=this,t=this.oldData.getElementsByTagName("Headline");null!=t&&null!=this.headlines&&(this.headlines.length!=t.length?$.each(this.headlines,function(t,i){e.updateItem(t,i)}):$.each(this.headlines,function(i,s){var n=t[i],o=!1;e.util.getNodeValue(s.getElementsByTagName("headline"))!=e.util.getNodeValue(n.getElementsByTagName("headline"))&&(o=!0),prefs.getBool("date")&&e.util.getNodeValue(s.getElementsByTagName("SourceTimeStamp"))!=e.util.getNodeValue(n.getElementsByTagName("SourceTimeStamp"))&&(o=!0),e.util.getNodeValue(s.getElementsByTagName("description"))!=e.util.getNodeValue(n.getElementsByTagName("description"))&&(o=!0),o&&e.updateItem(i,s)}))},RiseVision.ReutersNews.Controller.prototype.updateItem=function(e,t){var i=[];i=this.getHorizontalScrollData(t),this.horizontalScroll.updateItem(e,i),i=null},RiseVision.ReutersNews.Controller.prototype.showAllHeadlines=function(){for(var e=this.headlines.length,t=0;e>t;t++)$(".page").append(this.item);this.applyStyle();for(var t=0;e>t;t++)this.populateItem(this.headlines[t],t,t)},RiseVision.ReutersNews.Controller.prototype.updateVerticalScrollData=function(){var e,t,i,s,n,o,a=this,r=!1,l=this.oldData.getElementsByTagName("Headline");$.each(this.headlines,function(d,h){if(e=l[d],t=a.util.getNodeValue(e.getElementsByTagName("Id")),i=a.util.getNodeValue(h.getElementsByTagName("Id")),s=a.util.getNodeValue(h.getElementsByTagName("Title")),n=a.util.getNodeValue(h.getElementsByTagName("Summary")),o=a.util.getNodeValue(h.getElementsByTagName("SourceTimeStamp")),i!=t){var g=$(".item").eq(d);g.find(".headline a").text(a.util.unescapeHTML(s)),g.find(".headline").show(),""!=n?("summary"==prefs.getString("contentType")?g.find(".story").eq(d).text(a.util.truncate($("<div/>").html(n).text(),120)):g.find(".story").eq(d).html(n),g.find(".story").eq(d).show()):g.find(".story").eq(d).hide(),prefs.getBool("date")&&""!=o?(g.find(".date").eq(d).text(new Date(o).toString("MMMM dS, yyyy")),g.find(".date").eq(d).attr("datetime",new Date(o).toString("yyyy-MM-dd")),g.find(".date").eq(d).show()):g.find(".date").eq(d).hide(),null!=a.images[d]&&a.images[d].src?($(".image").eq(d).attr("src",a.images[d].src),$(".image").eq(d).show(),a.getMediaDimensions(d,a.images[d],$("#container .image").eq(d))):$(".image").eq(d).hide(),g.dotdotdot({height:a.getItemHeight()}),r=!0}})},RiseVision.ReutersNews.Controller.prototype.showHeadline=function(){var e=this;this.currentIndex>=this.headlines.length?(this.timeLeft=0,this.currentIndex=0,this.nextIndex=0,this.isDone=!0,doneEvent()):this.isLoading?("fade"==this.transition&&(this.transitionHold=1e3*prefs.getInt("transitionHold")-600),this.startTimer()):(this.addItems(),$(".item").each(function(t){e.nextIndex<e.headlines.length?(e.populateItem(e.headlines[e.nextIndex],t,e.nextIndex),$(".item").eq(t).show()):$(".item").eq(t).hide(),e.nextIndex++}),"fade"==this.transition?(this.transitionHold=1e3*prefs.getInt("transitionHold")-1200,this.isFadingIn||this.isFadingOut||(this.isFadingIn=!0,$("#container").css({visibility:"hidden"}),$(".item").dotdotdot({height:this.getItemHeight()}),$("#container").css({visibility:"visible"}),$("#container").fadeTo("slow",1,function(){e.isFadingIn=!1,e.isPaused||e.startTimer()}))):($(".item").dotdotdot({height:this.getItemHeight()}),this.isPaused||this.startTimer()))},RiseVision.ReutersNews.Controller.prototype.showNext=function(){"fade"==this.transition?this.fadeOut():this.transitionOut()},RiseVision.ReutersNews.Controller.prototype.transitionOut=function(){this.showFeedTimer=null,this.currentIndex=this.nextIndex,this.isPaused||this.showHeadline()},RiseVision.ReutersNews.Controller.prototype.fadeOut=function(){var e=this;this.isFadingIn||this.isFadingOut||(this.showFeedTimer=null,this.isFadingOut=!0,$("#container").fadeTo("slow",.01,function(){e.isFadingOut=!1,e.currentIndex=e.nextIndex,e.isPaused||e.showHeadline()}))},RiseVision.ReutersNews.Controller.prototype.startTimer=function(){var e=this;clearTimeout(this.showFeedTimer),this.showFeedTimer=setTimeout(function(){e.showNext()},this.transitionHold),this.isPaused||(this.startTimeout=new Date)},RiseVision.ReutersNews.Controller.prototype.pauseTimer=function(){var e;this.isPlaying&&(clearTimeout(this.showFeedTimer),$(".item:first").is(":visible")&&(this.timeLeft=this.transitionHold,this.timeLeft-=new Date-this.startTimeout,e=Math.round(this.timeLeft/1e3),this.timeLeft=1e3*e,(this.isDone||prefs.getInt("transitionHold")>=20&&10>=e)&&(this.timeLeft=0,this.isDone?this.isFeedLoaded?this.showHeadline():this.loadFeed():this.showNext())))},RiseVision.ReutersNews.Controller.prototype.resumeTimer=function(){var e=this;return this.isLoading?(this.timeLeft=this.transitionHold,void this.showHeadline()):(this.isDone&&(this.timeLeft=this.transitionHold,this.isDone=!1),clearTimeout(this.showFeedTimer),void(this.showFeedTimer=setTimeout(function(){e.showNext()},this.timeLeft)))},RiseVision.ReutersNews.Controller.prototype.getItemHeight=function(){return this.showSeparator()?prefs.getInt("rsH")/this.itemsCount-prefs.getInt("separatorSize"):prefs.getInt("rsH")/this.itemsCount},RiseVision.ReutersNews.Controller.prototype.expireUpdatesTimer=function(){this.refresh=!0},RiseVision.ReutersNews.Controller.prototype.isHorizontal=function(){return"fade"!=this.transition&&"none"!=this.transition?"ltr"==this.scrollDirection||"rtl"==this.scrollDirection:!1},RiseVision.ReutersNews.Controller.prototype.showSeparator=function(){return!prefs.getBool("separator")||"item"!=this.transition&&"continuous"!=this.transition||"up"!=this.scrollDirection&&"down"!=this.scrollDirection?!1:!0},RiseVision.ReutersNews.Controller.prototype.hasImage=function(){if(this.imageURLs.length>0)for(var e=0;e<this.imageURLs.length;e++)if(null!=this.imageURLs[e])return!0;return!1},RiseVision.ReutersNews.Controller.prototype.play=function(){var e=this;this.isPlaying=!0,"fade"==this.transition||"none"==this.transition?(this.isPaused=!1,this.resumeTimer()):this.isHorizontal()?(this.isLoading&&setTimeout(function(){e.horizontalScroll.initialize(),e.horizontalScroll.tick()},1e3),this.isPaused&&(this.horizontalScroll.tick(),this.isPaused=!1)):(this.isPaused=!1,$("#container").infiniteScroll.start()),this.isLoading&&(this.isLoading=!1,setInterval(function(){e.isFeedLoaded=!1,"fade"!=e.transition&&"none"!=e.transition&&e.loadFeed()},this.refreshInterval))},RiseVision.ReutersNews.Controller.prototype.pause=function(){"fade"==this.transition||"none"==this.transition?this.pauseTimer():this.isHorizontal()?this.horizontalScroll.pause():$("#container").infiniteScroll.pause(),this.isPaused=!0};