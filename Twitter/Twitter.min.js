var RiseVision=RiseVision||{};RiseVision.TwitterList={};RiseVision.Tweet={};
RiseVision.TwitterList=function(){var a=new gadgets.Prefs;this.query=gadgets.util.unescapeString(a.getString("query"));this.tweetTime=5<a.getInt("tweetTime")?1E3*a.getInt("tweetTime"):5E3;this.tweetNumber=5<a.getInt("tweetNumber")?a.getInt("tweetNumber"):5;this.avatarSize=a.getString("avatarSize");this.scrollDirection=a.getString("scrollDirection");this.showSeparator=a.getBool("showSeparator");this.separatorWidth=a.getInt("separatorWidth");this.separatorColor=a.getString("separatorColor");this.width=
a.getString("rsW");this.height=a.getString("rsH");this.sinceId=-1;this.results=[];this.newResults=[];this.scrollCount=0;this.updateInterval=6E4;this.updatesTimerExpired=!1};RiseVision.TwitterList.prototype.getData=function(){gadgets.rpc.call("","rsparam_get",null,prefs.getString("id"),"social:twitter")};
RiseVision.TwitterList.prototype.processData=function(a,b){if(b){var c=JSON.parse(b);twitterList.tokens=JSON.parse(c.access);c.access?twitterList.loadTweets():(twitterList.showError("Please create a Twitter Social Connection for your Company or Display before using this Gadget."),readyEvent())}else twitterList.isLoading=!1,twitterList.showError("Please create a Twitter Social Connection for your Company or Display before using this Gadget."),readyEvent()};
RiseVision.TwitterList.prototype.showError=function(a){var b=this;$("#container").hide();$(".error").text(a).show();setTimeout(function(){b.getData()},this.updateInterval)};
RiseVision.TwitterList.prototype.loadTweets=function(){var a={},b=this,c="";-1!=this.sinceId&&(c="&since_id="+this.sinceId);a[gadgets.io.RequestParameters.CONTENT_TYPE]=gadgets.io.ContentType.JSON;a[gadgets.io.RequestParameters.REFRESH_INTERVAL]=60;a[gadgets.io.RequestParameters.AUTHORIZATION]=gadgets.io.AuthorizationType.OAUTH;a[gadgets.io.RequestParameters.OAUTH_REQUEST_TOKEN]=twitterList.tokens[0];a[gadgets.io.RequestParameters.OAUTH_REQUEST_TOKEN_SECRET]=twitterList.tokens[1];gadgets.io.makeRequest("https://api.twitter.com/1.1/search/tweets.json?q="+
encodeURIComponent(this.query)+"&count="+this.tweetNumber+c,function(a){if(a.error)console.log(a.error);else if(a.data.statuses&&0<a.data.statuses.length){var c=a.data.statuses;b.newResults=[];b.newResults.push.apply(b.newResults,c);b.newResults.sort(function(a,c){b.sort(a,c)});b.sinceId=a.data.search_metadata.max_id_str;b.results.unshift.apply(b.results,c);b.results=b.results.slice(0,b.tweetNumber);b.updatesTimerExpired?(b.scrollCount=b.newResults.length==b.results.length?0:b.newResults.length,b.updatesTimerExpired=
!1):$("#scrollContainer").infiniteScroll({direction:b.scrollDirection,duration:b.tweetTime,cloneItem:function(){b.cloneItem.call(b)}}).bind("onScroll",function(a){b.onScroll.call(b)});0<b.newResults.length&&($(".tweet").length>b.results.length&&("down"==b.scrollDirection?$(".tweet:first").remove():$(".tweet:last").remove()),"down"==b.scrollDirection?$(".tweet").slice(0,b.newResults.length).addClass("delete"):$(".tweet").slice(b.results.length-b.newResults.length).addClass("delete"));b.createTweets()}readyEvent()},
a)};RiseVision.TwitterList.prototype.sort=function(a,b){return(new Date(a.created_at)).getTime()>(new Date(b.created_at)).getTime()?-1:(new Date(a.created_at)).getTime()<(new Date(b.created_at)).getTime()?1:0};RiseVision.TwitterList.prototype.createTweets=function(){for(var a=0;a<this.newResults.length;a++)this.createTweet(this.newResults[a]);for(;$(".page").height()<$(".tweets").height();)"up"==this.scrollDirection?$(".page").append($(".tweet").clone()):$(".page").prepend($(".tweet").clone())};
RiseVision.TwitterList.prototype.createTweet=function(a){var b={};b.id=a.id;b.id_str=a.id_str;b.user=a.user.name;b.userName=a.user.screen_name;b.tweet=a.text;if(a.entities){if(a.entities.user_mentions){b.user_mentions=[];for(var c=0;c<a.entities.user_mentions.length;c++)b.user_mentions.push(a.entities.user_mentions[c])}if(a.entities.hashtags)for(b.hashtags=[],c=0;c<a.entities.hashtags.length;c++)b.hashtags.push(a.entities.hashtags[c]);if(a.entities.urls)for(b.urls=[],c=0;c<a.entities.urls.length;c++)b.urls.push(a.entities.urls[c])}a.retweeted_status&&
a.retweeted_status.user&&(b.retweetName=a.retweeted_status.user.name,b.retweetScreenName=a.retweeted_status.user.screen_name);b.avatar="large"==this.avatarSize?a.user.profile_image_url.replace(/_normal\./,"_bigger."):a.user.profile_image_url;b.createdAt=this.timeAgo(a.created_at);b.metadata=a.metadata;this.tweet=new RiseVision.Tweet(b,{avatarSize:this.avatarSize,showSeparator:this.showSeparator,scrollDirection:this.scrollDirection})};
RiseVision.TwitterList.prototype.cloneItem=function(){"down"==this.scrollDirection?$(".tweet:last").hasClass("delete")?this.scrollCount--:this.createTweet(this.results[this.scrollCount]):$(".tweet:first").hasClass("delete")?this.scrollCount--:this.createTweet(this.results[this.scrollCount])};RiseVision.TwitterList.prototype.onScroll=function(){this.scrollCount++;this.scrollCount==this.results.length&&(this.scrollCount=0,this.updatesTimerExpired&&this.loadTweets())};
RiseVision.TwitterList.prototype.play=function(){var a=this;$("#scrollContainer").infiniteScroll.start&&$("#scrollContainer").infiniteScroll.start();setInterval(function(){a.expireUpdatesTimer()},this.updateInterval)};RiseVision.TwitterList.prototype.pause=function(){$("#scrollContainer").infiniteScroll.pause&&$("#scrollContainer").infiniteScroll.pause()};RiseVision.TwitterList.prototype.expireUpdatesTimer=function(){this.updatesTimerExpired=!0};
RiseVision.TwitterList.prototype.timeAgo=function(a){var b=new Date-new Date(a);return isNaN(b)||0>b?(new Date(a)).toString("d MMM"):6E4>b?Math.floor(b/1E3)+"s":36E5>b?Math.floor(b/6E4)+"m":864E5>b?Math.floor(b/36E5)+"h":(new Date(a)).toString("d MMM")};
RiseVision.Tweet=function(a,b){var c=$("<li class='tweet item'>"),l=$("<div class='avatar'>"),g=$("<img class='profile-image'>"),k=$("<div class='details'>"),h=$("<a class='permalink timestamp_font-style'>"),m=$("<time class='date'>"),n=$("<div class='header'>"),e=$("<a>"),p=$("<span class='fullName tweet_font-style'>"),q=$("<span class='userName tweet_font-style'>"),r=$("<div class='content'>"),s=$("<div class='text tweet_font-style'>"),t=$("<div class='retweet tweet_font-style'>"),x=$("<i class='retweetIcon'>"),
f=$("<a>"),u=[],v=[],w=[],d=0;"large"==b.avatarSize?g.addClass("large"):g.addClass("small");g.attr("src",a.avatar);h.attr("href","http://twitter.com/"+a.userName+"/status/"+a.id_str);h.attr("target","_blank");m.html(a.createdAt);e.attr("href","https://twitter.com/"+a.userName);e.attr("target","_blank");p.html(a.user);q.html("@"+a.userName);for(d=0;d<a.user_mentions.length;d++)u.push("<a class='tweet_font-style' href='https://twitter.com/"+encodeURIComponent(a.user_mentions[d].screen_name)+"' target='blank'>@"+
a.user_mentions[d].screen_name+"</a>");for(d=0;d<a.hashtags.length;d++)v.push("<a class='tweet_font-style' href='https://twitter.com/search?q="+encodeURIComponent("#"+a.hashtags[d].text)+"' target='blank'>"+a.tweet.slice(a.hashtags[d].indices[0],a.hashtags[d].indices[1])+"</a>");for(d=0;d<a.urls.length;d++)w.push("<a class='tweet_font-style' href='"+a.urls[d].url+"' target='blank'>"+a.urls[d].display_url+"</a>");$.each(u,function(b,c){a.tweet=a.tweet.replace("@"+a.user_mentions[b].screen_name,c)});
$.each(v,function(b,c){a.tweet=a.tweet.replace("#"+a.hashtags[b].text,c)});$.each(w,function(b,c){a.tweet=a.tweet.replace(a.urls[b].url,c)});s.html(a.tweet);l.append(e.clone()).find("a").append(g);h.append(m);e.append(p).append(q);n.append(e);r.append(s);k.append(h).append(n).append(r);a.retweetName&&(f.addClass("tweet_font-style"),f.attr("href","https://twitter.com/"+a.retweetScreenName),f.attr("target","_blank"),f.html(a.retweetName),t.append(x).append("Retweeted by ").append(f),k.append(t));c.append(l).append(k);
b.showSeparator&&c.addClass("separator");"up"==b.scrollDirection?$(".page").append(c):$(".page").prepend(c)};