var RiseVision=RiseVision||{};RiseVision.FinancialChart={};RiseVision.FinancialChart.Settings={};RiseVision.FinancialChart.Controller={};RiseVision.FinancialChart.Chart={};RiseVision.FinancialChart.Settings=function(){this.settings=new RiseVision.Common.Settings};
RiseVision.FinancialChart.Settings.prototype.initSettings=function(){var a=this;$(".stockSelector").on("click",function(a){chart.showStockSelector($(this).data("for"))});$(".colorPicker").on("click",function(a){chart.showColorPicker($(this).data("for"))});$(".fontSelector").on("click",function(a){chart.showFontSelector($(this).data("for"))});$("#duration").on("change",function(a){"Day"==$(this).val()?$("li.previousClose").show():$("li.previousClose").hide()});$("#showTitles").on("click",function(a){$(this).is(":checked")?
$("li.title").show():$("li.title").hide()});$("#showVolume").on("click",function(a){$(this).is(":checked")?$("li.volume").show():$("li.volume").hide()});$("#showVolumeTitle").on("click",function(a){$(this).is(":checked")?$("li.volumeTitle").show():$("li.volumeTitle").hide()});$("#showDuration").on("click",function(a){$(this).is(":checked")?$("li.duration").show():$("li.duration").hide()});$("#showComparison").on("click",function(a){$(this).is(":checked")?($("li.comparison").show(),$("li.fill").hide()):
($("li.comparison").hide(),$("li.fill").show())});$("#showAxis").on("click",function(a){$(this).is(":checked")?$("li.axis").show():$("li.axis").hide()});gadgets.rpc.call("","rscmd_getAdditionalParams",function(b){b&&(b=JSON.parse(b),$("#instrument").val(prefs.getString("instrument")),$("#disclaimerFont").val(prefs.getString("disclaimerFont")),$("#disclaimerLoc").val(prefs.getString("disclaimerLoc")),$("#acceptance").attr("checked",prefs.getBool("acceptance")),$("#duration").val(prefs.getString("duration")),
$("#previousCloseColor").val(prefs.getString("previousCloseColor")),$("#showTitles").attr("checked",prefs.getBool("showTitles")),$("#titleDecimals").val(prefs.getString("titleDecimals")),$("#titleSign").val(prefs.getString("titleSign")),$("#showVolume").attr("checked",prefs.getBool("showVolume")),$("#showVolumeTitle").attr("checked",prefs.getBool("showVolumeTitle")),$("#volumeHeight").val(prefs.getInt("volumeHeight")),$("#volumeColor").val(prefs.getString("volumeColor")),$("#barWidth").val(""==prefs.getInt("barWidth")?
2:prefs.getInt("barWidth")),$("#showDuration").attr("checked",prefs.getBool("showDuration")),$("#durButtonColor").val(prefs.getString("durButtonColor")),$("#durSelButtonColor").val(prefs.getString("durSelButtonColor")),$("#durButtonRadius").val(prefs.getString("durButtonRadius")),$("#durRotate").val(prefs.getInt("durRotate")),$("#durReturn").val(prefs.getInt("durReturn")),$("#showComparison").attr("checked",prefs.getBool("showComparison")),$("#compInstruments").val(prefs.getString("compInstruments")),
$("#compNames").val(prefs.getString("compNames")),$("#compLineColor").val(prefs.getString("compLineColor")),$("#compButtonRadius").val(prefs.getString("compButtonRadius")),$("#compButtonColor").val(prefs.getString("compButtonColor")),$("#compSelButtonColor").val(prefs.getString("compSelButtonColor")),$("#compReturn").val(prefs.getInt("compReturn")),$("#showAxis").attr("checked",prefs.getBool("showAxis")),$("#axisDecimals").val(prefs.getString("axisDecimals")),$("#axisLineColor").val(prefs.getString("axisLineColor")),
$("#gridLineColor").val(prefs.getString("gridLineColor")),$("#chartPlotLineColor").val(prefs.getString("chartPlotLineColor")),$("#chartFillColor").val(prefs.getString("chartFillColor")),$("#bgColor").val(prefs.getString("bgColor")),a.populateColor($("#previousCloseColor"),prefs.getString("previousCloseColor")),a.populateColor($("#volumeColor"),prefs.getString("volumeColor")),a.populateColor($("#durButtonColor"),prefs.getString("durButtonColor")),a.populateColor($("#durSelButtonColor"),prefs.getString("durSelButtonColor")),
a.populateColor($("#compLineColor"),prefs.getString("compLineColor")),a.populateColor($("#compButtonColor"),prefs.getString("compButtonColor")),a.populateColor($("#compSelButtonColor"),prefs.getString("compSelButtonColor")),a.populateColor($("#axisLineColor"),prefs.getString("axisLineColor")),a.populateColor($("#gridLineColor"),prefs.getString("gridLineColor")),a.populateColor($("#chartPlotLineColor"),prefs.getString("chartPlotLineColor")),a.populateColor($("#chartFillColor"),prefs.getString("chartFillColor")),
a.populateColor($("#bgColor"),prefs.getString("bgColor")),$("#title_font-style").text(b.title_font),$("#title_font-style").data("css",b["title_font-style"]),$("#volume_font-style").text(b.volume_font),$("#volume_font-style").data("css",b["volume_font-style"]),$("#durButton_font-style").text(b.durButton_font),$("#durButton_font-style").data("css",b["durButton_font-style"]),$("#compButton_font-style").text(b.compButton_font),$("#compButton_font-style").data("css",b["compButton_font-style"]),$("#axis_font-style").text(b.axis_font),
$("#axis_font-style").data("css",b["axis_font-style"]));$("form ol li ol.drillDown li:visible:last").css({clear:"left","float":"left","margin-bottom":"10px"});$("#duration").trigger("change");$("#showTitles").triggerHandler("click");$("#showVolume").triggerHandler("click");$("#showVolumeTitle").triggerHandler("click");$("#showDuration").triggerHandler("click");$("#showComparison").triggerHandler("click");$("#showAxis").triggerHandler("click");$("#settings").show()})};
RiseVision.FinancialChart.Settings.prototype.populateColor=function(a,b){a.val(b);a.css("background-color",b)};RiseVision.FinancialChart.Settings.prototype.showStockSelector=function(a){gadgets.rpc.call("","rscmd_openFinancialSelector",null,a,$("#"+a).val())};RiseVision.FinancialChart.Settings.prototype.showColorPicker=function(a){gadgets.rpc.call("","rscmd_openColorPicker",null,a,$("#"+a).val())};
RiseVision.FinancialChart.Settings.prototype.showFontSelector=function(a){gadgets.rpc.call("","rscmd_openFontSelector",null,a,$("#"+a).data("css"))};RiseVision.FinancialChart.Settings.prototype.setStocks=function(a,b){$("#"+a).val(b)};RiseVision.FinancialChart.Settings.prototype.setColor=function(a,b){$("#"+a).val(b);$("#"+a).css("background-color",b)};RiseVision.FinancialChart.Settings.prototype.setFont=function(a,b,c){$("#"+a).data("css",b);$("#"+a).text(c)};
RiseVision.FinancialChart.Settings.prototype.getSettings=function(){var a=!1,b=document.getElementsByClassName("errors")[0],c="",c=null;$(".errors").empty();a=chart.settings.validateNumeric($("#volumeHeight"),b,"Volume Height")?!0:a;a=chart.settings.validateNumeric($("#barWidth"),b,"Bar Width")?!0:a;a=chart.settings.validateNumeric($("#durButtonRadius"),b,"Duration Button Corner Radius")?!0:a;a=chart.settings.validateNumeric($("#durRotate"),b,"Rotate Every")?!0:a;a=chart.settings.validateNumeric($("#durReturn"),
b,"Return to Default After")?!0:a;a=chart.settings.validateNumeric($("#compButtonRadius"),b,"Comparison Button Corner Radius")?!0:a;a=chart.settings.validateNumeric($("#compReturn"),b,"Chart Returns to Default")?!0:a;a=chart.settings.validateRequired($("#instrument"),b,"Instrument")?!0:a;$("#showComparison").is(":checked")&&(a=chart.settings.validateRequired($("#compInstruments"),b,"Comparative Instruments")?!0:a);if(a)return $(".errors").fadeIn(200).css("display","inline-block"),$("#wrapper").scrollTop(0),
null;c="up_instrument="+escape($("#instrument").val())+"&up_disclaimerFont="+$("#disclaimerFont").val()+"&up_disclaimerLoc="+$("#disclaimerLoc").val();c=$("#acceptance").is(":checked")?c+"&up_acceptance=true":c+"&up_acceptance=false";c+="&up_duration="+$("#duration").val()+"&up_previousCloseColor="+$("#previousCloseColor").val();c=$("#showTitles").is(":checked")?c+"&up_showTitles=true":c+"&up_showTitles=false";c+="&up_titleDecimals="+$("#titleDecimals").val()+"&up_titleSign="+$("#titleSign").val();
c=$("#showVolume").is(":checked")?c+"&up_showVolume=true":c+"&up_showVolume=false";c=$("#showVolumeTitle").is(":checked")?c+"&up_showVolumeTitle=true":c+"&up_showVolumeTitle=false";c+="&up_volumeHeight="+$("#volumeHeight").val()+"&up_volumeColor="+$("#volumeColor").val()+"&up_barWidth="+$("#barWidth").val();c=$("#showDuration").is(":checked")?c+"&up_showDuration=true":c+"&up_showDuration=false";c+="&up_durButtonColor="+$("#durButtonColor").val()+"&up_durSelButtonColor="+$("#durSelButtonColor").val()+
"&up_durButtonRadius="+$("#durButtonRadius").val()+"&up_durRotate="+$("#durRotate").val()+"&up_durReturn="+$("#durReturn").val();c=$("#showComparison").is(":checked")?c+"&up_showComparison=true":c+"&up_showComparison=false";c+="&up_compInstruments="+escape($("#compInstruments").val())+"&up_compNames="+escape($("#compNames").val())+"&up_compLineColor="+$("#compLineColor").val()+"&up_compButtonRadius="+$("#compButtonRadius").val()+"&up_compButtonColor="+$("#compButtonColor").val()+"&up_compSelButtonColor="+
$("#compSelButtonColor").val()+"&up_compReturn="+$("#compReturn").val();c=$("#showAxis").is(":checked")?c+"&up_showAxis=true":c+"&up_showAxis=false";c+="&up_axisDecimals="+$("#axisDecimals").val()+"&up_axisLineColor="+$("#axisLineColor").val()+"&up_gridLineColor="+$("#gridLineColor").val()+"&up_chartPlotLineColor="+$("#chartPlotLineColor").val()+"&up_chartFillColor="+$("#chartFillColor").val()+"&up_bgColor="+$("#bgColor").val();c={params:c,additionalParams:JSON.stringify(chart.saveAdditionalParams())};
$(".errors").css({display:"none"});return c};
RiseVision.FinancialChart.Settings.prototype.saveAdditionalParams=function(){var a={};a.title_font=$("#title_font-style").text();a["title_font-style"]=$("#title_font-style").data("css");a.volume_font=$("#volume_font-style").text();a["volume_font-style"]=$("#volume_font-style").data("css");a.durButton_font=$("#durButton_font-style").text();a["durButton_font-style"]=$("#durButton_font-style").data("css");a.compButton_font=$("#compButton_font-style").text();a["compButton_font-style"]=$("#compButton_font-style").data("css");
a.axis_font=$("#axis_font-style").text();a["axis_font-style"]=$("#axis_font-style").data("css");return a};
RiseVision.FinancialChart.Controller=function(a){this.displayID=a;a=0;var b={displayID:this.displayID,doCompare:this.doCompare(),callback:this.onDataLoaded};this.instrument=$.trim(prefs.getString("instrument")).split(",").slice(0,1)[0];this.isLoading=!0;this.isDrawn=this.notPermissioned=this.isRetrying=this.isRefreshing=this.isReloading=this.isDataLoaded=this.isPlaying=!1;this.numRetries=0;this.retryLimit=3;this.isLabelFirst=this.isSpinnerVisible=!1;this.compareIndex=-1;this.totalReloads=this.numReloads=
this.numCallbacks=0;this.refreshInterval=6E4;this.errorInterval=1E4;this.charts=[];this.compInstruments=[];this.compNames=[];this.compData=[];this.chartData={};this.titleData=null;this.showDuration=prefs.getBool("showDuration");this.duration=prefs.getString("duration");this.durations=[{type:"Day",description:"Day"},{type:"Week",description:"Week"},{type:"1M",description:"Month"},{type:"3M",description:"3 Months"},{type:"6M",description:"6 Months"},{type:"1Y",description:"1 Year"},{type:"5Y",description:"5 Years"}];
this.realTime=new RiseVision.Common.Financial.RealTime(this.displayID,this.instrument);this.arrowURL="//s3.amazonaws.com/risecontentlogos/financial/";this.url="//contentfinancial2.appspot.com/reserve?id="+this.displayID+"&codes="+this.instrument;if(this.showDuration){for(var c=0;c<this.durations.length;c++)b.id=a,b.instrument=this.instrument,b.duration=this.durations[c].type,this.charts.push({primary:new RiseVision.FinancialChart.PrimaryInstrument(b)}),this.createDurationButton(this.durations[c]),
this.durations[c].type==prefs.getString("duration")&&(this.currentIndex=c,this.currentChart=this.charts[this.currentIndex]),a++;$("#durations").show()}else b.id=a,b.instrument=this.instrument,b.duration=prefs.getString("duration"),this.charts.push({primary:new RiseVision.FinancialChart.PrimaryInstrument(b)}),this.currentIndex=0,this.currentChart=this.charts[this.currentIndex],a++;if(prefs.getBool("showComparison")){var b=prefs.getString("compInstruments").split(","),d=[];prefs.getString("compNames")&&
(d=prefs.getString("compNames").split(","));b=b.slice(0,3);d=d.slice(0,3);this.url+="|"+b.join("|");for(c=0;c<b.length;c++)this.compData[c]=new RiseVision.Common.Financial.RealTime(this.displayID,$.trim(b[c]));for(c=0;c<this.charts.length;c++)for(var e=0;e<b.length;e++)0==e&&(this.charts[c].comparative=[]),this.charts[c].comparative.push(new RiseVision.FinancialChart.Instrument({id:a,displayID:this.displayID,instrument:$.trim(b[e]),duration:this.charts[c].primary.getDuration(),name:d[e],callback:this.onDataLoaded})),
a++;this.createInstrumentButtons(b)}switch(prefs.getInt("axisDecimals")){case 1:this.factor=10;break;case 2:this.factor=100;break;case 3:this.factor=1E3;break;case 4:this.factor=1E4;break;default:this.factor=1}this.setTotalCallbacks();this.reserveInstruments();$(document).bind("retry",function(a,b){controller.startRetryTimer(b)})};
RiseVision.FinancialChart.Controller.prototype.reserveInstruments=function(){var a=this;gadgets.io.makeRequest(encodeURI(this.url),function(a){},{});setTimeout(function(){a.reserveInstruments()},864E5)};RiseVision.FinancialChart.Controller.prototype.stopRotation=function(){clearTimeout(this.rotateTimer)};
RiseVision.FinancialChart.Controller.prototype.setInstrument=function(a,b){if(!this.isRefreshing&&((this.resumeRotation=b)||clearTimeout(this.rotateTimer),this.isRetrying&&(clearInterval(this.retryTimer),this.isRetrying=this.isReloading=!1),this.instrument!=a&&(this.instrument=a,!this.isReloading))){clearTimeout(this.refreshTimer);clearTimeout(this.inactivityTimer);this.chartData={};this.isReloading=!0;this.currentIndex=0;this.realTime.setInstruments(a);for(var c=0;c<this.charts.length;c++)this.charts[c].primary.setInstrument(a);
this.setTotalCallbacks();this.load()}};RiseVision.FinancialChart.Controller.prototype.setDuration=function(a){if(!this.isReloading){clearTimeout(this.refreshTimer);clearTimeout(this.inactivityTimer);clearTimeout(this.rotateTimer);this.isReloading=!0;this.duration=a;for(var b=0;b<this.charts.length;b++)if(this.charts[b].primary.setDuration(a),null!=this.charts[b].comparative)for(var c=0;c<this.charts[b].comparative.length;c++)this.charts[b].comparative[c].setDuration(a);this.load()}};
RiseVision.FinancialChart.Controller.prototype.setTotalCallbacks=function(){this.totalCallbacks=1+this.compData.length;for(var a=0;a<this.charts.length;a++)if(this.charts[a].primary.getIsLoading()&&this.totalCallbacks++,null!=this.charts[a].comparative)for(var b=0;b<this.charts[a].comparative.length;b++)this.charts[a].comparative[b].getIsLoading()&&this.totalCallbacks++};
RiseVision.FinancialChart.Controller.prototype.createDurationButton=function(a){var b=this,c=$("<a href='#' class='duration durButton_font-style'>");c.text(a.description);c.data("type",a.type);a.type==prefs.getString("duration")&&c.addClass("selected");c.on("click",function(a){a.preventDefault();b.isLoading||b.isReloading||(clearTimeout(b.inactivityTimer),clearTimeout(b.rotateTimer),b.showChart($(this).data("type")),0<prefs.getInt("durReturn")&&(b.inactivityTimer=setTimeout(function(){b.currentIndex=
b.currentIndex+1>=b.durations.length?0:b.currentIndex+1;b.currentChart=b.charts[b.currentIndex];b.showChart($(".duration").eq(b.currentIndex).data("type"));b.startRotateTimer()},1E3*prefs.getInt("durReturn"))))});$("#durations").append(c)};
RiseVision.FinancialChart.Controller.prototype.createInstrumentButtons=function(a){var b=this;if(this.doCompare()){for(var c=0;c<a.length;c++)$button=$("<a href='#' class='button compButton_font-style'>"),$button.on("click",function(a){var c=$(this).index();a.preventDefault();clearTimeout(b.compReturnTimer);$(".button").removeClass("selected");$(this).addClass("selected");b.compareIndex=c;b.setChartData(!0);b.drawPriceChart();0<prefs.getInt("compReturn")&&(b.compReturnTimer=setTimeout(function(){$(".button").removeClass("selected");
b.compareIndex=-1;b.setChartData(!0);b.drawPriceChart()},1E3*prefs.getInt("compReturn")))}),$("#buttons").append($button);$("#buttons").show()}};
RiseVision.FinancialChart.Controller.prototype.getAdditionalParams=function(a,b){if("additionalParams"==a&&b){var c=document.createElement("style");b=JSON.parse(b);b["title_font-style"]&&c.appendChild(document.createTextNode(b["title_font-style"]));b["volume_font-style"]&&c.appendChild(document.createTextNode(b["volume_font-style"]));b["durButton_font-style"]&&c.appendChild(document.createTextNode(".duration:active, .duration:visited, "+b["durButton_font-style"]));b["compButton_font-style"]&&c.appendChild(document.createTextNode(".button:active, .button:visited, "+
b["compButton_font-style"]));b["axis_font-style"]&&c.appendChild(document.createTextNode(".flotr-grid-label, "+b["axis_font-style"]));document.getElementsByTagName("head")[0].appendChild(c)}controller.load()};
RiseVision.FinancialChart.Controller.prototype.load=function(){this.isDataLoaded=!1;if(this.isLoading)for(var a=0;a<this.charts.length;a++)if(this.charts[a].primary.reset(),null!=this.charts[a].comparative)for(var b=0;b<this.charts[a].comparative.length;b++)this.charts[a].comparative[b].reset();this.loadRealTimeData()};
RiseVision.FinancialChart.Controller.prototype.loadRealTimeData=function(){var a=this;this.realTime.getData("name lastPrice netChange accumulatedVolume tradeTime historicClose percentChange".split(" "),!1,!1,function(b){a.onRealTimeDataLoaded(b)})};
RiseVision.FinancialChart.Controller.prototype.onRealTimeDataLoaded=function(a){var b=this;if(null!=a)if("..."==a.getFormattedValue(0,1))this.numRetries++,this.numRetries==this.retryLimit?($("#priceChart").spinner("remove"),this.isSpinnerVisible=!1,this.numRetries=0,this.onDataLoaded(!1),this.getRemainingData(!1),console.log("Unable to load real-time data for: "+this.instrument+" "+this.duration)):$.event.trigger("retry",function(){b.loadRealTimeData()});else{"N/P"==a.getFormattedValue(0,1)&&(this.notPermissioned=
!0);null!=a&&(this.titleData=a);for(var c=this.numRetries=0,d=this.charts.length;c<d;c++)this.charts[c].primary.setRealTimeData(a);this.updateTitles();this.isLoading&&(this.initUI(),$("#disclaimer, #buttons, #title, #priceChart, #durations, #volumeTitle, #volumeChart").removeClass("hidden"));this.onDataLoaded(!0);this.getRemainingData(!0)}else this.getRemainingData(!1)};
RiseVision.FinancialChart.Controller.prototype.getRemainingData=function(a){if(a){if(this.isLoading||this.isReloading)this.isSpinnerVisible||($("#priceChart").spinner({img:"//preview.risevision.com/images/ajax-loader-circle-notext.gif",width:100,height:100,position:"center"}),this.isSpinnerVisible=!0),this.isLoading&&readyEvent();if(0==this.compData.length)0<this.charts.length&&this.updatePrimaryChart(0,this.onPrimaryDataLoaded);else for(a=this.compDataLoaded=0;a<this.compData.length;a++)this.loadComparativeData(a)}else this.isDataLoaded=
!0,this.isRefreshing=!1,this.startRefreshTimer()};RiseVision.FinancialChart.Controller.prototype.loadComparativeData=function(a){var b=this;this.compData[a].getData(["percentChange","tradeTime","name"],!1,!1,function(c){b.onComparativeDataLoaded(c,a)})};
RiseVision.FinancialChart.Controller.prototype.onComparativeDataLoaded=function(a,b){var c=this,d=!1;if(null!=a)if(null==a.getFormattedValue(0,2))this.numRetries++,this.numRetries==this.retryLimit?($("#priceChart").spinner("remove"),this.isSpinnerVisible=!1,this.numRetries=0,this.onDataLoaded(!1),this.onCompRealTimeDataLoaded(!1),console.log("Unable to load comparative real-time data.")):$.event.trigger("retry",function(){c.loadComparativeData(b)});else{for(var e=this.numRetries=0;e<this.charts.length;e++)if("N/P"==
a.getFormattedValue(0,0)){if(this.isLoading){$("#error").text("One or more of the comparative instruments requires a Premium license. Contact sales@risedisplay.com for licensing options.").show();d=!0;break}}else this.charts[e].comparative[b].setRealTimeData(a);d?(this.isSpinnerVisible&&($("#priceChart").spinner("remove"),this.isSpinnerVisible=!1),$("#buttons, #priceChart, #durations").hide()):(this.onDataLoaded(!0),this.onCompRealTimeDataLoaded(!0))}else this.onDataLoaded(!0),this.onCompRealTimeDataLoaded(!0)};
RiseVision.FinancialChart.Controller.prototype.onCompRealTimeDataLoaded=function(a){this.compDataLoaded++;this.compDataLoaded==this.compData.length&&0<this.charts.length&&this.updatePrimaryChart(0,this.onPrimaryDataLoaded)};RiseVision.FinancialChart.Controller.prototype.onPrimaryDataLoaded=function(){for(var a=1;a<this.charts.length;a++)this.updatePrimaryChart(a,null)};
RiseVision.FinancialChart.Controller.prototype.updatePrimaryChart=function(a,b){var c=this;if(this.charts[a].primary.getIsLoading())this.charts[a].primary.reset(),this.charts[a].primary.loadHistoricalData(function(d){c.onDataLoaded();if(null!=c.charts[a].comparative)if(0==a){var e=0;for(d=0;d<c.charts[a].comparative.length;d++)c.updateComparativeCharts(a,d,function(){e++;e==c.charts[a].comparative.length&&null!=b&&b.call(c)})}else for(d=0;d<c.charts[a].comparative.length;d++)c.updateComparativeCharts(a,
d,null);else null!=b&&b.call(c)});else if(this.charts[a].primary.plotRealTimeData(),null!=c.charts[a].comparative)if(0==a)for(var d=0,e=0;e<c.charts[a].comparative.length;e++)c.updateComparativeCharts(a,e,function(){d++;d==c.charts[a].comparative.length&&null!=b&&b.call(c)});else for(e=0;e<c.charts[a].comparative.length;e++)c.updateComparativeCharts(a,e,null);else null!=b&&b.call(c)};
RiseVision.FinancialChart.Controller.prototype.updateComparativeCharts=function(a,b,c){var d=this;this.charts[a].comparative[b].getIsLoading()?(this.charts[a].comparative[b].reset(),this.charts[a].comparative[b].loadHistoricalData(this.charts[a].primary.getTicks(),function(e){d.isLoading&&($(".button").eq(b).text(d.charts[a].comparative[b].name),$(".button").eq(b).css("display","inline-block"));d.onDataLoaded();null!=c&&c.call(d)})):(this.charts[a].comparative[b].plotRealTimeData(),null!=c&&c.call(d))};
RiseVision.FinancialChart.Controller.prototype.onDataLoaded=function(){this.numCallbacks++;if(this.numCallbacks==this.totalCallbacks){this.isSpinnerVisible&&($("#priceChart").spinner("remove"),this.isSpinnerVisible=!1);this.isDataLoaded=!0;this.charts[0].primary.setIsUpdated(!1);if(null!=this.charts[0].comparative)for(var a=0;a<this.charts[0].comparative.length;a++)this.charts[0].comparative[a].setIsUpdated(!1);this.isLoading?(this.isLoading=!1,this.setChartData(!1),this.isPlaying&&this.drawChart()):
this.isReloading?this.isPlaying&&(this.isDrawn?(this.currentChart=this.charts[this.currentIndex],this.showDuration?this.showChart($(".duration").eq(this.currentIndex).data("type")):this.showChart(this.duration),this.updateTitles(),this.startRefreshTimer(),this.startRotateTimer()):(this.setChartData(!1),this.drawChart())):(this.setChartData(!0),this.refresh(),this.isPlaying&&this.isDrawn&&this.startRotateTimer());this.numCallbacks=0;this.isReloading=!1}};
RiseVision.FinancialChart.Controller.prototype.refresh=function(){this.drawPriceChart();prefs.getBool("showVolume")&&this.drawVolumeChart();this.isRefreshing=!1;this.startRefreshTimer()};
RiseVision.FinancialChart.Controller.prototype.setChartData=function(a){var b,c,d,e=prefs.getBool("showComparison")?!1:!0;if(e)if("transparent"==prefs.getString("chartFillColor")||""==prefs.getString("chartFillColor"))e=!1,b="";else if(b=prefs.getBool("showComparison")?"":prefs.getString("chartFillColor"),d=/rgba\(\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})\s*,\s*([0-9]+(?:\.[0-9]+)?)\s*\)/.exec(b))c=parseFloat(d[4]);a?(a=0<=this.compareIndex?this.currentChart.primary.getPercentChange():
this.currentChart.primary.getY(),this.chartData.price=[],this.chartData.price.push({data:[this.currentChart.primary.getX(),a],color:prefs.getString("chartPlotLineColor"),"lite-lines":{lineWidth:3,fill:e,fillColor:b,fillOpacity:c}}),0<=this.compareIndex?this.chartData.price.push({data:[this.currentChart.comparative[this.compareIndex].getX(),this.currentChart.comparative[this.compareIndex].getY()],color:prefs.getString("compLineColor")}):0<this.currentChart.primary.getHistoricCloseX().length&&0<this.currentChart.primary.getHistoricCloseY().length&&
this.chartData.price.push({data:[this.currentChart.primary.getHistoricCloseX(),this.currentChart.primary.getHistoricCloseY()],color:prefs.getString("previousCloseColor"),"lite-lines":{lineStyle:"dashed"}})):(this.chartData.price=[{data:[this.currentChart.primary.getX(),this.currentChart.primary.getY()],color:prefs.getString("chartPlotLineColor"),"lite-lines":{lineWidth:3,fill:e,fillColor:b,fillOpacity:c}}],0<this.currentChart.primary.getHistoricCloseX().length&&0<this.currentChart.primary.getHistoricCloseY().length&&
this.chartData.price.push({data:[this.currentChart.primary.getHistoricCloseX(),this.currentChart.primary.getHistoricCloseY()],color:prefs.getString("previousCloseColor"),"lite-lines":{lineStyle:"dashed"}}));this.chartData.summaryTicks=this.currentChart.primary.getTicks();this.chartData.volume=[this.currentChart.primary.getVolumeX(),this.currentChart.primary.getVolumeY()]};
RiseVision.FinancialChart.Controller.prototype.updateTitles=function(){var a=parseFloat(this.titleData.getValue(0,2)),b=parseFloat(this.titleData.getValue(0,3)),c=parseFloat(this.titleData.getValue(0,4)),d=prefs.getInt("titleDecimals"),e=prefs.getString("titleSign");$("#instrument").text(this.titleData.getFormattedValue(0,1));$("#last").text("Last "+RiseVision.Common.Utility.addCommas(a.toFixed(d)));"none"==e?($("#last").text("Last "+RiseVision.Common.Utility.addCommas(Math.abs(a).toFixed(d))),$("#changeValue").text(RiseVision.Common.Utility.addCommas(Math.abs(b).toFixed(d)))):
"minus"==e?$("#changeValue").text(RiseVision.Common.Utility.addCommas(b.toFixed(d))):"plusMinus"==e?(0<a&&$("#last").text("Last +"+RiseVision.Common.Utility.addCommas(a.toFixed(d))),0<b?$("#changeValue").text("+"+RiseVision.Common.Utility.addCommas(ge.toFixed(d))):$("#changeValue").text(RiseVision.Common.Utility.addCommas(b.toFixed(d)))):"parentheses"==e?(0>a&&$("#last").text("Last ("+RiseVision.Common.Utility.addCommas(Math.abs(a).toFixed(d))+")"),0>b?$("#changeValue").text("("+RiseVision.Common.Utility.addCommas(Math.abs(b).toFixed(d))+
")"):$("#changeValue").text(RiseVision.Common.Utility.addCommas(b.toFixed(d)))):"arrow"==e&&($("#changeValue").text(RiseVision.Common.Utility.addCommas(Math.abs(b).toFixed(d))),0>b?$("#arrow").css("background-image","url('"+this.arrowURL+"animated-red-arrow.gif')"):$("#arrow").css("background-image","url('"+this.arrowURL+"animated-green-arrow.gif')"));prefs.getBool("showVolumeTitle")&&$("#volumeTitle").text("Accumulated Volume "+RiseVision.Common.Utility.addCommas(c))};
RiseVision.FinancialChart.Controller.prototype.initUI=function(){var a,b;b=prefs.getString("disclaimerLoc");$("#container").width(prefs.getString("rsW"));$("#container").height(prefs.getString("rsH"));"bottomRight"!=b&&"topRight"!=b||$("#disclaimer").addClass("right");$("#disclaimer").css("font-family",prefs.getString("disclaimerFont"));"bottomRight"!=b&&"bottomLeft"!=b||$("#disclaimer").appendTo("#container");$("#disclaimer").show();prefs.getBool("showTitles")||$("#title").hide();a=prefs.getBool("showVolume")?
this.doCompare()?"#priceChart { height: "+($("#container").height()-$("#disclaimer").outerHeight(!0)-$("#buttons").outerHeight(!0)-$("#instrument").outerHeight(!0)-$("#durations").outerHeight(!0)-$("#volumeTitle").outerHeight(!0)-prefs.getInt("volumeHeight")/100*$("#container").height())+"px; }":"#priceChart { height: "+($("#container").height()-$("#disclaimer").outerHeight(!0)-$("#instrument").outerHeight(!0)-$("#durations").outerHeight(!0)-$("#volumeTitle").outerHeight(!0)-prefs.getInt("volumeHeight")/
100*$("#container").height())+"px; }":this.doCompare()?"#priceChart { height: "+($("#container").height()-$("#disclaimer").outerHeight(!0)-$("#buttons").outerHeight(!0)-$("#instrument").outerHeight(!0)-$("#durations").outerHeight(!0)-$("#priceChart").outerHeight(!0))+"px; }":"#priceChart { height: "+($("#container").height()-$("#disclaimer").outerHeight(!0)-$("#instrument").outerHeight(!0)-$("#durations").outerHeight(!0)-$("#priceChart").outerHeight(!0))+"px; }";b=document.createElement("style");
b.appendChild(document.createTextNode(a));document.getElementsByTagName("head")[0].appendChild(b);prefs.getBool("showVolume")?(b=document.createElement("style"),a=".envision-finance-volume .envision-component { height: "+(prefs.getInt("volumeHeight")/100*$("#container").height()-parseInt($("#priceChart").css("margin-bottom"))-2)+"px !important; }",b.appendChild(document.createTextNode(a)),document.getElementsByTagName("head")[0].appendChild(b)):$(".volume").hide();$("#arrow").width($("#instrument").height());
$("#arrow").height($("#instrument").height())};RiseVision.FinancialChart.Controller.prototype.drawChart=function(){prefs.getString("disclaimerLoc");this.drawPriceChart();prefs.getBool("showVolume")&&this.drawVolumeChart();this.startRefreshTimer();this.startRotateTimer()};
RiseVision.FinancialChart.Controller.prototype.drawPriceChart=function(){var a=this,b={container:$("#priceChart"),data:{price:this.chartData.price,volume:this.chartData.volume},defaults:{price:{config:{xaxis:{showLabels:prefs.getBool("showAxis"),ticks:prefs.getBool("showAxis")?this.getTicks():null},yaxis:{showLabels:prefs.getBool("showAxis"),min:this.calculateMin(),max:this.calculateMax(),tickDecimals:prefs.getInt("axisDecimals")},grid:{horizontalLines:!0,verticalLines:!0,backgroundColor:null,tickColor:prefs.getString("gridLineColor")}}}},
yTickFormatter:function(b){b=RiseVision.Common.Utility.addCommas(b);return 0<=a.compareIndex?b+"%":b}};this.isDrawn?($(".envision-finance-price").unbind(),$(".envision-finance-price").remove(),this.finance.vis.destroy(),this.finance.vis=null,this.finance=this.finance.price=null,this.finance=new envision.templates.PriceChart(b)):(this.finance=new envision.templates.PriceChart(b),$(".envision-finance-price").css("border-color",prefs.getString("axisLineColor")),this.isDrawn=!0);$(".envision-finance-price").css("border-color",
prefs.getString("axisLineColor"));this.isLabelFirst&&($(".envision-finance-price .flotr-grid-label-x:first-child").addClass("importantRule"),this.isLabelFirst=!1)};
RiseVision.FinancialChart.Controller.prototype.drawVolumeChart=function(){for(var a=!0,b={container:$("#volumeChart"),data:{price:this.chartData.price,volume:this.chartData.volume},defaults:{volume:{config:{whiskers:{color:prefs.getString("volumeColor"),lineWidth:prefs.getInt("barWidth")},grid:{tickColor:prefs.getString("gridLineColor")}}}},yTickFormatter:function(a){a=parseInt(a);return isNaN(a)?"":0==a?"":a/1E6+"M"}},c=0;c<this.chartData.volume.length;c++)if(0==this.chartData.volume[c].length){a=
!1;break}this.volume&&(this.volume.vis.destroy(),this.volume=null);a&&(this.volume=new envision.templates.VolumeChart(b));$(".envision-finance-volume").css("border-color",prefs.getString("axisLineColor"))};
RiseVision.FinancialChart.Controller.prototype.getTicks=function(){if("Day"==this.duration)return this.getDailyTicks();if("Week"==this.duration)return this.getWeeklyTicks();if("1M"==this.duration||"3M"==this.duration)return this.getMonthlyTicks();if("6M"==this.duration)return this.get6MonthTicks();if("1Y"==this.duration||"5Y"==this.duration)return this.getYearlyTicks()};
RiseVision.FinancialChart.Controller.prototype.getDailyTicks=function(){var a=this.chartData.summaryTicks.length,b=new Date(this.charts[0].primary.collectionStartTime),c=new Date(this.charts[0].primary.collectionEndTime),d,e,f,l=[],k=0;if(null!=this.charts[0].primary.collectionStartTime&&null!=this.charts[0].primary.collectionEndTime)for(;b.isBefore(c);){d=b.getMinutes();if(0==d){0==k&&(this.isLabelFirst=!0);l.push([k,b.toString("HH:mm")]);e=new Date(b.getTime());e=e.addHours(2);for(b.addMinutes(5);b.isBefore(c);){if(Date.equals(b,
e)){for(;k<a;k++)if(d=new Date(this.chartData.summaryTicks[k].date),f=Date.equals((new Date(this.charts[0].primary.collectionStartTime)).clearTime(),Date.today())?new Date(d):new Date(b),f.setHours((new Date(b)).getHours()),f.setMinutes((new Date(b)).getMinutes()),f.setSeconds(0),d.equals(f)){l.push([k,e.toString("HH:mm")]);break}else if(d.isAfter(f)){l.push([k-1,e.toString("HH:mm")]);break}e=e.addHours(2)}b.addMinutes(5)}break}b.addMinutes(5);k++}return l};
RiseVision.FinancialChart.Controller.prototype.getWeeklyTicks=function(){for(var a=this.chartData.summaryTicks.length,b=null,c=null,d=[],e=0;e<a;e++)b=(new Date(this.chartData.summaryTicks[e].date)).clearTime(),c&&b?Date.equals(b,c)||1<=b.getDay()&&5>=b.getDay()&&d.push([e,b.toString("ddd MMM d")]):1<=b.getDay()&&5>=b.getDay()&&d.push([e,b.toString("ddd MMM d")]),c=b;this.isLabelFirst=!0;5<d.length&&d.splice(0,d.length-5);return d};
RiseVision.FinancialChart.Controller.prototype.getMonthlyTicks=function(){for(var a=this.chartData.summaryTicks.length,b=[],c,d=0;d<a;d++)c=new Date(this.chartData.summaryTicks[d].originalDate),5==c.getDay()&&(1>=d&&(this.isLabelFirst=!0),b.push([d,c.toString("MMM d")]));return b};
RiseVision.FinancialChart.Controller.prototype.get6MonthTicks=function(){for(var a=this.chartData.summaryTicks.length,b=[],c,d,e,f=0;f<a;f++)e=new Date(this.chartData.summaryTicks[f].date),0==f?(b.push([f,e.toString("MMM")]),d=e.getMonth()):(c=e.getMonth(),c!=d&&b.push([f,e.toString("MMM")]),d=c);this.isLabelFirst=!0;return b};
RiseVision.FinancialChart.Controller.prototype.getYearlyTicks=function(){for(var a=this.chartData.summaryTicks.length,b=[],c,d,e,f=0;f<a;f++)e=new Date(this.chartData.summaryTicks[f].date),c=e.getMonth(),0==c?c!=d&&(0==f&&(this.isLabelFirst=!0),b.push([f,e.toString("yyyy")])):0==c%3&&c!=d&&(0==f&&(this.isLabelFirst=!0),b.push([f,e.toString("MMM")])),d=c;return b};
RiseVision.FinancialChart.Controller.prototype.calculateMin=function(){var a=this.getInstrumentValues();this.doCompare()||0<this.currentChart.primary.getHistoricCloseY().length&&a.push(parseFloat(this.currentChart.primary.getHistoricCloseY()[0]));return Math.floor(Math.min.apply(null,a)*this.factor)/this.factor};
RiseVision.FinancialChart.Controller.prototype.calculateMax=function(){var a=this.getInstrumentValues();this.doCompare()||0<this.currentChart.primary.getHistoricCloseY().length&&a.push(parseFloat(this.currentChart.primary.getHistoricCloseY()[0]));return Math.ceil(Math.max.apply(null,a)*this.factor)/this.factor};
RiseVision.FinancialChart.Controller.prototype.getInstrumentValues=function(){var a,b,c,d=[];for(a=0;a<this.chartData.price.length;a++)for(c=this.chartData.price[a].data[1].length,b=0;b<c;b++)-1E3!=this.chartData.price[a].data[1][b]&&d.push(parseFloat(this.chartData.price[a].data[1][b]));return d};
RiseVision.FinancialChart.Controller.prototype.showChart=function(a){var b=0;$(".duration").each(function(c){if($(this).data("type")==a)return b=c,!1});this.charts[b].primary.isLoading&&"Day"!=this.charts[b].primary.duration||($(".duration").removeClass("selected"),$(".duration").eq(b).addClass("selected"),this.currentIndex=b,this.currentChart=this.charts[this.currentIndex],this.duration=a,this.setChartData(!0),this.drawPriceChart(),prefs.getBool("showVolume")&&this.drawVolumeChart())};
RiseVision.FinancialChart.Controller.prototype.startRetryTimer=function(a){var b=this;this.isRetrying?this.callbacks.push(a):(this.callbacks=[a],this.isRetrying=!0,this.countdown=this.errorInterval/1E3,this.retryTimer=setInterval(function(){b.countdown--;if(0==b.countdown){b.isRetrying=!1;clearInterval(b.retryTimer);for(var a=0;a<b.callbacks.length;a++)b.callbacks[a]();b.callbacks=[]}},1E3))};
RiseVision.FinancialChart.Controller.prototype.startRotateTimer=function(){for(var a=this,b=!1,c=this.currentIndex;c<this.charts.length;c++)if(!this.charts[c].primary.isLoading){b=!0;break}b?this.showDuration&&0<prefs.getInt("durRotate")&&(clearTimeout(this.rotateTimer),this.rotateTimer=setTimeout(function(){a.onRotateTimerExpired.call(a)},1E3*prefs.getInt("durRotate"))):this.showDuration&&0<prefs.getInt("durRotate")&&(clearTimeout(this.rotateTimer),this.rotateTimer=setTimeout(function(){a.isReloading||
doneEvent()},1E3*prefs.getInt("durRotate")))};RiseVision.FinancialChart.Controller.prototype.onRotateTimerExpired=function(){!this.isReloading&&this.resumeRotation&&(this.currentIndex=this.currentIndex+1>=this.durations.length?0:this.currentIndex+1,this.currentChart=this.charts[this.currentIndex],0==this.currentIndex?doneEvent():(this.showChart($(".duration").eq(this.currentIndex).data("type")),this.startRotateTimer()))};
RiseVision.FinancialChart.Controller.prototype.startRefreshTimer=function(){var a=this;this.notPermissioned||(clearTimeout(this.refreshTimer),this.refreshTimer=setTimeout(function(){a.isRefreshing=!0;a.setTotalCallbacks();a.load()},this.refreshInterval))};RiseVision.FinancialChart.Controller.prototype.doCompare=function(){return prefs.getBool("showComparison")?0<prefs.getString("compInstruments").split(",").length:!1};
RiseVision.FinancialChart.Controller.prototype.play=function(){this.resumeRotation=!0;!this.isDrawn&&!this.isRetrying&&this.isDataLoaded&&0<$("#container:visible").length?this.drawChart():!this.isDrawn||this.isRetrying||this.isReloading||this.startRotateTimer();this.isPlaying=!0};
RiseVision.FinancialChart.Controller.prototype.pause=function(){var a=this;clearTimeout(this.rotateTimer);clearTimeout(this.inactivityTimer);this.isDrawn&&this.showDuration&&0==this.currentIndex&&(clearTimeout(a.pauseTimer),a.pauseTimer=setTimeout(function(){a.showChart($(".duration").eq(a.currentIndex).data("type"))},500));this.isPlaying=!1};RiseVision.FinancialChart.Instrument={};
RiseVision.FinancialChart.Instrument=function(a){new gadgets.Prefs;a&&(this.instrument=a.instrument,this.id=a.id,this.displayID=a.displayID,this.duration=a.duration,this.name=a.name,this.callback=a.callback,this.retryLimit=3,this.historical=new RiseVision.Common.Financial.Historical(a.displayID,a.instrument,a.duration),this.reset(),"Day"==a.duration?this.interval=3E5:"Week"==a.duration&&(this.interval=18E5))};
RiseVision.FinancialChart.Instrument.prototype.reset=function(){this.x=[];this.y=[];this.isLoading=!0;this.numRetries=this.startIndex=0};RiseVision.FinancialChart.Instrument.prototype.getIsLoading=function(){return this.isLoading};RiseVision.FinancialChart.Instrument.prototype.getX=function(){return this.x};RiseVision.FinancialChart.Instrument.prototype.getY=function(){return this.y};RiseVision.FinancialChart.Instrument.prototype.getDuration=function(){return this.duration};
RiseVision.FinancialChart.Instrument.prototype.setInstrument=function(a){this.reset();this.historical.setInstrument(a)};RiseVision.FinancialChart.Instrument.prototype.setRealTimeData=function(a){this.realTimeData=a};RiseVision.FinancialChart.Instrument.prototype.setIsUpdated=function(a){this.historical.setIsUpdated(a)};
RiseVision.FinancialChart.Instrument.prototype.setDuration=function(a){this.reset();this.duration=a;this.historical.setDuration(a);"Day"==a?this.interval=3E5:"Week"==a&&(this.interval=18E5)};RiseVision.FinancialChart.Instrument.prototype.loadHistoricalData=function(a,b){var c=this;this.ticks=a;this.historical.getHistoricalData(["percentChange","tradeTime"],function(a){null!=a?c.save(a,b):b(!0)})};
RiseVision.FinancialChart.Instrument.prototype.save=function(a,b){var c=this,d=a.data.getNumberOfRows(),e=a.collectionData.timeZoneOffset,f=0,l=0,k,m;if(0==d||1==d&&(null==a.data.getFormattedValue(0,1)||""==a.data.getFormattedValue(0,1)))this.numRetries++,this.numRetries==this.retryLimit?(this.numRetries=0,console.log("Unable to load data for: "+this.instrument+" "+this.duration),b(!1)):$.event.trigger("retry",function(){c.loadHistoricalData(c.ticks,b)});else{for(var p=0;p<this.ticks.length;p++)if(f<
d)m=new Date(this.ticks[p].date),k=RiseVision.Common.Utility.adjustTime(new Date(a.data.getFormattedValue(f,1)),e),y=parseFloat(a.data.getValue(f,0)),this.x.push(l),this.y.push(y),this.startIndex++,l++,(Date.equals(k,m)||k.isBefore(m))&&f++;else if("Day"==this.duration||"Week"==this.duration)m=new Date,k.isBefore(m)?(this.x.push(l),this.y.push(y),this.startIndex++,k.addMilliseconds(this.interval)):(this.x.push(l),this.y.push(-1E3)),l++;this.numRetries=0;0<this.ticks.length&&(this.lastTradeTime=new Date(this.ticks[this.startIndex-
1].date));this.plotRealTimeData();b(!0)}};
RiseVision.FinancialChart.Instrument.prototype.plotRealTimeData=function(){var a=this.realTimeData.getFormattedValue(0,7),b,c,d=!1;i=0;if(null!=this.realTimeData)if(this.isLoading)null!=this.realTimeData.getFormattedValue(0,2)&&""!=this.realTimeData.getFormattedValue(0,2)&&null!=this.lastTradeTime&&(b=RiseVision.Common.Utility.adjustTime(new Date(this.realTimeData.getFormattedValue(0,2)),a).clearTime(),"Day"==this.duration||"Week"==this.duration||Date.equals(b,this.lastTradeTime)||(this.x.push(this.startIndex),
this.y.push(parseFloat(this.realTimeData.getValue(0,1))),this.lastTradeTime=RiseVision.Common.Utility.adjustTime(new Date(this.realTimeData.getFormattedValue(0,2)),a))),this.isLoading=!1;else{if(null!=this.realTimeData.getFormattedValue(0,2)&&""!=this.realTimeData.getFormattedValue(0,2)&&null!=this.lastTradeTime)if(b=RiseVision.Common.Utility.adjustTime(new Date(this.realTimeData.getFormattedValue(0,2)),a),tradeDay=b.clone().clearTime(),lastTradeDay=this.lastTradeTime.clone().clearTime(),Date.equals(tradeDay,
lastTradeDay))if("Day"==this.duration||"Week"==this.duration){for(i=0;i<this.ticks.length;i++)if(c=new Date(this.ticks[i].date),c.isAfter(b)||Date.equals(c,b)){d=!0;break}if(d)for(;(c.isAfter(b)||Date.equals(c,b))&&c.isBefore(new Date);)if(i<this.y.length)this.y[i]=parseFloat(this.realTimeData.getValue(0,1)),this.lastTradeTime=b,c.addMilliseconds(this.interval),i++;else break}else this.y[this.startIndex-1]=parseFloat(this.realTimeData.getValue(0,1)),this.lastTradeTime=b;else this.isLoading=!0}else this.isLoading=
!1;null==this.name&&(this.name=this.realTimeData.getFormattedValue(0,3))};RiseVision.FinancialChart.PrimaryInstrument={};RiseVision.FinancialChart.PrimaryInstrument.prototype=new RiseVision.FinancialChart.Instrument;RiseVision.FinancialChart.PrimaryInstrument.prototype.constructor=RiseVision.FinancialChart.PrimaryInstrument;
RiseVision.FinancialChart.PrimaryInstrument=function(a){this.doCompare=a.doCompare;this.reset();RiseVision.FinancialChart.Instrument.call(this,{id:a.id,displayID:a.displayID,instrument:a.instrument,duration:a.duration,callback:a.callback})};RiseVision.FinancialChart.PrimaryInstrument.prototype.reset=function(){this.ticks=[];this.volumeX=[];this.volumeY=[];this.accumulatedVolume=0;this.historicCloseX=[];this.historicCloseY=[];this.doCompare&&(this.percentChange=[]);RiseVision.FinancialChart.Instrument.prototype.reset.call(this)};
RiseVision.FinancialChart.PrimaryInstrument.prototype.getIsLoading=function(){return RiseVision.FinancialChart.Instrument.prototype.getIsLoading.call(this)};RiseVision.FinancialChart.PrimaryInstrument.prototype.getX=function(){return RiseVision.FinancialChart.Instrument.prototype.getX.call(this)};RiseVision.FinancialChart.PrimaryInstrument.prototype.getY=function(){return RiseVision.FinancialChart.Instrument.prototype.getY.call(this)};
RiseVision.FinancialChart.PrimaryInstrument.prototype.getPercentChange=function(){return this.percentChange};RiseVision.FinancialChart.PrimaryInstrument.prototype.getTicks=function(){return this.ticks};RiseVision.FinancialChart.PrimaryInstrument.prototype.getVolumeX=function(){return this.volumeX};RiseVision.FinancialChart.PrimaryInstrument.prototype.getVolumeY=function(){return this.volumeY};RiseVision.FinancialChart.PrimaryInstrument.prototype.getHistoricCloseX=function(){return this.historicCloseX};
RiseVision.FinancialChart.PrimaryInstrument.prototype.getHistoricCloseY=function(){return this.historicCloseY};RiseVision.FinancialChart.PrimaryInstrument.prototype.getDuration=function(){return RiseVision.FinancialChart.Instrument.prototype.getDuration.call(this)};RiseVision.FinancialChart.PrimaryInstrument.prototype.setInstrument=function(a){this.reset();RiseVision.FinancialChart.Instrument.prototype.setInstrument.call(this,a)};
RiseVision.FinancialChart.PrimaryInstrument.prototype.setDuration=function(a){this.reset();RiseVision.FinancialChart.Instrument.prototype.setDuration.call(this,a)};RiseVision.FinancialChart.PrimaryInstrument.prototype.setRealTimeData=function(a){RiseVision.FinancialChart.Instrument.prototype.setRealTimeData.call(this,a)};RiseVision.FinancialChart.PrimaryInstrument.prototype.setIsUpdated=function(a){RiseVision.FinancialChart.Instrument.prototype.setIsUpdated.call(this,a)};
RiseVision.FinancialChart.PrimaryInstrument.prototype.loadHistoricalData=function(a){var b=this,c=null,c=this.doCompare?["closePrice","accumulatedVolume","tradeTime","percentChange"]:["closePrice","accumulatedVolume","tradeTime"];this.historical.getHistoricalData(c,function(c){null!=c?b.save(c,a):a(!0)},{})};
RiseVision.FinancialChart.PrimaryInstrument.prototype.save=function(a,b){var c=this,d=0,e=0,f=0,l=0,k=0,m=0,p=null,q="",g,n,d=a.data.getNumberOfRows();if(0==d||1==d&&"0"==a.data.getFormattedValue(0,0))this.numRetries++,this.numRetries==this.retryLimit?(this.numRetries=0,console.log("Unable to load data for: "+this.instrument+" "+this.duration),b(!1)):$.event.trigger("retry",function(){c.loadHistoricalData(b)});else{0<this.x.length&&this.reset();n=a.collectionData.endTime.clone();q=a.collectionData.timeZoneOffset;
this.collectionStartTime=a.collectionData.startTime;this.collectionEndTime=a.collectionData.endTime;for(var h=0;h<d;h++)if("Day"==this.duration||"Week"==this.duration){p=RiseVision.Common.Utility.adjustTime(new Date(a.data.getFormattedValue(h,2)),q);0==h&&(g=new Date(p),g.setHours(this.collectionStartTime.getHours()),g.setMinutes(this.collectionStartTime.getMinutes()),"Day"==this.duration&&this.collectionStartTime.clone().clearTime().isBefore(g.clone().clearTime())&&g.add({days:-1}),lastTradeDay=
g.clone().clearTime(),n.setFullYear(g.getFullYear()),n.setMonth(g.getMonth()),n.setDate(g.getDate()),Date.equals(a.collectionData.startTime.clone().clearTime(),a.collectionData.endTime.clone().clearTime())||n.addDays(1),this.doCompare?(f=parseFloat(a.data.getValue(h,0)),l=parseFloat(a.data.getValue(h,3))):f=parseFloat(a.data.getValue(h,0)),k=parseFloat(a.data.getValue(h,1)));for(;p.isAfter(g)&&(g.isBefore(n)||Date.equals(g,n));)m=this.addDataPoint({plotTime:g,tradeTime:p,lastTradeTime:g,endTime:n,
collectionStartTime:a.collectionData.startTime.clone().clearTime(),collectionEndTime:a.collectionData.endTime.clone().clearTime(),closePrice:f,volume:k,percentChange:l,index:m});g.isAfter(n)&&(g=new Date(p),g.setHours(this.collectionStartTime.getHours()),g.setMinutes(this.collectionStartTime.getMinutes()),lastTradeDay=g.clone().clearTime(),n.setFullYear(g.getFullYear()),n.setMonth(g.getMonth()),n.setDate(g.getDate()));this.doCompare?(e=parseFloat(a.data.getValue(h,0)),l=parseFloat(a.data.getValue(h,
3))):e=parseFloat(a.data.getValue(h,0));m=this.addDataPoint({plotTime:g,tradeTime:p,lastTradeTime:g,endTime:n,collectionStartTime:a.collectionData.startTime.clone().clearTime(),collectionEndTime:a.collectionData.endTime.clone().clearTime(),closePrice:e,volume:parseFloat(a.data.getValue(h,1)),percentChange:l,index:m});f=e;k=parseFloat(a.data.getValue(h,1))}else this.doCompare?(e=parseFloat(a.data.getValue(h,0)),this.percentChange.push(parseFloat(a.data.getValue(h,3)))):e=parseFloat(a.data.getValue(h,
0)),this.ticks.push({date:RiseVision.Common.Utility.adjustTime(new Date(a.data.getFormattedValue(h,2)),q).getTime(),originalDate:(new Date(a.data.getFormattedValue(h,2))).getTime(),close:e,volume:parseInt(a.data.getFormattedValue(h,1))}),this.x.push(h),this.volumeX.push(h),this.y.push(parseFloat(a.data.getValue(h,0))),this.volumeY.push(parseFloat(a.data.getValue(h,1)));if("Day"==this.duration||"Week"==this.duration){d=new Date;if(d.clone().clearTime().isAfter(g.clone().clearTime())||Date.equals(d.clone().clearTime(),
g.clone().clearTime()))for(;g.isBefore(n)&&g.isBefore(d);)this.ticks.push({date:g.getTime(),close:f,volume:k}),this.x.push(m),this.volumeX.push(m),this.y.push(f),this.volumeY.push(k),this.doCompare&&this.percentChange.push(l),g.addMilliseconds(this.interval),m++;else for(;g.isBefore(d);)this.ticks.push({date:g.getTime(),close:f,volume:k}),this.x.push(m),this.volumeX.push(m),this.y.push(f),this.volumeY.push(k),this.doCompare&&this.percentChange.push(l),g.addMilliseconds(this.interval),m++;this.startIndex=
m}else this.startIndex=d;"Day"==this.duration&&this.addExtraTicks(a.collectionData,new Date(this.ticks[this.ticks.length-1].date));this.numRetries=0;this.lastTradeTime=new Date(this.ticks[this.startIndex-1].date);this.plotRealTimeData();b(!0)}};
RiseVision.FinancialChart.PrimaryInstrument.prototype.addDataPoint=function(a){var b,c;this.ticks.push({date:a.plotTime.getTime(),close:a.closePrice,volume:a.volume});this.x.push(a.index);this.volumeX.push(a.index);this.y.push(a.closePrice);this.volumeY.push(a.volume);this.doCompare&&this.percentChange.push(a.percentChange);c=a.lastTradeTime.clone().clearTime();a.lastTradeTime.addMilliseconds(this.interval);b=a.lastTradeTime.clone().clearTime();Date.equals(c,b)||Date.equals(c,a.tradeTime.clone().clearTime())||
(a.lastTradeTime.setFullYear(a.tradeTime.getFullYear()),a.lastTradeTime.setMonth(a.tradeTime.getMonth()),a.lastTradeTime.setDate(a.tradeTime.getDate()));a.endTime.setFullYear(a.lastTradeTime.getFullYear());a.endTime.setMonth(a.lastTradeTime.getMonth());a.endTime.setDate(a.lastTradeTime.getDate());Date.equals(a.collectionStartTime,a.collectionEndTime)||a.endTime.addDays(1);return a.index+1};
RiseVision.FinancialChart.PrimaryInstrument.prototype.plotRealTimeData=function(){var a,b,c,d,e,f=this.realTimeData.getFormattedValue(0,11),l=!1;c=0;if(null!=this.realTimeData){e=parseFloat(this.realTimeData.getValue(0,2));if(this.isLoading){if(null!=this.realTimeData.getFormattedValue(0,5)&&""!=this.realTimeData.getFormattedValue(0,5)&&null!=this.lastTradeTime){a=RiseVision.Common.Utility.adjustTime(new Date(this.realTimeData.getFormattedValue(0,5)),f).clearTime();if("Day"==this.duration)for(c=0;c<
this.x.length;c++)this.historicCloseX.push(c),this.historicCloseY.push(parseFloat(this.realTimeData.getValue(0,6)));"Day"==this.duration||"Week"==this.duration||Date.equals(a,this.lastTradeTime)||(this.ticks.push({date:RiseVision.Common.Utility.adjustTime(new Date(this.realTimeData.getFormattedValue(0,5)),f).getTime(),close:e,volume:parseInt(this.realTimeData.getFormattedValue(0,4))}),this.x.push(this.startIndex),this.volumeX.push(this.startIndex),this.y.push(e),this.volumeY.push(parseFloat(this.realTimeData.getValue(0,
4))),this.doCompare&&this.percentChange.push(parseFloat(this.realTimeData.getValue(0,7))),this.startIndex++)}this.isLoading=!1;this.lastTradeTime=RiseVision.Common.Utility.adjustTime(new Date(this.realTimeData.getFormattedValue(0,5)),f)}else if(null!=this.realTimeData.getFormattedValue(0,5)&&""!=this.realTimeData.getFormattedValue(0,5)&&null!=this.lastTradeTime)if(a=RiseVision.Common.Utility.adjustTime(new Date(this.realTimeData.getFormattedValue(0,5)),f),c=a.clone().clearTime(),d=this.lastTradeTime.clone().clearTime(),
Date.equals(c,d))if("Day"==this.duration||"Week"==this.duration){for(c=0;c<this.ticks.length;c++)if(b=new Date(this.ticks[c].date),b.isAfter(a)||Date.equals(b,a)){l=!0;break}if(l)for(Date.equals(a,this.lastTradeTime)||(this.volume=parseFloat(this.realTimeData.getValue(0,4))-this.accumulatedVolume);(b.isAfter(a)||Date.equals(b,a))&&b.isBefore(new Date);)"Day"==this.duration?c<this.ticks.length&&(this.ticks[c].close=e,this.ticks[c].volume=this.volume,this.y[c]=e,this.volumeY[c]=this.volume,this.doCompare&&
(this.percentChange[c]=parseFloat(this.realTimeData.getValue(0,7)))):(this.ticks.push({date:RiseVision.Common.Utility.adjustTime(new Date(this.realTimeData.getFormattedValue(0,5)),f).getTime(),close:e,volume:parseFloat(this.realTimeData.getValue(0,4))-this.accumulatedVolume}),this.x.push(c),this.volumeX.push(c),this.y.push(e),this.volumeY.push(parseFloat(this.realTimeData.getValue(0,4))-this.accumulatedVolume),this.doCompare&&this.percentChange.push(parseFloat(this.realTimeData.getValue(0,7)))),this.lastTradeTime=
a,b.addMilliseconds(this.interval),c++}else this.ticks[this.startIndex-1].date=(new Date(this.realTimeData.getFormattedValue(0,5))).getTime(),this.ticks[this.startIndex-1].close=e,this.ticks[this.startIndex-1].volume=parseFloat(this.realTimeData.getValue(0,4))-this.accumulatedVolume,this.y[this.startIndex-1]=e,this.volumeY[this.startIndex-1]=parseFloat(this.realTimeData.getValue(0,4))-this.accumulatedVolume,this.doCompare&&(this.percentChange[this.startIndex-1]=parseFloat(this.realTimeData.getValue(0,
7))),this.lastTradeTime=a;else this.isLoading=!0;this.accumulatedVolume=parseFloat(this.realTimeData.getValue(0,4))}else this.isLoading=!1};RiseVision.FinancialChart.PrimaryInstrument.prototype.getNumDayIntervals=function(a,b,c){a=a.getTime();b=b.getTime();return Math.round((b-a)/c)};
RiseVision.FinancialChart.PrimaryInstrument.prototype.addExtraTicks=function(a,b){for(var c=0,d=new Date(b),e=new Date(a.endTime),c=this.getNumDayIntervals(a.startTime,a.endTime,this.interval),f=this.startIndex;f<c;f++)if(b.add({milliseconds:this.interval}),d=new Date(b),d.isBefore(e))this.ticks.push({date:b.getTime(),close:0,volume:0}),this.x.push(f),this.volumeX.push(f),this.y.push(-1E3),this.volumeY.push(""),null!=this.percentChange&&this.percentChange.push(-1E3);else break};