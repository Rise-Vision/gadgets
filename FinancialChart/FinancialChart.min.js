var RiseVision=RiseVision||{};RiseVision.FinancialChart={},RiseVision.FinancialChart.Settings={},RiseVision.FinancialChart.Controller={},RiseVision.FinancialChart.Chart={},RiseVision.FinancialChart.Settings=function(){this.settings=new RiseVision.Common.Settings},RiseVision.FinancialChart.Settings.prototype.initSettings=function(){var t=this;$(".stockSelector").on("click",function(){chart.showStockSelector($(this).data("for"))}),$(".colorPicker").on("click",function(){chart.showColorPicker($(this).data("for"))}),$(".fontSelector").on("click",function(){chart.showFontSelector($(this).data("for"))}),$("#duration").on("change",function(){"Day"==$(this).val()?$("li.previousClose").show():$("li.previousClose").hide()}),$("#showTitles").on("click",function(){$(this).is(":checked")?$("li.title").show():$("li.title").hide()}),$("#showVolume").on("click",function(){$(this).is(":checked")?$("li.volume").show():$("li.volume").hide()}),$("#showVolumeTitle").on("click",function(){$(this).is(":checked")?$("li.volumeTitle").show():$("li.volumeTitle").hide()}),$("#showDuration").on("click",function(){$(this).is(":checked")?$("li.duration").show():$("li.duration").hide()}),$("#showComparison").on("click",function(){$(this).is(":checked")?($("li.comparison").show(),$("li.fill").hide()):($("li.comparison").hide(),$("li.fill").show())}),$("#showAxis").on("click",function(){$(this).is(":checked")?$("li.axis").show():$("li.axis").hide()}),gadgets.rpc.call("","rscmd_getAdditionalParams",function(e){e&&(e=JSON.parse(e),$("#instrument").val(prefs.getString("instrument")),$("#disclaimerFont").val(prefs.getString("disclaimerFont")),$("#disclaimerLoc").val(prefs.getString("disclaimerLoc")),$("#acceptance").attr("checked",prefs.getBool("acceptance")),$("#duration").val(prefs.getString("duration")),$("#previousCloseColor").val(prefs.getString("previousCloseColor")),$("#showTitles").attr("checked",prefs.getBool("showTitles")),$("#titleDecimals").val(prefs.getString("titleDecimals")),$("#titleSign").val(prefs.getString("titleSign")),$("#showVolume").attr("checked",prefs.getBool("showVolume")),$("#showVolumeTitle").attr("checked",prefs.getBool("showVolumeTitle")),$("#volumeHeight").val(prefs.getInt("volumeHeight")),$("#volumeColor").val(prefs.getString("volumeColor")),$("#barWidth").val(""==prefs.getInt("barWidth")?2:prefs.getInt("barWidth")),$("#showDuration").attr("checked",prefs.getBool("showDuration")),$("#durButtonColor").val(prefs.getString("durButtonColor")),$("#durSelButtonColor").val(prefs.getString("durSelButtonColor")),$("#durButtonRadius").val(prefs.getString("durButtonRadius")),$("#durRotate").val(prefs.getInt("durRotate")),$("#durReturn").val(prefs.getInt("durReturn")),$("#showComparison").attr("checked",prefs.getBool("showComparison")),$("#compInstruments").val(prefs.getString("compInstruments")),$("#compNames").val(prefs.getString("compNames")),$("#compLineColor").val(prefs.getString("compLineColor")),$("#compButtonRadius").val(prefs.getString("compButtonRadius")),$("#compButtonColor").val(prefs.getString("compButtonColor")),$("#compSelButtonColor").val(prefs.getString("compSelButtonColor")),$("#compReturn").val(prefs.getInt("compReturn")),$("#showAxis").attr("checked",prefs.getBool("showAxis")),$("#axisDecimals").val(prefs.getString("axisDecimals")),$("#axisLineColor").val(prefs.getString("axisLineColor")),$("#gridLineColor").val(prefs.getString("gridLineColor")),$("#chartPlotLineColor").val(prefs.getString("chartPlotLineColor")),$("#chartFillColor").val(prefs.getString("chartFillColor")),$("#bgColor").val(prefs.getString("bgColor")),t.populateColor($("#previousCloseColor"),prefs.getString("previousCloseColor")),t.populateColor($("#volumeColor"),prefs.getString("volumeColor")),t.populateColor($("#durButtonColor"),prefs.getString("durButtonColor")),t.populateColor($("#durSelButtonColor"),prefs.getString("durSelButtonColor")),t.populateColor($("#compLineColor"),prefs.getString("compLineColor")),t.populateColor($("#compButtonColor"),prefs.getString("compButtonColor")),t.populateColor($("#compSelButtonColor"),prefs.getString("compSelButtonColor")),t.populateColor($("#axisLineColor"),prefs.getString("axisLineColor")),t.populateColor($("#gridLineColor"),prefs.getString("gridLineColor")),t.populateColor($("#chartPlotLineColor"),prefs.getString("chartPlotLineColor")),t.populateColor($("#chartFillColor"),prefs.getString("chartFillColor")),t.populateColor($("#bgColor"),prefs.getString("bgColor")),$("#title_font-style").text(e.title_font),$("#title_font-style").data("css",e["title_font-style"]),$("#volume_font-style").text(e.volume_font),$("#volume_font-style").data("css",e["volume_font-style"]),$("#durButton_font-style").text(e.durButton_font),$("#durButton_font-style").data("css",e["durButton_font-style"]),$("#compButton_font-style").text(e.compButton_font),$("#compButton_font-style").data("css",e["compButton_font-style"]),$("#axis_font-style").text(e.axis_font),$("#axis_font-style").data("css",e["axis_font-style"])),$("form ol li ol.drillDown li:visible:last").css({clear:"left","float":"left","margin-bottom":"10px"}),$("#duration").trigger("change"),$("#showTitles").triggerHandler("click"),$("#showVolume").triggerHandler("click"),$("#showVolumeTitle").triggerHandler("click"),$("#showDuration").triggerHandler("click"),$("#showComparison").triggerHandler("click"),$("#showAxis").triggerHandler("click"),$("#settings").show()})},RiseVision.FinancialChart.Settings.prototype.populateColor=function(t,e){t.val(e),t.css("background-color",e)},RiseVision.FinancialChart.Settings.prototype.showStockSelector=function(t){gadgets.rpc.call("","rscmd_openFinancialSelector",null,t,$("#"+t).val())},RiseVision.FinancialChart.Settings.prototype.showColorPicker=function(t){gadgets.rpc.call("","rscmd_openColorPicker",null,t,$("#"+t).val())},RiseVision.FinancialChart.Settings.prototype.showFontSelector=function(t){gadgets.rpc.call("","rscmd_openFontSelector",null,t,$("#"+t).data("css"))},RiseVision.FinancialChart.Settings.prototype.setStocks=function(t,e){$("#"+t).val(e)},RiseVision.FinancialChart.Settings.prototype.setColor=function(t,e){$("#"+t).val(e),$("#"+t).css("background-color",e)},RiseVision.FinancialChart.Settings.prototype.setFont=function(t,e,i){$("#"+t).data("css",e),$("#"+t).text(i)},RiseVision.FinancialChart.Settings.prototype.getSettings=function(){var t=!1,e=document.getElementsByClassName("errors")[0],i="",a=null;return $(".errors").empty(),t=chart.settings.validateNumeric($("#volumeHeight"),e,"Volume Height")?!0:t,t=chart.settings.validateNumeric($("#barWidth"),e,"Bar Width")?!0:t,t=chart.settings.validateNumeric($("#durButtonRadius"),e,"Duration Button Corner Radius")?!0:t,t=chart.settings.validateNumeric($("#durRotate"),e,"Rotate Every")?!0:t,t=chart.settings.validateNumeric($("#durReturn"),e,"Return to Default After")?!0:t,t=chart.settings.validateNumeric($("#compButtonRadius"),e,"Comparison Button Corner Radius")?!0:t,t=chart.settings.validateNumeric($("#compReturn"),e,"Chart Returns to Default")?!0:t,t=chart.settings.validateRequired($("#instrument"),e,"Instrument")?!0:t,$("#showComparison").is(":checked")&&(t=chart.settings.validateRequired($("#compInstruments"),e,"Comparative Instruments")?!0:t),t?($(".errors").fadeIn(200).css("display","inline-block"),$("#wrapper").scrollTop(0),null):(i="up_instrument="+escape($("#instrument").val())+"&up_disclaimerFont="+$("#disclaimerFont").val()+"&up_disclaimerLoc="+$("#disclaimerLoc").val(),i+=$("#acceptance").is(":checked")?"&up_acceptance=true":"&up_acceptance=false",i+="&up_duration="+$("#duration").val()+"&up_previousCloseColor="+$("#previousCloseColor").val(),i+=$("#showTitles").is(":checked")?"&up_showTitles=true":"&up_showTitles=false",i+="&up_titleDecimals="+$("#titleDecimals").val()+"&up_titleSign="+$("#titleSign").val(),i+=$("#showVolume").is(":checked")?"&up_showVolume=true":"&up_showVolume=false",i+=$("#showVolumeTitle").is(":checked")?"&up_showVolumeTitle=true":"&up_showVolumeTitle=false",i+="&up_volumeHeight="+$("#volumeHeight").val()+"&up_volumeColor="+$("#volumeColor").val()+"&up_barWidth="+$("#barWidth").val(),i+=$("#showDuration").is(":checked")?"&up_showDuration=true":"&up_showDuration=false",i+="&up_durButtonColor="+$("#durButtonColor").val()+"&up_durSelButtonColor="+$("#durSelButtonColor").val()+"&up_durButtonRadius="+$("#durButtonRadius").val()+"&up_durRotate="+$("#durRotate").val()+"&up_durReturn="+$("#durReturn").val(),i+=$("#showComparison").is(":checked")?"&up_showComparison=true":"&up_showComparison=false",i+="&up_compInstruments="+escape($("#compInstruments").val())+"&up_compNames="+escape($("#compNames").val())+"&up_compLineColor="+$("#compLineColor").val()+"&up_compButtonRadius="+$("#compButtonRadius").val()+"&up_compButtonColor="+$("#compButtonColor").val()+"&up_compSelButtonColor="+$("#compSelButtonColor").val()+"&up_compReturn="+$("#compReturn").val(),i+=$("#showAxis").is(":checked")?"&up_showAxis=true":"&up_showAxis=false",i+="&up_axisDecimals="+$("#axisDecimals").val()+"&up_axisLineColor="+$("#axisLineColor").val()+"&up_gridLineColor="+$("#gridLineColor").val()+"&up_chartPlotLineColor="+$("#chartPlotLineColor").val()+"&up_chartFillColor="+$("#chartFillColor").val()+"&up_bgColor="+$("#bgColor").val(),a={params:i,additionalParams:JSON.stringify(chart.saveAdditionalParams())},$(".errors").css({display:"none"}),a)},RiseVision.FinancialChart.Settings.prototype.saveAdditionalParams=function(){var t={};return t.title_font=$("#title_font-style").text(),t["title_font-style"]=$("#title_font-style").data("css"),t.volume_font=$("#volume_font-style").text(),t["volume_font-style"]=$("#volume_font-style").data("css"),t.durButton_font=$("#durButton_font-style").text(),t["durButton_font-style"]=$("#durButton_font-style").data("css"),t.compButton_font=$("#compButton_font-style").text(),t["compButton_font-style"]=$("#compButton_font-style").data("css"),t.axis_font=$("#axis_font-style").text(),t["axis_font-style"]=$("#axis_font-style").data("css"),t},RiseVision.FinancialChart.Controller=function(t){this.displayID=t;var e=0,i={displayID:this.displayID,doCompare:this.doCompare(),callback:this.onDataLoaded};if(this.instrument=$.trim(prefs.getString("instrument")).split(",").slice(0,1)[0],this.isLoading=!0,this.isPlaying=!1,this.isDataLoaded=!1,this.isReloading=!1,this.isRefreshing=!1,this.isRetrying=!1,this.notPermissioned=!1,this.isDrawn=!1,this.numRetries=0,this.retryLimit=3,this.isSpinnerVisible=!1,this.isLabelFirst=!1,this.compareIndex=-1,this.numCallbacks=0,this.numReloads=0,this.totalReloads=0,this.refreshInterval=6e4,this.errorInterval=1e4,this.charts=[],this.compInstruments=[],this.compNames=[],this.compData=[],this.chartData={},this.titleData=null,this.showDuration=prefs.getBool("showDuration"),this.duration=prefs.getString("duration"),this.durations=[{type:"Day",description:"Day"},{type:"Week",description:"Week"},{type:"1M",description:"Month"},{type:"3M",description:"3 Months"},{type:"6M",description:"6 Months"},{type:"1Y",description:"1 Year"},{type:"5Y",description:"5 Years"}],this.realTime=new RiseVision.Common.Financial.RealTime(this.displayID,this.instrument),this.arrowURL="//s3.amazonaws.com/risecontentlogos/financial/",this.url="//contentfinancial2.appspot.com/reserve?id="+this.displayID+"&codes="+this.instrument,this.showDuration){for(var a=0;a<this.durations.length;a++)i.id=e,i.instrument=this.instrument,i.duration=this.durations[a].type,this.charts.push({primary:new RiseVision.FinancialChart.PrimaryInstrument(i)}),this.createDurationButton(this.durations[a]),this.durations[a].type==prefs.getString("duration")&&(this.currentIndex=a,this.currentChart=this.charts[this.currentIndex]),e++;$("#durations").show()}else i.id=e,i.instrument=this.instrument,i.duration=prefs.getString("duration"),this.charts.push({primary:new RiseVision.FinancialChart.PrimaryInstrument(i)}),this.currentIndex=0,this.currentChart=this.charts[this.currentIndex],e++;if(prefs.getBool("showComparison")){var s=prefs.getString("compInstruments").split(","),r=[];prefs.getString("compNames")&&(r=prefs.getString("compNames").split(",")),s=s.slice(0,3),r=r.slice(0,3),this.url+="|"+s.join("|");for(var a=0;a<s.length;a++)this.compData[a]=new RiseVision.Common.Financial.RealTime(this.displayID,$.trim(s[a]));for(var a=0;a<this.charts.length;a++)for(var o=0;o<s.length;o++)0==o&&(this.charts[a].comparative=[]),this.charts[a].comparative.push(new RiseVision.FinancialChart.Instrument({id:e,displayID:this.displayID,instrument:$.trim(s[o]),duration:this.charts[a].primary.getDuration(),name:r[o],callback:this.onDataLoaded})),e++;this.createInstrumentButtons(s)}switch(prefs.getInt("axisDecimals")){case 1:this.factor=10;break;case 2:this.factor=100;break;case 3:this.factor=1e3;break;case 4:this.factor=1e4;break;default:this.factor=1}this.setTotalCallbacks(),this.reserveInstruments(),$(document).bind("retry",function(t,e){controller.startRetryTimer(e)})},RiseVision.FinancialChart.Controller.prototype.reserveInstruments=function(){var t=this;gadgets.io.makeRequest(encodeURI(this.url),function(){},{}),setTimeout(function(){t.reserveInstruments()},864e5)},RiseVision.FinancialChart.Controller.prototype.stopRotation=function(){clearTimeout(this.rotateTimer)},RiseVision.FinancialChart.Controller.prototype.setInstrument=function(t,e){if(this.resumeRotation=e,e||clearTimeout(this.rotateTimer),this.isRetrying&&(clearInterval(this.retryTimer),this.isReloading=!1,this.isRetrying=!1),this.instrument!=t&&(this.instrument=t,!this.isReloading)){clearTimeout(this.refreshTimer),clearTimeout(this.inactivityTimer),this.chartData={},this.isReloading=!0,this.currentIndex=0,this.realTime.setInstruments(t);for(var i=0;i<this.charts.length;i++)this.charts[i].primary.setInstrument(t);this.setTotalCallbacks(),this.load()}},RiseVision.FinancialChart.Controller.prototype.setDuration=function(t){if(!this.isReloading){clearTimeout(this.refreshTimer),clearTimeout(this.inactivityTimer),clearTimeout(this.rotateTimer),this.isReloading=!0,this.duration=t;for(var e=0;e<this.charts.length;e++)if(this.charts[e].primary.setDuration(t),null!=this.charts[e].comparative)for(var i=0;i<this.charts[e].comparative.length;i++)this.charts[e].comparative[i].setDuration(t);this.load()}},RiseVision.FinancialChart.Controller.prototype.setTotalCallbacks=function(){this.totalCallbacks=1+this.compData.length;for(var t=0;t<this.charts.length;t++)if(this.charts[t].primary.getIsLoading()&&this.totalCallbacks++,null!=this.charts[t].comparative)for(var e=0;e<this.charts[t].comparative.length;e++)this.charts[t].comparative[e].getIsLoading()&&this.totalCallbacks++},RiseVision.FinancialChart.Controller.prototype.createDurationButton=function(t){var e=this,i=$("<a href='#' class='duration durButton_font-style'>");i.text(t.description),i.data("type",t.type),t.type==prefs.getString("duration")&&i.addClass("selected"),i.on("click",function(t){t.preventDefault(),e.isLoading||e.isReloading||(clearTimeout(e.inactivityTimer),clearTimeout(e.rotateTimer),e.showChart($(this).data("type")),prefs.getInt("durReturn")>0&&(e.inactivityTimer=setTimeout(function(){e.currentIndex=e.currentIndex+1>=e.durations.length?0:e.currentIndex+1,e.currentChart=e.charts[e.currentIndex],e.showChart($(".duration").eq(e.currentIndex).data("type")),e.startRotateTimer()},1e3*prefs.getInt("durReturn"))))}),$("#durations").append(i)},RiseVision.FinancialChart.Controller.prototype.createInstrumentButtons=function(t){var e=this;if(this.doCompare()){for(var i=0;i<t.length;i++)$button=$("<a href='#' class='button compButton_font-style'>"),$button.on("click",function(t){{var i=$(this).index();e.currentChart.comparative[i]}t.preventDefault(),clearTimeout(e.compReturnTimer),$(".button").removeClass("selected"),$(this).addClass("selected"),e.compareIndex=i,e.setChartData(!0),e.drawPriceChart(),prefs.getInt("compReturn")>0&&(e.compReturnTimer=setTimeout(function(){$(".button").removeClass("selected"),e.compareIndex=-1,e.setChartData(!0),e.drawPriceChart()},1e3*prefs.getInt("compReturn")))}),$("#buttons").append($button);$("#buttons").show()}},RiseVision.FinancialChart.Controller.prototype.getAdditionalParams=function(t,e){if("additionalParams"==t&&e){var i=document.createElement("style");e=JSON.parse(e),e["title_font-style"]&&i.appendChild(document.createTextNode(e["title_font-style"])),e["volume_font-style"]&&i.appendChild(document.createTextNode(e["volume_font-style"])),e["durButton_font-style"]&&i.appendChild(document.createTextNode(".duration:active, .duration:visited, "+e["durButton_font-style"])),e["compButton_font-style"]&&i.appendChild(document.createTextNode(".button:active, .button:visited, "+e["compButton_font-style"])),e["axis_font-style"]&&i.appendChild(document.createTextNode(".flotr-grid-label, "+e["axis_font-style"])),document.getElementsByTagName("head")[0].appendChild(i)}controller.load()},RiseVision.FinancialChart.Controller.prototype.load=function(){if(this.isDataLoaded=!1,this.isLoading)for(var t=0;t<this.charts.length;t++)if(this.charts[t].primary.reset(),null!=this.charts[t].comparative)for(var e=0;e<this.charts[t].comparative.length;e++)this.charts[t].comparative[e].reset();this.loadRealTimeData()},RiseVision.FinancialChart.Controller.prototype.loadRealTimeData=function(){var t=this;this.realTime.getData(["name","lastPrice","netChange","accumulatedVolume","tradeTime","historicClose","percentChange"],!1,!1,function(e){t.onRealTimeDataLoaded(e)})},RiseVision.FinancialChart.Controller.prototype.onRealTimeDataLoaded=function(t){var e=this;if(null!=t)if("..."==t.getFormattedValue(0,1))this.numRetries++,this.numRetries==this.retryLimit?($("#priceChart").spinner("remove"),this.isSpinnerVisible=!1,this.numRetries=0,this.onDataLoaded(!1),this.getRemainingData(!1),console.log("Unable to load real-time data for: "+this.instrument+" "+this.duration)):$.event.trigger("retry",function(){e.loadRealTimeData()});else{"N/P"==t.getFormattedValue(0,1)&&(this.notPermissioned=!0),null!=t&&(this.titleData=t),this.numRetries=0;for(var i=0,a=this.charts.length;a>i;i++)this.charts[i].primary.setRealTimeData(t);this.updateTitles(),this.isLoading&&(this.initUI(),$("#disclaimer, #buttons, #title, #priceChart, #durations, #volumeTitle, #volumeChart").removeClass("hidden")),this.onDataLoaded(!0),this.getRemainingData(!0)}else this.getRemainingData(!1)},RiseVision.FinancialChart.Controller.prototype.getRemainingData=function(t){if(t)if((this.isLoading||this.isReloading)&&(this.isSpinnerVisible||($("#priceChart").spinner({img:"//preview.risevision.com/images/ajax-loader-circle.gif",width:100,height:100,position:"center"}),this.isSpinnerVisible=!0),this.isLoading&&readyEvent()),0==this.compData.length)this.charts.length>0&&this.updatePrimaryChart(0,this.onPrimaryDataLoaded);else{this.compDataLoaded=0;for(var e=0;e<this.compData.length;e++)this.loadComparativeData(e)}else this.isDataLoaded=!0,this.isRefreshing=!1,this.startRefreshTimer()},RiseVision.FinancialChart.Controller.prototype.loadComparativeData=function(t){var e=this;this.compData[t].getData(["percentChange","tradeTime","name"],!1,!1,function(i){e.onComparativeDataLoaded(i,t)})},RiseVision.FinancialChart.Controller.prototype.onComparativeDataLoaded=function(t,e){var i=this,a=!1;if(null!=t)if(null==t.getFormattedValue(0,2))this.numRetries++,this.numRetries==this.retryLimit?($("#priceChart").spinner("remove"),this.isSpinnerVisible=!1,this.numRetries=0,this.onDataLoaded(!1),this.onCompRealTimeDataLoaded(!1),console.log("Unable to load comparative real-time data.")):$.event.trigger("retry",function(){i.loadComparativeData(e)});else{this.numRetries=0;for(var s=0;s<this.charts.length;s++)if("N/P"==t.getFormattedValue(0,0)){if(this.isLoading){$("#error").text("One or more of the comparative instruments requires a Premium license. Contact sales@risedisplay.com for licensing options.").show(),a=!0;break}}else this.charts[s].comparative[e].setRealTimeData(t);a?(this.isSpinnerVisible&&($("#priceChart").spinner("remove"),this.isSpinnerVisible=!1),$("#buttons, #priceChart, #durations").hide()):(this.onDataLoaded(!0),this.onCompRealTimeDataLoaded(!0))}else this.onDataLoaded(!0),this.onCompRealTimeDataLoaded(!0)},RiseVision.FinancialChart.Controller.prototype.onCompRealTimeDataLoaded=function(){this.compDataLoaded++,this.compDataLoaded==this.compData.length&&this.charts.length>0&&this.updatePrimaryChart(0,this.onPrimaryDataLoaded)},RiseVision.FinancialChart.Controller.prototype.onPrimaryDataLoaded=function(){for(var t=1;t<this.charts.length;t++)this.updatePrimaryChart(t,null)},RiseVision.FinancialChart.Controller.prototype.updatePrimaryChart=function(t,e){var i=this;if(this.charts[t].primary.getIsLoading())this.charts[t].primary.reset(),this.charts[t].primary.loadHistoricalData(function(){if(i.onDataLoaded(),null!=i.charts[t].comparative)if(0==t)for(var a=0,s=0;s<i.charts[t].comparative.length;s++)i.updateComparativeCharts(t,s,function(){a++,a==i.charts[t].comparative.length&&null!=e&&e.call(i)});else for(var s=0;s<i.charts[t].comparative.length;s++)i.updateComparativeCharts(t,s,null);else null!=e&&e.call(i)});else if(this.charts[t].primary.plotRealTimeData(),null!=i.charts[t].comparative)if(0==t)for(var a=0,s=0;s<i.charts[t].comparative.length;s++)i.updateComparativeCharts(t,s,function(){a++,a==i.charts[t].comparative.length&&null!=e&&e.call(i)});else for(var s=0;s<i.charts[t].comparative.length;s++)i.updateComparativeCharts(t,s,null);else null!=e&&e.call(i)},RiseVision.FinancialChart.Controller.prototype.updateComparativeCharts=function(t,e,i){var a=this;this.charts[t].comparative[e].getIsLoading()?(this.charts[t].comparative[e].reset(),this.charts[t].comparative[e].loadHistoricalData(this.charts[t].primary.getTicks(),function(){a.isLoading&&($(".button").eq(e).text(a.charts[t].comparative[e].name),$(".button").eq(e).css("display","inline-block")),a.onDataLoaded(),null!=i&&i.call(a)})):(this.charts[t].comparative[e].plotRealTimeData(),null!=i&&i.call(a))},RiseVision.FinancialChart.Controller.prototype.onDataLoaded=function(){if(this.numCallbacks++,this.numCallbacks==this.totalCallbacks){if(this.isSpinnerVisible&&($("#priceChart").spinner("remove"),this.isSpinnerVisible=!1),this.isDataLoaded=!0,this.charts[0].primary.setIsUpdated(!1),null!=this.charts[0].comparative)for(var t=0;t<this.charts[0].comparative.length;t++)this.charts[0].comparative[t].setIsUpdated(!1);this.isLoading?(this.isLoading=!1,this.setChartData(!1),this.isPlaying&&this.drawChart()):this.isReloading?this.isPlaying&&(this.isDrawn?(this.currentChart=this.charts[this.currentIndex],this.showChart(this.showDuration?$(".duration").eq(this.currentIndex).data("type"):this.duration),this.updateTitles(),this.startRefreshTimer(),this.startRotateTimer()):(this.setChartData(!1),this.drawChart())):(this.setChartData(!0),this.refresh(),this.isPlaying&&this.isDrawn&&this.startRotateTimer()),this.numCallbacks=0,this.isReloading=!1}},RiseVision.FinancialChart.Controller.prototype.refresh=function(){this.drawPriceChart(),prefs.getBool("showVolume")&&this.drawVolumeChart(),this.isRefreshing=!1,this.startRefreshTimer()},RiseVision.FinancialChart.Controller.prototype.setChartData=function(t){var e,i,a,s,r=prefs.getBool("showComparison")?!1:!0;r&&("transparent"==prefs.getString("chartFillColor")||""==prefs.getString("chartFillColor")?(r=!1,i=""):(i=prefs.getBool("showComparison")?"":prefs.getString("chartFillColor"),(s=/rgba\(\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})\s*,\s*([0-9]+(?:\.[0-9]+)?)\s*\)/.exec(i))&&(a=parseFloat(s[4])))),t?(e=this.compareIndex>=0?this.currentChart.primary.getPercentChange():this.currentChart.primary.getY(),this.chartData.price=[],this.chartData.price.push({data:[this.currentChart.primary.getX(),e],color:prefs.getString("chartPlotLineColor"),"lite-lines":{lineWidth:3,fill:r,fillColor:i,fillOpacity:a}}),this.compareIndex>=0?this.chartData.price.push({data:[this.currentChart.comparative[this.compareIndex].getX(),this.currentChart.comparative[this.compareIndex].getY()],color:prefs.getString("compLineColor")}):this.currentChart.primary.getHistoricCloseX().length>0&&this.currentChart.primary.getHistoricCloseY().length>0&&this.chartData.price.push({data:[this.currentChart.primary.getHistoricCloseX(),this.currentChart.primary.getHistoricCloseY()],color:prefs.getString("previousCloseColor"),"lite-lines":{lineStyle:"dashed"}})):(this.chartData.price=[{data:[this.currentChart.primary.getX(),this.currentChart.primary.getY()],color:prefs.getString("chartPlotLineColor"),"lite-lines":{lineWidth:3,fill:r,fillColor:i,fillOpacity:a}}],this.currentChart.primary.getHistoricCloseX().length>0&&this.currentChart.primary.getHistoricCloseY().length>0&&this.chartData.price.push({data:[this.currentChart.primary.getHistoricCloseX(),this.currentChart.primary.getHistoricCloseY()],color:prefs.getString("previousCloseColor"),"lite-lines":{lineStyle:"dashed"}})),this.chartData.summaryTicks=this.currentChart.primary.getTicks(),this.chartData.volume=[this.currentChart.primary.getVolumeX(),this.currentChart.primary.getVolumeY()]},RiseVision.FinancialChart.Controller.prototype.updateTitles=function(){var t=parseFloat(this.titleData.getFormattedValue(0,2)),e=parseFloat(this.titleData.getFormattedValue(0,3)),i=parseFloat(this.titleData.getFormattedValue(0,4)),a=prefs.getInt("titleDecimals"),s=prefs.getString("titleSign"),r="Last ";$("#instrument").text(this.titleData.getFormattedValue(0,1)),$("#last").text(r+RiseVision.Common.Utility.addCommas(t.toFixed(a))),"none"==s?($("#last").text(r+RiseVision.Common.Utility.addCommas(Math.abs(t).toFixed(a))),$("#changeValue").text(RiseVision.Common.Utility.addCommas(Math.abs(e).toFixed(a)))):"minus"==s?$("#changeValue").text(RiseVision.Common.Utility.addCommas(e.toFixed(a))):"plusMinus"==s?(t>0&&$("#last").text(r+"+"+RiseVision.Common.Utility.addCommas(t.toFixed(a))),$("#changeValue").text(e>0?"+"+RiseVision.Common.Utility.addCommas(ge.toFixed(a)):RiseVision.Common.Utility.addCommas(e.toFixed(a)))):"parentheses"==s?(0>t&&$("#last").text(r+"("+RiseVision.Common.Utility.addCommas(Math.abs(t).toFixed(a))+")"),$("#changeValue").text(0>e?"("+RiseVision.Common.Utility.addCommas(Math.abs(e).toFixed(a))+")":RiseVision.Common.Utility.addCommas(e.toFixed(a)))):"arrow"==s&&($("#changeValue").text(RiseVision.Common.Utility.addCommas(Math.abs(e).toFixed(a))),0>e?$("#arrow").css("background-image","url('"+this.arrowURL+"animated-red-arrow.gif')"):$("#arrow").css("background-image","url('"+this.arrowURL+"animated-green-arrow.gif')")),prefs.getBool("showVolumeTitle")&&$("#volumeTitle").text("Accumulated Volume "+RiseVision.Common.Utility.addCommas(i))},RiseVision.FinancialChart.Controller.prototype.initUI=function(){var t,e,i,a=prefs.getString("disclaimerLoc");$("#container").width(prefs.getString("rsW")),$("#container").height(prefs.getString("rsH")),("bottomRight"==a||"topRight"==a)&&$("#disclaimer").addClass("right"),$("#disclaimer").css("font-family",prefs.getString("disclaimerFont")),("bottomRight"==a||"bottomLeft"==a)&&$("#disclaimer").appendTo("#container"),$("#disclaimer").show(),prefs.getBool("showTitles")||$("#title").hide(),t=prefs.getBool("showVolume")?this.doCompare()?"#priceChart { height: "+($("#container").height()-$("#disclaimer").outerHeight(!0)-$("#buttons").outerHeight(!0)-$("#instrument").outerHeight(!0)-$("#durations").outerHeight(!0)-$("#volumeTitle").outerHeight(!0)-prefs.getInt("volumeHeight")/100*$("#container").height())+"px; }":"#priceChart { height: "+($("#container").height()-$("#disclaimer").outerHeight(!0)-$("#instrument").outerHeight(!0)-$("#durations").outerHeight(!0)-$("#volumeTitle").outerHeight(!0)-prefs.getInt("volumeHeight")/100*$("#container").height())+"px; }":this.doCompare()?"#priceChart { height: "+($("#container").height()-$("#disclaimer").outerHeight(!0)-$("#buttons").outerHeight(!0)-$("#instrument").outerHeight(!0)-$("#durations").outerHeight(!0)-$("#priceChart").outerHeight(!0))+"px; }":"#priceChart { height: "+($("#container").height()-$("#disclaimer").outerHeight(!0)-$("#instrument").outerHeight(!0)-$("#durations").outerHeight(!0)-$("#priceChart").outerHeight(!0))+"px; }",i=document.createElement("style"),i.appendChild(document.createTextNode(t)),document.getElementsByTagName("head")[0].appendChild(i),prefs.getBool("showVolume")?(i=document.createElement("style"),e=".envision-finance-volume .envision-component { height: "+(prefs.getInt("volumeHeight")/100*$("#container").height()-parseInt($("#priceChart").css("margin-bottom"))-2)+"px !important; }",i.appendChild(document.createTextNode(e)),document.getElementsByTagName("head")[0].appendChild(i)):$(".volume").hide(),$("#arrow").width($("#instrument").height()),$("#arrow").height($("#instrument").height())},RiseVision.FinancialChart.Controller.prototype.drawChart=function(){prefs.getString("disclaimerLoc");this.drawPriceChart(),prefs.getBool("showVolume")&&this.drawVolumeChart(),this.startRefreshTimer(),this.startRotateTimer()},RiseVision.FinancialChart.Controller.prototype.drawPriceChart=function(){var t=this,e=(this.chartData.summaryTicks,{container:$("#priceChart"),data:{price:this.chartData.price,volume:this.chartData.volume},defaults:{price:{config:{xaxis:{showLabels:prefs.getBool("showAxis"),ticks:prefs.getBool("showAxis")?this.getTicks():null},yaxis:{showLabels:prefs.getBool("showAxis"),min:this.calculateMin(),max:this.calculateMax(),tickDecimals:prefs.getInt("axisDecimals")},grid:{horizontalLines:!0,verticalLines:!0,backgroundColor:null,tickColor:prefs.getString("gridLineColor")}}}},yTickFormatter:function(e){return e=RiseVision.Common.Utility.addCommas(e),t.compareIndex>=0?e+"%":e}});this.isDrawn?($(".envision-finance-price").unbind(),$(".envision-finance-price").remove(),this.finance.vis.destroy(),this.finance.vis=null,this.finance.price=null,this.finance=null,this.finance=new envision.templates.PriceChart(e)):(this.finance=new envision.templates.PriceChart(e),$(".envision-finance-price").css("border-color",prefs.getString("axisLineColor")),this.isDrawn=!0),$(".envision-finance-price").css("border-color",prefs.getString("axisLineColor")),this.isLabelFirst&&($(".envision-finance-price .flotr-grid-label-x:first-child").addClass("importantRule"),this.isLabelFirst=!1)},RiseVision.FinancialChart.Controller.prototype.drawVolumeChart=function(){for(var t=!0,e=(this.chartData.summaryTicks,{container:$("#volumeChart"),data:{price:this.chartData.price,volume:this.chartData.volume},defaults:{volume:{config:{whiskers:{color:prefs.getString("volumeColor"),lineWidth:prefs.getInt("barWidth")},grid:{tickColor:prefs.getString("gridLineColor")}}}},yTickFormatter:function(t){return t=parseInt(t),isNaN(t)?"":0==t?"":t/1e6+"M"}}),i=0;i<this.chartData.volume.length;i++)if(0==this.chartData.volume[i].length){t=!1;break}this.volume&&(this.volume.vis.destroy(),this.volume=null),t&&(this.volume=new envision.templates.VolumeChart(e)),$(".envision-finance-volume").css("border-color",prefs.getString("axisLineColor"))},RiseVision.FinancialChart.Controller.prototype.getTicks=function(){return"Day"==this.duration?this.getDailyTicks():"Week"==this.duration?this.getWeeklyTicks():"1M"==this.duration||"3M"==this.duration?this.getMonthlyTicks():"6M"==this.duration?this.get6MonthTicks():"1Y"==this.duration||"5Y"==this.duration?this.getYearlyTicks():void 0},RiseVision.FinancialChart.Controller.prototype.getDailyTicks=function(){var t,e,i,a,s=this.chartData.summaryTicks.length,r=new Date(this.charts[0].primary.collectionStartTime),o=new Date(this.charts[0].primary.collectionEndTime),n=[],l=0;if(null!=this.charts[0].primary.collectionStartTime&&null!=this.charts[0].primary.collectionEndTime)for(;r.isBefore(o);){if(a=r.getMinutes(),0==a){for(0==l&&(this.isLabelFirst=!0),n.push([l,r.toString("HH:mm")]),e=new Date(r.getTime()),e=e.addHours(2),r.addMinutes(5);r.isBefore(o);){if(Date.equals(r,e)){for(;s>l;l++){if(t=new Date(this.chartData.summaryTicks[l].date),i=new Date(Date.equals(new Date(this.charts[0].primary.collectionStartTime).clearTime(),Date.today())?t:r),i.setHours(new Date(r).getHours()),i.setMinutes(new Date(r).getMinutes()),i.setSeconds(0),t.equals(i)){n.push([l,e.toString("HH:mm")]);
  break}if(t.isAfter(i)){n.push([l-1,e.toString("HH:mm")]);break}}e=e.addHours(2)}r.addMinutes(5)}break}r.addMinutes(5),l++}return n},RiseVision.FinancialChart.Controller.prototype.getWeeklyTicks=function(){for(var t=this.chartData.summaryTicks.length,e=null,i=null,a=[],s=0;t>s;s++)e=new Date(this.chartData.summaryTicks[s].date).clearTime(),i&&e?Date.equals(e,i)||e.getDay()>=1&&e.getDay()<=5&&a.push([s,e.toString("ddd MMM d")]):e.getDay()>=1&&e.getDay()<=5&&a.push([s,e.toString("ddd MMM d")]),i=e;return this.isLabelFirst=!0,a.length>5&&a.splice(0,a.length-5),a},RiseVision.FinancialChart.Controller.prototype.getMonthlyTicks=function(){for(var t,e=this.chartData.summaryTicks.length,i=[],a=0;e>a;a++)t=new Date(this.chartData.summaryTicks[a].originalDate),5==t.getDay()&&(1>=a&&(this.isLabelFirst=!0),i.push([a,t.toString("MMM d")]));return i},RiseVision.FinancialChart.Controller.prototype.get6MonthTicks=function(){for(var t,e,i,a=this.chartData.summaryTicks.length,s=[],r=0;a>r;r++)i=new Date(this.chartData.summaryTicks[r].date),0==r?(s.push([r,i.toString("MMM")]),e=i.getMonth()):(t=i.getMonth(),t!=e&&s.push([r,i.toString("MMM")]),e=t);return this.isLabelFirst=!0,s},RiseVision.FinancialChart.Controller.prototype.getYearlyTicks=function(){for(var t,e,i,a=this.chartData.summaryTicks.length,s=[],r=0;a>r;r++)i=new Date(this.chartData.summaryTicks[r].date),t=i.getMonth(),0==t?t!=e&&(0==r&&(this.isLabelFirst=!0),s.push([r,i.toString("yyyy")])):t%3==0&&t!=e&&(0==r&&(this.isLabelFirst=!0),s.push([r,i.toString("MMM")])),e=t;return s},RiseVision.FinancialChart.Controller.prototype.calculateMin=function(){var t=this.getInstrumentValues();return this.doCompare()?Math.floor(Math.min.apply(null,t)*this.factor)/this.factor:(this.currentChart.primary.getHistoricCloseY().length>0&&t.push(parseFloat(this.currentChart.primary.getHistoricCloseY()[0])),Math.floor(Math.min.apply(null,t)*this.factor)/this.factor)},RiseVision.FinancialChart.Controller.prototype.calculateMax=function(){var t=this.getInstrumentValues();return this.doCompare()?Math.ceil(Math.max.apply(null,t)*this.factor)/this.factor:(this.currentChart.primary.getHistoricCloseY().length>0&&t.push(parseFloat(this.currentChart.primary.getHistoricCloseY()[0])),Math.ceil(Math.max.apply(null,t)*this.factor)/this.factor)},RiseVision.FinancialChart.Controller.prototype.getInstrumentValues=function(){var t,e,i,a=[];for(t=0;t<this.chartData.price.length;t++)for(i=this.chartData.price[t].data[1].length,e=0;i>e;e++)-1e3!=this.chartData.price[t].data[1][e]&&a.push(parseFloat(this.chartData.price[t].data[1][e]));return a},RiseVision.FinancialChart.Controller.prototype.showChart=function(t){var e=0;$(".duration").each(function(i){return $(this).data("type")==t?(e=i,!1):void 0}),this.charts[e].primary.isLoading&&"Day"!=this.charts[e].primary.duration||($(".duration").removeClass("selected"),$(".duration").eq(e).addClass("selected"),this.currentIndex=e,this.currentChart=this.charts[this.currentIndex],this.duration=t,this.setChartData(!0),this.drawPriceChart(),prefs.getBool("showVolume")&&this.drawVolumeChart())},RiseVision.FinancialChart.Controller.prototype.startRetryTimer=function(t){var e=this;this.isRetrying?this.callbacks.push(t):(this.callbacks=[t],this.isRetrying=!0,this.countdown=this.errorInterval/1e3,this.retryTimer=setInterval(function(){if(e.countdown--,0==e.countdown){e.isRetrying=!1,clearInterval(e.retryTimer);for(var t=0;t<e.callbacks.length;t++)e.callbacks[t]();e.callbacks=[]}},1e3))},RiseVision.FinancialChart.Controller.prototype.startRotateTimer=function(){for(var t=this,e=!1,i=this.currentIndex;i<this.charts.length;i++)if(!this.charts[i].primary.isLoading){e=!0;break}e?this.showDuration&&prefs.getInt("durRotate")>0&&(clearTimeout(this.rotateTimer),this.rotateTimer=setTimeout(function(){t.onRotateTimerExpired.call(t)},1e3*prefs.getInt("durRotate"))):this.showDuration&&prefs.getInt("durRotate")>0&&(clearTimeout(this.rotateTimer),this.rotateTimer=setTimeout(function(){t.isReloading||doneEvent()},1e3*prefs.getInt("durRotate")))},RiseVision.FinancialChart.Controller.prototype.onRotateTimerExpired=function(){!this.isReloading&&this.resumeRotation&&(this.currentIndex=this.currentIndex+1>=this.durations.length?0:this.currentIndex+1,this.currentChart=this.charts[this.currentIndex],0==this.currentIndex?doneEvent():(this.showChart($(".duration").eq(this.currentIndex).data("type")),this.startRotateTimer()))},RiseVision.FinancialChart.Controller.prototype.startRefreshTimer=function(){var t=this;this.notPermissioned||(clearTimeout(this.refreshTimer),this.refreshTimer=setTimeout(function(){t.isRefreshing=!0,t.setTotalCallbacks(),t.load()},this.refreshInterval))},RiseVision.FinancialChart.Controller.prototype.doCompare=function(){return prefs.getBool("showComparison")?prefs.getString("compInstruments").split(",").length>0:!1},RiseVision.FinancialChart.Controller.prototype.play=function(){this.resumeRotation=!0,!this.isDrawn&&!this.isRetrying&&this.isDataLoaded&&$("#container:visible").length>0?this.drawChart():!this.isDrawn||this.isRetrying||this.isReloading||this.startRotateTimer(),this.isPlaying=!0},RiseVision.FinancialChart.Controller.prototype.pause=function(){var t=this;clearTimeout(this.rotateTimer),clearTimeout(this.inactivityTimer),this.isDrawn&&this.showDuration&&0==this.currentIndex&&(clearTimeout(t.pauseTimer),t.pauseTimer=setTimeout(function(){t.showChart($(".duration").eq(t.currentIndex).data("type"))},500)),this.isPlaying=!1},RiseVision.FinancialChart.Instrument={},RiseVision.FinancialChart.Instrument=function(t){new gadgets.Prefs;t&&(this.instrument=t.instrument,this.id=t.id,this.displayID=t.displayID,this.duration=t.duration,this.name=t.name,this.callback=t.callback,this.retryLimit=3,this.historical=new RiseVision.Common.Financial.Historical(t.displayID,t.instrument,t.duration),this.reset(),"Day"==t.duration?this.interval=3e5:"Week"==t.duration&&(this.interval=18e5))},RiseVision.FinancialChart.Instrument.prototype.reset=function(){this.x=[],this.y=[],this.isLoading=!0,this.startIndex=0,this.numRetries=0},RiseVision.FinancialChart.Instrument.prototype.getIsLoading=function(){return this.isLoading},RiseVision.FinancialChart.Instrument.prototype.getX=function(){return this.x},RiseVision.FinancialChart.Instrument.prototype.getY=function(){return this.y},RiseVision.FinancialChart.Instrument.prototype.getDuration=function(){return this.duration},RiseVision.FinancialChart.Instrument.prototype.setInstrument=function(t){this.reset(),this.historical.setInstrument(t)},RiseVision.FinancialChart.Instrument.prototype.setRealTimeData=function(t){this.realTimeData=t},RiseVision.FinancialChart.Instrument.prototype.setIsUpdated=function(t){this.historical.setIsUpdated(t)},RiseVision.FinancialChart.Instrument.prototype.setDuration=function(t){this.reset(),this.duration=t,this.historical.setDuration(t),"Day"==t?this.interval=3e5:"Week"==t&&(this.interval=18e5)},RiseVision.FinancialChart.Instrument.prototype.loadHistoricalData=function(t,e){var i=this;this.ticks=t,this.historical.getHistoricalData(["percentChange","tradeTime"],function(t){null!=t?i.save(t,e):e(!0)})},RiseVision.FinancialChart.Instrument.prototype.save=function(t,e){var i,a,s,r=this,o=t.data.getNumberOfRows(),n=t.collectionData.timeZoneOffset,l=0,h=0;if(0==o||1==o&&(null==t.data.getFormattedValue(0,1)||""==t.data.getFormattedValue(0,1)))this.numRetries++,this.numRetries==this.retryLimit?(this.numRetries=0,console.log("Unable to load data for: "+this.instrument+" "+this.duration),e(!1)):$.event.trigger("retry",function(){r.loadHistoricalData(r.ticks,e)});else{for(var c=0;c<this.ticks.length;c++)o>l?(a=new Date(this.ticks[c].date),i=RiseVision.Common.Utility.adjustTime(new Date(t.data.getFormattedValue(l,1)),n),y=parseFloat(t.data.getFormattedValue(l,0)),this.x.push(h),this.y.push(y),this.startIndex++,h++,(Date.equals(i,a)||i.isBefore(a))&&l++):("Day"==this.duration||"Week"==this.duration)&&(s=new Date,i.isBefore(s)?(this.x.push(h),this.y.push(y),this.startIndex++,i.addMilliseconds(this.interval),h++):(this.x.push(h),this.y.push(-1e3),h++));this.numRetries=0,this.ticks.length>0&&(this.lastTradeTime=new Date(this.ticks[this.startIndex-1].date)),this.plotRealTimeData(),e(!0)}},RiseVision.FinancialChart.Instrument.prototype.plotRealTimeData=function(){var t,e,a=this.realTimeData.getFormattedValue(0,7),s=!1;if(i=0,null!=this.realTimeData){if(this.isLoading)null!=this.realTimeData.getFormattedValue(0,2)&&""!=this.realTimeData.getFormattedValue(0,2)&&null!=this.lastTradeTime&&(t=RiseVision.Common.Utility.adjustTime(new Date(this.realTimeData.getFormattedValue(0,2)),a).clearTime(),"Day"!=this.duration&&"Week"!=this.duration&&(Date.equals(t,this.lastTradeTime)||(this.x.push(this.startIndex),this.y.push(parseFloat(this.realTimeData.getFormattedValue(0,1))),this.lastTradeTime=RiseVision.Common.Utility.adjustTime(new Date(this.realTimeData.getFormattedValue(0,2)),a)))),this.isLoading=!1;else if(null!=this.realTimeData.getFormattedValue(0,2)&&""!=this.realTimeData.getFormattedValue(0,2)&&null!=this.lastTradeTime)if(t=RiseVision.Common.Utility.adjustTime(new Date(this.realTimeData.getFormattedValue(0,2)),a),tradeDay=t.clone().clearTime(),lastTradeDay=this.lastTradeTime.clone().clearTime(),Date.equals(tradeDay,lastTradeDay))if("Day"==this.duration||"Week"==this.duration){for(i=0;i<this.ticks.length;i++)if(e=new Date(this.ticks[i].date),e.isAfter(t)||Date.equals(e,t)){s=!0;break}if(s)for(;(e.isAfter(t)||Date.equals(e,t))&&e.isBefore(new Date)&&i<this.y.length;)this.y[i]=parseFloat(this.realTimeData.getFormattedValue(0,1)),this.lastTradeTime=t,e.addMilliseconds(this.interval),i++}else this.y[this.startIndex-1]=parseFloat(this.realTimeData.getFormattedValue(0,1)),this.lastTradeTime=t;else this.isLoading=!0;null==this.name&&(this.name=this.realTimeData.getFormattedValue(0,3))}else this.isLoading=!1,null==this.name&&(this.name=this.realTimeData.getFormattedValue(0,3))},RiseVision.FinancialChart.PrimaryInstrument={},RiseVision.FinancialChart.PrimaryInstrument.prototype=new RiseVision.FinancialChart.Instrument,RiseVision.FinancialChart.PrimaryInstrument.prototype.constructor=RiseVision.FinancialChart.PrimaryInstrument,RiseVision.FinancialChart.PrimaryInstrument=function(t){this.doCompare=t.doCompare,this.reset(),RiseVision.FinancialChart.Instrument.call(this,{id:t.id,displayID:t.displayID,instrument:t.instrument,duration:t.duration,callback:t.callback})},RiseVision.FinancialChart.PrimaryInstrument.prototype.reset=function(){this.ticks=[],this.volumeX=[],this.volumeY=[],this.accumulatedVolume=0,this.historicCloseX=[],this.historicCloseY=[],this.doCompare&&(this.percentChange=[]),RiseVision.FinancialChart.Instrument.prototype.reset.call(this)},RiseVision.FinancialChart.PrimaryInstrument.prototype.getIsLoading=function(){return RiseVision.FinancialChart.Instrument.prototype.getIsLoading.call(this)},RiseVision.FinancialChart.PrimaryInstrument.prototype.getX=function(){return RiseVision.FinancialChart.Instrument.prototype.getX.call(this)},RiseVision.FinancialChart.PrimaryInstrument.prototype.getY=function(){return RiseVision.FinancialChart.Instrument.prototype.getY.call(this)},RiseVision.FinancialChart.PrimaryInstrument.prototype.getPercentChange=function(){return this.percentChange},RiseVision.FinancialChart.PrimaryInstrument.prototype.getTicks=function(){return this.ticks},RiseVision.FinancialChart.PrimaryInstrument.prototype.getVolumeX=function(){return this.volumeX},RiseVision.FinancialChart.PrimaryInstrument.prototype.getVolumeY=function(){return this.volumeY},RiseVision.FinancialChart.PrimaryInstrument.prototype.getHistoricCloseX=function(){return this.historicCloseX},RiseVision.FinancialChart.PrimaryInstrument.prototype.getHistoricCloseY=function(){return this.historicCloseY},RiseVision.FinancialChart.PrimaryInstrument.prototype.getDuration=function(){return RiseVision.FinancialChart.Instrument.prototype.getDuration.call(this)},RiseVision.FinancialChart.PrimaryInstrument.prototype.setInstrument=function(t){this.reset(),RiseVision.FinancialChart.Instrument.prototype.setInstrument.call(this,t)},RiseVision.FinancialChart.PrimaryInstrument.prototype.setDuration=function(t){this.reset(),RiseVision.FinancialChart.Instrument.prototype.setDuration.call(this,t)},RiseVision.FinancialChart.PrimaryInstrument.prototype.setRealTimeData=function(t){RiseVision.FinancialChart.Instrument.prototype.setRealTimeData.call(this,t)},RiseVision.FinancialChart.PrimaryInstrument.prototype.setIsUpdated=function(t){RiseVision.FinancialChart.Instrument.prototype.setIsUpdated.call(this,t)},RiseVision.FinancialChart.PrimaryInstrument.prototype.loadHistoricalData=function(t){var e=this,i={},a=null;a=this.doCompare?["closePrice","accumulatedVolume","tradeTime","percentChange"]:["closePrice","accumulatedVolume","tradeTime"],this.historical.getHistoricalData(a,function(i){null!=i?e.save(i,t):t(!0)},i)},RiseVision.FinancialChart.PrimaryInstrument.prototype.save=function(t,e){var i,a,s=this,r=0,o=0,n=0,l=0,h=0,c=0,u=null,m="";if(r=t.data.getNumberOfRows(),0==r||1==r&&"0"==t.data.getFormattedValue(0,0))this.numRetries++,this.numRetries==this.retryLimit?(this.numRetries=0,console.log("Unable to load data for: "+this.instrument+" "+this.duration),e(!1)):$.event.trigger("retry",function(){s.loadHistoricalData(e)});else{this.x.length>0&&this.reset(),a=t.collectionData.endTime.clone(),m=t.collectionData.timeZoneOffset,this.collectionStartTime=t.collectionData.startTime,this.collectionEndTime=t.collectionData.endTime;for(var d=0;r>d;d++)if("Day"==this.duration||"Week"==this.duration){for(u=RiseVision.Common.Utility.adjustTime(new Date(t.data.getFormattedValue(d,2)),m),0==d&&(i=new Date(u),i.setHours(this.collectionStartTime.getHours()),i.setMinutes(this.collectionStartTime.getMinutes()),"Day"==this.duration&&this.collectionStartTime.clone().clearTime().isBefore(i.clone().clearTime())&&i.add({days:-1}),lastTradeDay=i.clone().clearTime(),a.setFullYear(i.getFullYear()),a.setMonth(i.getMonth()),a.setDate(i.getDate()),Date.equals(t.collectionData.startTime.clone().clearTime(),t.collectionData.endTime.clone().clearTime())||a.addDays(1),this.doCompare?(n=parseFloat(t.data.getFormattedValue(d,0)),l=parseFloat(t.data.getFormattedValue(d,3))):n=parseFloat(t.data.getFormattedValue(d,0)),h=parseFloat(t.data.getFormattedValue(d,1)));u.isAfter(i)&&(i.isBefore(a)||Date.equals(i,a));)c=this.addDataPoint({plotTime:i,tradeTime:u,lastTradeTime:i,endTime:a,collectionStartTime:t.collectionData.startTime.clone().clearTime(),collectionEndTime:t.collectionData.endTime.clone().clearTime(),closePrice:n,volume:h,percentChange:l,index:c});i.isAfter(a)&&(i=new Date(u),i.setHours(this.collectionStartTime.getHours()),i.setMinutes(this.collectionStartTime.getMinutes()),lastTradeDay=i.clone().clearTime(),a.setFullYear(i.getFullYear()),a.setMonth(i.getMonth()),a.setDate(i.getDate())),this.doCompare?(o=parseFloat(t.data.getFormattedValue(d,0)),l=parseFloat(t.data.getFormattedValue(d,3))):o=parseFloat(t.data.getFormattedValue(d,0)),c=this.addDataPoint({plotTime:i,tradeTime:u,lastTradeTime:i,endTime:a,collectionStartTime:t.collectionData.startTime.clone().clearTime(),collectionEndTime:t.collectionData.endTime.clone().clearTime(),closePrice:o,volume:parseFloat(t.data.getFormattedValue(d,1)),percentChange:l,index:c}),n=o,h=parseFloat(t.data.getFormattedValue(d,1))}else this.doCompare?(o=parseFloat(t.data.getFormattedValue(d,0)),this.percentChange.push(parseFloat(t.data.getFormattedValue(d,3)))):o=parseFloat(t.data.getFormattedValue(d,0)),this.ticks.push({date:RiseVision.Common.Utility.adjustTime(new Date(t.data.getFormattedValue(d,2)),m).getTime(),originalDate:new Date(t.data.getFormattedValue(d,2)).getTime(),close:o,volume:parseInt(t.data.getFormattedValue(d,1))}),this.x.push(d),this.volumeX.push(d),this.y.push(parseFloat(t.data.getFormattedValue(d,0))),this.volumeY.push(parseFloat(t.data.getFormattedValue(d,1)));if("Day"==this.duration||"Week"==this.duration){var p=new Date;if(p.clone().clearTime().isAfter(i.clone().clearTime())||Date.equals(p.clone().clearTime(),i.clone().clearTime()))for(;i.isBefore(a)&&i.isBefore(p);)this.ticks.push({date:i.getTime(),close:n,volume:h}),this.x.push(c),this.volumeX.push(c),this.y.push(n),this.volumeY.push(h),this.doCompare&&this.percentChange.push(l),i.addMilliseconds(this.interval),c++;else for(;i.isBefore(p);)this.ticks.push({date:i.getTime(),close:n,volume:h}),this.x.push(c),this.volumeX.push(c),this.y.push(n),this.volumeY.push(h),this.doCompare&&this.percentChange.push(l),i.addMilliseconds(this.interval),c++;this.startIndex=c}else this.startIndex=r;"Day"==this.duration&&this.addExtraTicks(t.collectionData,new Date(this.ticks[this.ticks.length-1].date)),this.numRetries=0,this.lastTradeTime=new Date(this.ticks[this.startIndex-1].date),this.plotRealTimeData(),e(!0)}},RiseVision.FinancialChart.PrimaryInstrument.prototype.addDataPoint=function(t){var e,i;return this.ticks.push({date:t.plotTime.getTime(),close:t.closePrice,volume:t.volume}),this.x.push(t.index),this.volumeX.push(t.index),this.y.push(t.closePrice),this.volumeY.push(t.volume),this.doCompare&&this.percentChange.push(t.percentChange),i=t.lastTradeTime.clone().clearTime(),t.lastTradeTime.addMilliseconds(this.interval),e=t.lastTradeTime.clone().clearTime(),Date.equals(i,e)||Date.equals(i,t.tradeTime.clone().clearTime())||(t.lastTradeTime.setFullYear(t.tradeTime.getFullYear()),t.lastTradeTime.setMonth(t.tradeTime.getMonth()),t.lastTradeTime.setDate(t.tradeTime.getDate())),t.endTime.setFullYear(t.lastTradeTime.getFullYear()),t.endTime.setMonth(t.lastTradeTime.getMonth()),t.endTime.setDate(t.lastTradeTime.getDate()),Date.equals(t.collectionStartTime,t.collectionEndTime)||t.endTime.addDays(1),t.index+1},RiseVision.FinancialChart.PrimaryInstrument.prototype.plotRealTimeData=function(){var t,e,i,a,s,r=this.realTimeData.getFormattedValue(0,11),o=!1,n=0;if(null!=this.realTimeData){if(s=parseFloat(this.realTimeData.getFormattedValue(0,2)),this.isLoading){if(null!=this.realTimeData.getFormattedValue(0,5)&&""!=this.realTimeData.getFormattedValue(0,5)&&null!=this.lastTradeTime){if(t=RiseVision.Common.Utility.adjustTime(new Date(this.realTimeData.getFormattedValue(0,5)),r).clearTime(),"Day"==this.duration)for(n=0;n<this.x.length;n++)this.historicCloseX.push(n),this.historicCloseY.push(parseFloat(this.realTimeData.getFormattedValue(0,6)));"Day"!=this.duration&&"Week"!=this.duration&&(Date.equals(t,this.lastTradeTime)||(this.ticks.push({date:RiseVision.Common.Utility.adjustTime(new Date(this.realTimeData.getFormattedValue(0,5)),r).getTime(),close:s,volume:parseInt(this.realTimeData.getFormattedValue(0,4))}),this.x.push(this.startIndex),this.volumeX.push(this.startIndex),this.y.push(s),this.volumeY.push(parseFloat(this.realTimeData.getFormattedValue(0,4))),this.doCompare&&this.percentChange.push(parseFloat(this.realTimeData.getFormattedValue(0,7))),this.startIndex++))}this.isLoading=!1,this.lastTradeTime=RiseVision.Common.Utility.adjustTime(new Date(this.realTimeData.getFormattedValue(0,5)),r)}else if(null!=this.realTimeData.getFormattedValue(0,5)&&""!=this.realTimeData.getFormattedValue(0,5)&&null!=this.lastTradeTime)if(t=RiseVision.Common.Utility.adjustTime(new Date(this.realTimeData.getFormattedValue(0,5)),r),i=t.clone().clearTime(),a=this.lastTradeTime.clone().clearTime(),Date.equals(i,a))if("Day"==this.duration||"Week"==this.duration){for(n=0;n<this.ticks.length;n++)if(e=new Date(this.ticks[n].date),e.isAfter(t)||Date.equals(e,t)){o=!0;break}if(o)for(Date.equals(t,this.lastTradeTime)||(this.volume=parseFloat(this.realTimeData.getFormattedValue(0,4))-this.accumulatedVolume);(e.isAfter(t)||Date.equals(e,t))&&e.isBefore(new Date);)"Day"==this.duration?n<this.ticks.length&&(this.ticks[n].close=s,this.ticks[n].volume=this.volume,this.y[n]=s,this.volumeY[n]=this.volume,this.doCompare&&(this.percentChange[n]=parseFloat(this.realTimeData.getFormattedValue(0,7)))):(this.ticks.push({date:RiseVision.Common.Utility.adjustTime(new Date(this.realTimeData.getFormattedValue(0,5)),r).getTime(),close:s,volume:parseFloat(this.realTimeData.getFormattedValue(0,4))-this.accumulatedVolume}),this.x.push(n),this.volumeX.push(n),this.y.push(s),this.volumeY.push(parseFloat(this.realTimeData.getFormattedValue(0,4))-this.accumulatedVolume),this.doCompare&&this.percentChange.push(parseFloat(this.realTimeData.getFormattedValue(0,7)))),this.lastTradeTime=t,e.addMilliseconds(this.interval),n++}else this.ticks[this.startIndex-1].date=new Date(this.realTimeData.getFormattedValue(0,5)).getTime(),this.ticks[this.startIndex-1].close=s,this.ticks[this.startIndex-1].volume=parseFloat(this.realTimeData.getFormattedValue(0,4))-this.accumulatedVolume,this.y[this.startIndex-1]=s,this.volumeY[this.startIndex-1]=parseFloat(this.realTimeData.getFormattedValue(0,4))-this.accumulatedVolume,this.doCompare&&(this.percentChange[this.startIndex-1]=parseFloat(this.realTimeData.getFormattedValue(0,7))),this.lastTradeTime=t;else this.isLoading=!0;this.accumulatedVolume=parseFloat(this.realTimeData.getFormattedValue(0,4))}else this.isLoading=!1},RiseVision.FinancialChart.PrimaryInstrument.prototype.getNumDayIntervals=function(t,e,i){var a=t.getTime(),s=e.getTime(),r=s-a;return Math.round(r/i)},RiseVision.FinancialChart.PrimaryInstrument.prototype.addExtraTicks=function(t,e){var i=0,a=new Date(e),s=new Date(t.endTime);i=this.getNumDayIntervals(t.startTime,t.endTime,this.interval);for(var r=this.startIndex;i>r&&(e.add({milliseconds:this.interval}),a=new Date(e),a.isBefore(s));r++)this.ticks.push({date:e.getTime(),close:0,volume:0}),this.x.push(r),this.volumeX.push(r),this.y.push(-1e3),this.volumeY.push(""),null!=this.percentChange&&this.percentChange.push(-1e3)};