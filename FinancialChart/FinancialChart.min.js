var RiseVision=RiseVision||{};RiseVision.FinancialChart={},RiseVision.FinancialChart.Settings={},RiseVision.FinancialChart.Controller={},RiseVision.FinancialChart.Chart={},RiseVision.FinancialChart.Settings=function(){this.settings=new RiseVision.Common.Settings},RiseVision.FinancialChart.Settings.prototype.initSettings=function(){var a=this;$(".stockSelector").on("click",function(a){chart.showStockSelector($(this).data("for"))}),$(".colorPicker").on("click",function(a){chart.showColorPicker($(this).data("for"))}),$(".fontSelector").on("click",function(a){chart.showFontSelector($(this).data("for"))}),$("#duration").on("change",function(a){"Day"==$(this).val()?$("li.previousClose").show():$("li.previousClose").hide()}),$("#showTitles").on("click",function(a){$(this).is(":checked")?$("li.title").show():$("li.title").hide()}),$("#showVolume").on("click",function(a){$(this).is(":checked")?$("li.volume").show():$("li.volume").hide()}),$("#showVolumeTitle").on("click",function(a){$(this).is(":checked")?$("li.volumeTitle").show():$("li.volumeTitle").hide()}),$("#showDuration").on("click",function(a){$(this).is(":checked")?$("li.duration").show():$("li.duration").hide()}),$("#showComparison").on("click",function(a){$(this).is(":checked")?($("li.comparison").show(),$("li.fill").hide()):($("li.comparison").hide(),$("li.fill").show())}),$("#showAxis").on("click",function(a){$(this).is(":checked")?$("li.axis").show():$("li.axis").hide()}),gadgets.rpc.call("","rscmd_getAdditionalParams",function(b){b&&(b=JSON.parse(b),$("#instrument").val(prefs.getString("instrument")),$("#disclaimerFont").val(prefs.getString("disclaimerFont")),$("#disclaimerLoc").val(prefs.getString("disclaimerLoc")),$("#acceptance").attr("checked",prefs.getBool("acceptance")),$("#duration").val(prefs.getString("duration")),$("#previousCloseColor").val(prefs.getString("previousCloseColor")),$("#showTitles").attr("checked",prefs.getBool("showTitles")),$("#titleDecimals").val(prefs.getString("titleDecimals")),$("#titleSign").val(prefs.getString("titleSign")),$("#showVolume").attr("checked",prefs.getBool("showVolume")),$("#showVolumeTitle").attr("checked",prefs.getBool("showVolumeTitle")),$("#volumeHeight").val(prefs.getInt("volumeHeight")),$("#volumeColor").val(prefs.getString("volumeColor")),$("#barWidth").val(""==prefs.getInt("barWidth")?2:prefs.getInt("barWidth")),$("#showDuration").attr("checked",prefs.getBool("showDuration")),$("#durButtonColor").val(prefs.getString("durButtonColor")),$("#durSelButtonColor").val(prefs.getString("durSelButtonColor")),$("#durButtonRadius").val(prefs.getString("durButtonRadius")),$("#durRotate").val(prefs.getInt("durRotate")),$("#durReturn").val(prefs.getInt("durReturn")),$("#showComparison").attr("checked",prefs.getBool("showComparison")),$("#compInstruments").val(prefs.getString("compInstruments")),$("#compNames").val(prefs.getString("compNames")),$("#compLineColor").val(prefs.getString("compLineColor")),$("#compButtonRadius").val(prefs.getString("compButtonRadius")),$("#compButtonColor").val(prefs.getString("compButtonColor")),$("#compSelButtonColor").val(prefs.getString("compSelButtonColor")),$("#compReturn").val(prefs.getInt("compReturn")),$("#showAxis").attr("checked",prefs.getBool("showAxis")),$("#axisDecimals").val(prefs.getString("axisDecimals")),$("#axisLineColor").val(prefs.getString("axisLineColor")),$("#gridLineColor").val(prefs.getString("gridLineColor")),$("#chartPlotLineColor").val(prefs.getString("chartPlotLineColor")),$("#chartFillColor").val(prefs.getString("chartFillColor")),$("#bgColor").val(prefs.getString("bgColor")),a.populateColor($("#previousCloseColor"),prefs.getString("previousCloseColor")),a.populateColor($("#volumeColor"),prefs.getString("volumeColor")),a.populateColor($("#durButtonColor"),prefs.getString("durButtonColor")),a.populateColor($("#durSelButtonColor"),prefs.getString("durSelButtonColor")),a.populateColor($("#compLineColor"),prefs.getString("compLineColor")),a.populateColor($("#compButtonColor"),prefs.getString("compButtonColor")),a.populateColor($("#compSelButtonColor"),prefs.getString("compSelButtonColor")),a.populateColor($("#axisLineColor"),prefs.getString("axisLineColor")),a.populateColor($("#gridLineColor"),prefs.getString("gridLineColor")),a.populateColor($("#chartPlotLineColor"),prefs.getString("chartPlotLineColor")),a.populateColor($("#chartFillColor"),prefs.getString("chartFillColor")),a.populateColor($("#bgColor"),prefs.getString("bgColor")),$("#title_font-style").text(b.title_font),$("#title_font-style").data("css",b["title_font-style"]),$("#volume_font-style").text(b.volume_font),$("#volume_font-style").data("css",b["volume_font-style"]),$("#durButton_font-style").text(b.durButton_font),$("#durButton_font-style").data("css",b["durButton_font-style"]),$("#compButton_font-style").text(b.compButton_font),$("#compButton_font-style").data("css",b["compButton_font-style"]),$("#axis_font-style").text(b.axis_font),$("#axis_font-style").data("css",b["axis_font-style"])),$("form ol li ol.drillDown li:visible:last").css({clear:"left",float:"left","margin-bottom":"10px"}),$("#duration").trigger("change"),$("#showTitles").triggerHandler("click"),$("#showVolume").triggerHandler("click"),$("#showVolumeTitle").triggerHandler("click"),$("#showDuration").triggerHandler("click"),$("#showComparison").triggerHandler("click"),$("#showAxis").triggerHandler("click"),$("#settings").show()})},RiseVision.FinancialChart.Settings.prototype.populateColor=function(a,b){a.val(b),a.css("background-color",b)},RiseVision.FinancialChart.Settings.prototype.showStockSelector=function(a){gadgets.rpc.call("","rscmd_openFinancialSelector",null,a,$("#"+a).val())},RiseVision.FinancialChart.Settings.prototype.showColorPicker=function(a){gadgets.rpc.call("","rscmd_openColorPicker",null,a,$("#"+a).val())},RiseVision.FinancialChart.Settings.prototype.showFontSelector=function(a){gadgets.rpc.call("","rscmd_openFontSelector",null,a,$("#"+a).data("css"))},RiseVision.FinancialChart.Settings.prototype.setStocks=function(a,b){$("#"+a).val(b)},RiseVision.FinancialChart.Settings.prototype.setColor=function(a,b){$("#"+a).val(b),$("#"+a).css("background-color",b)},RiseVision.FinancialChart.Settings.prototype.setFont=function(a,b,c){$("#"+a).data("css",b),$("#"+a).text(c)},RiseVision.FinancialChart.Settings.prototype.getSettings=function(){var a=!1,b=document.getElementsByClassName("errors")[0],c="",d=null;return $(".errors").empty(),a=!!chart.settings.validateNumeric($("#volumeHeight"),b,"Volume Height")||a,a=!!chart.settings.validateNumeric($("#barWidth"),b,"Bar Width")||a,a=!!chart.settings.validateNumeric($("#durButtonRadius"),b,"Duration Button Corner Radius")||a,a=!!chart.settings.validateNumeric($("#durRotate"),b,"Rotate Every")||a,a=!!chart.settings.validateNumeric($("#durReturn"),b,"Return to Default After")||a,a=!!chart.settings.validateNumeric($("#compButtonRadius"),b,"Comparison Button Corner Radius")||a,a=!!chart.settings.validateNumeric($("#compReturn"),b,"Chart Returns to Default")||a,a=!!chart.settings.validateRequired($("#instrument"),b,"Instrument")||a,$("#showComparison").is(":checked")&&(a=!!chart.settings.validateRequired($("#compInstruments"),b,"Comparative Instruments")||a),a?($(".errors").fadeIn(200).css("display","inline-block"),$("#wrapper").scrollTop(0),null):(c="up_instrument="+escape($("#instrument").val())+"&up_disclaimerFont="+$("#disclaimerFont").val()+"&up_disclaimerLoc="+$("#disclaimerLoc").val(),c+=$("#acceptance").is(":checked")?"&up_acceptance=true":"&up_acceptance=false",c+="&up_duration="+$("#duration").val()+"&up_previousCloseColor="+$("#previousCloseColor").val(),c+=$("#showTitles").is(":checked")?"&up_showTitles=true":"&up_showTitles=false",c+="&up_titleDecimals="+$("#titleDecimals").val()+"&up_titleSign="+$("#titleSign").val(),c+=$("#showVolume").is(":checked")?"&up_showVolume=true":"&up_showVolume=false",c+=$("#showVolumeTitle").is(":checked")?"&up_showVolumeTitle=true":"&up_showVolumeTitle=false",c+="&up_volumeHeight="+$("#volumeHeight").val()+"&up_volumeColor="+$("#volumeColor").val()+"&up_barWidth="+$("#barWidth").val(),c+=$("#showDuration").is(":checked")?"&up_showDuration=true":"&up_showDuration=false",c+="&up_durButtonColor="+$("#durButtonColor").val()+"&up_durSelButtonColor="+$("#durSelButtonColor").val()+"&up_durButtonRadius="+$("#durButtonRadius").val()+"&up_durRotate="+$("#durRotate").val()+"&up_durReturn="+$("#durReturn").val(),c+=$("#showComparison").is(":checked")?"&up_showComparison=true":"&up_showComparison=false",c+="&up_compInstruments="+escape($("#compInstruments").val())+"&up_compNames="+escape($("#compNames").val())+"&up_compLineColor="+$("#compLineColor").val()+"&up_compButtonRadius="+$("#compButtonRadius").val()+"&up_compButtonColor="+$("#compButtonColor").val()+"&up_compSelButtonColor="+$("#compSelButtonColor").val()+"&up_compReturn="+$("#compReturn").val(),c+=$("#showAxis").is(":checked")?"&up_showAxis=true":"&up_showAxis=false",c+="&up_axisDecimals="+$("#axisDecimals").val()+"&up_axisLineColor="+$("#axisLineColor").val()+"&up_gridLineColor="+$("#gridLineColor").val()+"&up_chartPlotLineColor="+$("#chartPlotLineColor").val()+"&up_chartFillColor="+$("#chartFillColor").val()+"&up_bgColor="+$("#bgColor").val(),d={params:c,additionalParams:JSON.stringify(chart.saveAdditionalParams())},$(".errors").css({display:"none"}),d)},RiseVision.FinancialChart.Settings.prototype.saveAdditionalParams=function(){var a={};return a.title_font=$("#title_font-style").text(),a["title_font-style"]=$("#title_font-style").data("css"),a.volume_font=$("#volume_font-style").text(),a["volume_font-style"]=$("#volume_font-style").data("css"),a.durButton_font=$("#durButton_font-style").text(),a["durButton_font-style"]=$("#durButton_font-style").data("css"),a.compButton_font=$("#compButton_font-style").text(),a["compButton_font-style"]=$("#compButton_font-style").data("css"),a.axis_font=$("#axis_font-style").text(),a["axis_font-style"]=$("#axis_font-style").data("css"),a},RiseVision.FinancialChart.Controller=function(a){this.displayID=a;var b=0,c={displayID:this.displayID,doCompare:this.doCompare(),callback:this.onDataLoaded};if(this.instrument=$.trim(prefs.getString("instrument")).split(",").slice(0,1)[0],this.isLoading=!0,this.isPlaying=!1,this.isDataLoaded=!1,this.isReloading=!1,this.isRefreshing=!1,this.isRetrying=!1,this.notPermissioned=!1,this.isDrawn=!1,this.numRetries=0,this.retryLimit=3,this.isSpinnerVisible=!1,this.isLabelFirst=!1,this.compareIndex=-1,this.numCallbacks=0,this.numReloads=0,this.totalReloads=0,this.refreshInterval=6e4,this.errorInterval=1e4,this.charts=[],this.compInstruments=[],this.compNames=[],this.compData=[],this.chartData={},this.titleData=null,this.showDuration=prefs.getBool("showDuration"),this.duration=prefs.getString("duration"),this.durations=[{type:"Day",description:"Day"},{type:"Week",description:"Week"},{type:"1M",description:"Month"},{type:"3M",description:"3 Months"},{type:"6M",description:"6 Months"},{type:"1Y",description:"1 Year"},{type:"5Y",description:"5 Years"}],this.realTime=new RiseVision.Common.Financial.RealTime(this.displayID,this.instrument),this.arrowURL="https://s3.amazonaws.com/risecontentlogos/financial/",this.url="https://contentfinancial2.appspot.com/reserve?id="+this.displayID+"&codes="+this.instrument,this.showDuration){for(var d=0;d<this.durations.length;d++)c.id=b,c.instrument=this.instrument,c.duration=this.durations[d].type,this.charts.push({primary:new RiseVision.FinancialChart.PrimaryInstrument(c)}),this.createDurationButton(this.durations[d]),this.durations[d].type==prefs.getString("duration")&&(this.currentIndex=d,this.currentChart=this.charts[this.currentIndex]),b++;$("#durations").show()}else c.id=b,c.instrument=this.instrument,c.duration=prefs.getString("duration"),this.charts.push({primary:new RiseVision.FinancialChart.PrimaryInstrument(c)}),this.currentIndex=0,this.currentChart=this.charts[this.currentIndex],b++;if(prefs.getBool("showComparison")){var e=prefs.getString("compInstruments").split(","),f=[];prefs.getString("compNames")&&(f=prefs.getString("compNames").split(",")),e=e.slice(0,3),f=f.slice(0,3),this.url+="|"+e.join("|");for(var d=0;d<e.length;d++)this.compData[d]=new RiseVision.Common.Financial.RealTime(this.displayID,$.trim(e[d]));for(var d=0;d<this.charts.length;d++)for(var g=0;g<e.length;g++)0==g&&(this.charts[d].comparative=[]),this.charts[d].comparative.push(new RiseVision.FinancialChart.Instrument({id:b,displayID:this.displayID,instrument:$.trim(e[g]),duration:this.charts[d].primary.getDuration(),name:f[g],callback:this.onDataLoaded})),b++;this.createInstrumentButtons(e)}switch(prefs.getInt("axisDecimals")){case 1:this.factor=10;break;case 2:this.factor=100;break;case 3:this.factor=1e3;break;case 4:this.factor=1e4;break;default:this.factor=1}this.setTotalCallbacks(),this.reserveInstruments(),$(document).bind("retry",function(a,b){controller.startRetryTimer(b)})},RiseVision.FinancialChart.Controller.prototype.reserveInstruments=function(){var a=this;gadgets.io.makeRequest(encodeURI(this.url),function(a){},{}),setTimeout(function(){a.reserveInstruments()},864e5)},RiseVision.FinancialChart.Controller.prototype.stopRotation=function(){clearTimeout(this.rotateTimer)},RiseVision.FinancialChart.Controller.prototype.setInstrument=function(a,b){if(!this.isRefreshing){if(this.resumeRotation=b,b||clearTimeout(this.rotateTimer),this.isRetrying&&(clearInterval(this.retryTimer),this.isReloading=!1,this.isRetrying=!1),this.instrument==a)return;if(this.instrument=a,!this.isReloading){clearTimeout(this.refreshTimer),clearTimeout(this.inactivityTimer),this.chartData={},this.isReloading=!0,this.currentIndex=0,this.realTime.setInstruments(a);for(var c=0;c<this.charts.length;c++)this.charts[c].primary.setInstrument(a);this.setTotalCallbacks(),this.load()}}},RiseVision.FinancialChart.Controller.prototype.setDuration=function(a){if(!this.isReloading){clearTimeout(this.refreshTimer),clearTimeout(this.inactivityTimer),clearTimeout(this.rotateTimer),this.isReloading=!0,this.duration=a;for(var b=0;b<this.charts.length;b++)if(this.charts[b].primary.setDuration(a),null!=this.charts[b].comparative)for(var c=0;c<this.charts[b].comparative.length;c++)this.charts[b].comparative[c].setDuration(a);this.load()}},RiseVision.FinancialChart.Controller.prototype.setTotalCallbacks=function(){this.totalCallbacks=1+this.compData.length;for(var a=0;a<this.charts.length;a++)if(this.charts[a].primary.getIsLoading()&&this.totalCallbacks++,null!=this.charts[a].comparative)for(var b=0;b<this.charts[a].comparative.length;b++)this.charts[a].comparative[b].getIsLoading()&&this.totalCallbacks++},RiseVision.FinancialChart.Controller.prototype.createDurationButton=function(a){var b=this,c=$("<a href='#' class='duration durButton_font-style'>");c.text(a.description),c.data("type",a.type),a.type==prefs.getString("duration")&&c.addClass("selected"),c.on("click",function(a){a.preventDefault(),b.isLoading||b.isReloading||(clearTimeout(b.inactivityTimer),clearTimeout(b.rotateTimer),b.showChart($(this).data("type")),prefs.getInt("durReturn")>0&&(b.inactivityTimer=setTimeout(function(){b.currentIndex=b.currentIndex+1>=b.durations.length?0:b.currentIndex+1,b.currentChart=b.charts[b.currentIndex],b.showChart($(".duration").eq(b.currentIndex).data("type")),b.startRotateTimer()},1e3*prefs.getInt("durReturn"))))}),$("#durations").append(c)},RiseVision.FinancialChart.Controller.prototype.createInstrumentButtons=function(a){var b=this;if(this.doCompare()){for(var c=0;c<a.length;c++)$button=$("<a href='#' class='button compButton_font-style'>"),$button.on("click",function(a){var c=$(this).index();b.currentChart.comparative[c];a.preventDefault(),clearTimeout(b.compReturnTimer),$(".button").removeClass("selected"),$(this).addClass("selected"),b.compareIndex=c,b.setChartData(!0),b.drawPriceChart(),prefs.getInt("compReturn")>0&&(b.compReturnTimer=setTimeout(function(){$(".button").removeClass("selected"),b.compareIndex=-1,b.setChartData(!0),b.drawPriceChart()},1e3*prefs.getInt("compReturn")))}),$("#buttons").append($button);$("#buttons").show()}},RiseVision.FinancialChart.Controller.prototype.getAdditionalParams=function(a,b){if("additionalParams"==a&&b){var c=document.createElement("style");b=JSON.parse(b),b["title_font-style"]&&c.appendChild(document.createTextNode(b["title_font-style"])),b["volume_font-style"]&&c.appendChild(document.createTextNode(b["volume_font-style"])),b["durButton_font-style"]&&c.appendChild(document.createTextNode(".duration:active, .duration:visited, "+b["durButton_font-style"])),b["compButton_font-style"]&&c.appendChild(document.createTextNode(".button:active, .button:visited, "+b["compButton_font-style"])),b["axis_font-style"]&&c.appendChild(document.createTextNode(".flotr-grid-label, "+b["axis_font-style"])),document.getElementsByTagName("head")[0].appendChild(c)}controller.load()},RiseVision.FinancialChart.Controller.prototype.load=function(){if(this.isDataLoaded=!1,this.isLoading)for(var b=0;b<this.charts.length;b++)if(this.charts[b].primary.reset(),null!=this.charts[b].comparative)for(var c=0;c<this.charts[b].comparative.length;c++)this.charts[b].comparative[c].reset();this.loadRealTimeData()},RiseVision.FinancialChart.Controller.prototype.loadRealTimeData=function(){var a=this;this.realTime.getData(["name","lastPrice","netChange","accumulatedVolume","tradeTime","historicClose","percentChange"],!1,!1,function(b){a.onRealTimeDataLoaded(b)})},RiseVision.FinancialChart.Controller.prototype.onRealTimeDataLoaded=function(a){var b=this;if(null!=a)if("..."==a.getFormattedValue(0,1))this.numRetries++,this.numRetries==this.retryLimit?($("#priceChart").spinner("remove"),this.isSpinnerVisible=!1,this.numRetries=0,this.onDataLoaded(!1),this.getRemainingData(!1),console.log("Unable to load real-time data for: "+this.instrument+" "+this.duration)):$.event.trigger("retry",function(){b.loadRealTimeData()});else{"N/P"==a.getFormattedValue(0,1)&&(this.notPermissioned=!0),null!=a&&(this.titleData=a),this.numRetries=0;for(var c=0,d=this.charts.length;c<d;c++)this.charts[c].primary.setRealTimeData(a);this.updateTitles(),this.isLoading&&(this.initUI(),$("#disclaimer, #buttons, #title, #priceChart, #durations, #volumeTitle, #volumeChart").removeClass("hidden")),this.onDataLoaded(!0),this.getRemainingData(!0)}else this.getRemainingData(!1)},RiseVision.FinancialChart.Controller.prototype.getRemainingData=function(a){if(a)if((this.isLoading||this.isReloading)&&(this.isSpinnerVisible||($("#priceChart").spinner({img:"https://preview.risevision.com/images/ajax-loader-circle-notext.gif",width:100,height:100,position:"center"}),this.isSpinnerVisible=!0),this.isLoading&&readyEvent()),0==this.compData.length)this.charts.length>0&&this.updatePrimaryChart(0,this.onPrimaryDataLoaded);else{this.compDataLoaded=0;for(var c=0;c<this.compData.length;c++)this.loadComparativeData(c)}else this.isDataLoaded=!0,this.isRefreshing=!1,this.startRefreshTimer()},RiseVision.FinancialChart.Controller.prototype.loadComparativeData=function(a){var b=this;this.compData[a].getData(["percentChange","tradeTime","name"],!1,!1,function(c){b.onComparativeDataLoaded(c,a)})},RiseVision.FinancialChart.Controller.prototype.onComparativeDataLoaded=function(a,b){var c=this,d=!1;if(null!=a)if(null==a.getFormattedValue(0,2))this.numRetries++,this.numRetries==this.retryLimit?($("#priceChart").spinner("remove"),this.isSpinnerVisible=!1,this.numRetries=0,this.onDataLoaded(!1),this.onCompRealTimeDataLoaded(!1),console.log("Unable to load comparative real-time data.")):$.event.trigger("retry",function(){c.loadComparativeData(b)});else{this.numRetries=0;for(var e=0;e<this.charts.length;e++)if("N/P"==a.getFormattedValue(0,0)){if(this.isLoading){$("#error").text("One or more of the comparative instruments requires a Premium license. Contact sales@risedisplay.com for licensing options.").show(),d=!0;break}}else this.charts[e].comparative[b].setRealTimeData(a);d?(this.isSpinnerVisible&&($("#priceChart").spinner("remove"),this.isSpinnerVisible=!1),$("#buttons, #priceChart, #durations").hide()):(this.onDataLoaded(!0),this.onCompRealTimeDataLoaded(!0))}else this.onDataLoaded(!0),this.onCompRealTimeDataLoaded(!0)},RiseVision.FinancialChart.Controller.prototype.onCompRealTimeDataLoaded=function(a){this.compDataLoaded++,this.compDataLoaded==this.compData.length&&this.charts.length>0&&this.updatePrimaryChart(0,this.onPrimaryDataLoaded)},RiseVision.FinancialChart.Controller.prototype.onPrimaryDataLoaded=function(){for(var a=1;a<this.charts.length;a++)this.updatePrimaryChart(a,null)},RiseVision.FinancialChart.Controller.prototype.updatePrimaryChart=function(a,b){var c=this;if(this.charts[a].primary.getIsLoading())this.charts[a].primary.reset(),this.charts[a].primary.loadHistoricalData(function(d){if(c.onDataLoaded(),null!=c.charts[a].comparative)if(0==a)for(var e=0,f=0;f<c.charts[a].comparative.length;f++)c.updateComparativeCharts(a,f,function(){e++,e==c.charts[a].comparative.length&&null!=b&&b.call(c)});else for(var f=0;f<c.charts[a].comparative.length;f++)c.updateComparativeCharts(a,f,null);else null!=b&&b.call(c)});else if(this.charts[a].primary.plotRealTimeData(),null!=c.charts[a].comparative)if(0==a)for(var d=0,e=0;e<c.charts[a].comparative.length;e++)c.updateComparativeCharts(a,e,function(){d++,d==c.charts[a].comparative.length&&null!=b&&b.call(c)});else for(var e=0;e<c.charts[a].comparative.length;e++)c.updateComparativeCharts(a,e,null);else null!=b&&b.call(c)},RiseVision.FinancialChart.Controller.prototype.updateComparativeCharts=function(a,b,c){var d=this;this.charts[a].comparative[b].getIsLoading()?(this.charts[a].comparative[b].reset(),this.charts[a].comparative[b].loadHistoricalData(this.charts[a].primary.getTicks(),function(e){d.isLoading&&($(".button").eq(b).text(d.charts[a].comparative[b].name),$(".button").eq(b).css("display","inline-block")),d.onDataLoaded(),null!=c&&c.call(d)})):(this.charts[a].comparative[b].plotRealTimeData(),null!=c&&c.call(d))},RiseVision.FinancialChart.Controller.prototype.onDataLoaded=function(){if(this.numCallbacks++,this.numCallbacks==this.totalCallbacks){if(this.isSpinnerVisible&&($("#priceChart").spinner("remove"),this.isSpinnerVisible=!1),this.isDataLoaded=!0,this.charts[0].primary.setIsUpdated(!1),null!=this.charts[0].comparative)for(var a=0;a<this.charts[0].comparative.length;a++)this.charts[0].comparative[a].setIsUpdated(!1);this.isLoading?(this.isLoading=!1,this.setChartData(!1),this.isPlaying&&this.drawChart()):this.isReloading?this.isPlaying&&(this.isDrawn?(this.currentChart=this.charts[this.currentIndex],this.showDuration?this.showChart($(".duration").eq(this.currentIndex).data("type")):this.showChart(this.duration),this.updateTitles(),this.startRefreshTimer(),this.startRotateTimer()):(this.setChartData(!1),this.drawChart())):(this.setChartData(!0),this.refresh(),this.isPlaying&&this.isDrawn&&this.startRotateTimer()),this.numCallbacks=0,this.isReloading=!1}},RiseVision.FinancialChart.Controller.prototype.refresh=function(){this.drawPriceChart(),prefs.getBool("showVolume")&&this.drawVolumeChart(),this.isRefreshing=!1,this.startRefreshTimer()},RiseVision.FinancialChart.Controller.prototype.setChartData=function(a){var b,c,d,e,f=!prefs.getBool("showComparison");f&&("transparent"==prefs.getString("chartFillColor")||""==prefs.getString("chartFillColor")?(f=!1,c=""):(c=prefs.getBool("showComparison")?"":prefs.getString("chartFillColor"),(e=/rgba\(\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})\s*,\s*([0-9]+(?:\.[0-9]+)?)\s*\)/.exec(c))&&(d=parseFloat(e[4])))),a?(b=this.compareIndex>=0?this.currentChart.primary.getPercentChange():this.currentChart.primary.getY(),this.chartData.price=[],this.chartData.price.push({data:[this.currentChart.primary.getX(),b],color:prefs.getString("chartPlotLineColor"),"lite-lines":{lineWidth:3,fill:f,fillColor:c,fillOpacity:d}}),this.compareIndex>=0?this.chartData.price.push({data:[this.currentChart.comparative[this.compareIndex].getX(),this.currentChart.comparative[this.compareIndex].getY()],color:prefs.getString("compLineColor")}):this.currentChart.primary.getHistoricCloseX().length>0&&this.currentChart.primary.getHistoricCloseY().length>0&&this.chartData.price.push({data:[this.currentChart.primary.getHistoricCloseX(),this.currentChart.primary.getHistoricCloseY()],color:prefs.getString("previousCloseColor"),"lite-lines":{lineStyle:"dashed"}})):(this.chartData.price=[{data:[this.currentChart.primary.getX(),this.currentChart.primary.getY()],color:prefs.getString("chartPlotLineColor"),"lite-lines":{lineWidth:3,fill:f,fillColor:c,fillOpacity:d}}],this.currentChart.primary.getHistoricCloseX().length>0&&this.currentChart.primary.getHistoricCloseY().length>0&&this.chartData.price.push({data:[this.currentChart.primary.getHistoricCloseX(),this.currentChart.primary.getHistoricCloseY()],color:prefs.getString("previousCloseColor"),"lite-lines":{lineStyle:"dashed"}})),this.chartData.summaryTicks=this.currentChart.primary.getTicks(),this.chartData.volume=[this.currentChart.primary.getVolumeX(),this.currentChart.primary.getVolumeY()]},RiseVision.FinancialChart.Controller.prototype.updateTitles=function(){var a=parseFloat(this.titleData.getValue(0,2)),b=parseFloat(this.titleData.getValue(0,3)),c=parseFloat(this.titleData.getValue(0,4)),d=prefs.getInt("titleDecimals"),e=prefs.getString("titleSign"),f="Last ";$("#instrument").text(this.titleData.getFormattedValue(0,1)),$("#last").text(f+RiseVision.Common.Utility.addCommas(a.toFixed(d))),"none"==e?($("#last").text(f+RiseVision.Common.Utility.addCommas(Math.abs(a).toFixed(d))),$("#changeValue").text(RiseVision.Common.Utility.addCommas(Math.abs(b).toFixed(d)))):"minus"==e?$("#changeValue").text(RiseVision.Common.Utility.addCommas(b.toFixed(d))):"plusMinus"==e?(a>0&&$("#last").text(f+"+"+RiseVision.Common.Utility.addCommas(a.toFixed(d))),b>0?$("#changeValue").text("+"+RiseVision.Common.Utility.addCommas(ge.toFixed(d))):$("#changeValue").text(RiseVision.Common.Utility.addCommas(b.toFixed(d)))):"parentheses"==e?(a<0&&$("#last").text(f+"("+RiseVision.Common.Utility.addCommas(Math.abs(a).toFixed(d))+")"),b<0?$("#changeValue").text("("+RiseVision.Common.Utility.addCommas(Math.abs(b).toFixed(d))+")"):$("#changeValue").text(RiseVision.Common.Utility.addCommas(b.toFixed(d)))):"arrow"==e&&($("#changeValue").text(RiseVision.Common.Utility.addCommas(Math.abs(b).toFixed(d))),b<0?$("#arrow").css("background-image","url('"+this.arrowURL+"animated-red-arrow.gif')"):$("#arrow").css("background-image","url('"+this.arrowURL+"animated-green-arrow.gif')")),prefs.getBool("showVolumeTitle")&&$("#volumeTitle").text("Accumulated Volume "+RiseVision.Common.Utility.addCommas(c))},RiseVision.FinancialChart.Controller.prototype.initUI=function(){var b,c,d,e=prefs.getString("disclaimerLoc");$("#container").width(prefs.getString("rsW")),$("#container").height(prefs.getString("rsH")),"bottomRight"!=e&&"topRight"!=e||$("#disclaimer").addClass("right"),$("#disclaimer").css("font-family",prefs.getString("disclaimerFont")),"bottomRight"!=e&&"bottomLeft"!=e||$("#disclaimer").appendTo("#container"),$("#disclaimer").show(),prefs.getBool("showTitles")||$("#title").hide(),b=prefs.getBool("showVolume")?this.doCompare()?"#priceChart { height: "+($("#container").height()-$("#disclaimer").outerHeight(!0)-$("#buttons").outerHeight(!0)-$("#instrument").outerHeight(!0)-$("#durations").outerHeight(!0)-$("#volumeTitle").outerHeight(!0)-prefs.getInt("volumeHeight")/100*$("#container").height())+"px; }":"#priceChart { height: "+($("#container").height()-$("#disclaimer").outerHeight(!0)-$("#instrument").outerHeight(!0)-$("#durations").outerHeight(!0)-$("#volumeTitle").outerHeight(!0)-prefs.getInt("volumeHeight")/100*$("#container").height())+"px; }":this.doCompare()?"#priceChart { height: "+($("#container").height()-$("#disclaimer").outerHeight(!0)-$("#buttons").outerHeight(!0)-$("#instrument").outerHeight(!0)-$("#durations").outerHeight(!0)-$("#priceChart").outerHeight(!0))+"px; }":"#priceChart { height: "+($("#container").height()-$("#disclaimer").outerHeight(!0)-$("#instrument").outerHeight(!0)-$("#durations").outerHeight(!0)-$("#priceChart").outerHeight(!0))+"px; }",d=document.createElement("style"),d.appendChild(document.createTextNode(b)),document.getElementsByTagName("head")[0].appendChild(d),prefs.getBool("showVolume")?(d=document.createElement("style"),c=".envision-finance-volume .envision-component { height: "+(prefs.getInt("volumeHeight")/100*$("#container").height()-parseInt($("#priceChart").css("margin-bottom"))-2)+"px !important; }",d.appendChild(document.createTextNode(c)),document.getElementsByTagName("head")[0].appendChild(d)):$(".volume").hide(),$("#arrow").width($("#instrument").height()),$("#arrow").height($("#instrument").height())},RiseVision.FinancialChart.Controller.prototype.drawChart=function(){prefs.getString("disclaimerLoc");this.drawPriceChart(),prefs.getBool("showVolume")&&this.drawVolumeChart(),this.startRefreshTimer(),this.startRotateTimer()},RiseVision.FinancialChart.Controller.prototype.drawPriceChart=function(){var a=this,c=(this.chartData.summaryTicks,{container:$("#priceChart"),data:{price:this.chartData.price,volume:this.chartData.volume},defaults:{price:{config:{xaxis:{showLabels:prefs.getBool("showAxis"),ticks:prefs.getBool("showAxis")?this.getTicks():null},yaxis:{showLabels:prefs.getBool("showAxis"),min:this.calculateMin(),max:this.calculateMax(),tickDecimals:prefs.getInt("axisDecimals")},grid:{horizontalLines:!0,verticalLines:!0,backgroundColor:null,tickColor:prefs.getString("gridLineColor")}}}},yTickFormatter:function(b){return b=RiseVision.Common.Utility.addCommas(b),a.compareIndex>=0?b+"%":b}});this.isDrawn?($(".envision-finance-price").unbind(),$(".envision-finance-price").remove(),this.finance.vis.destroy(),this.finance.vis=null,this.finance.price=null,this.finance=null,this.finance=new envision.templates.PriceChart(c)):(this.finance=new envision.templates.PriceChart(c),$(".envision-finance-price").css("border-color",prefs.getString("axisLineColor")),this.isDrawn=!0),$(".envision-finance-price").css("border-color",prefs.getString("axisLineColor")),this.isLabelFirst&&($(".envision-finance-price .flotr-grid-label-x:first-child").addClass("importantRule"),this.isLabelFirst=!1)},RiseVision.FinancialChart.Controller.prototype.drawVolumeChart=function(){for(var b=!0,d=(this.chartData.summaryTicks,{container:$("#volumeChart"),data:{price:this.chartData.price,volume:this.chartData.volume},defaults:{volume:{config:{whiskers:{color:prefs.getString("volumeColor"),lineWidth:prefs.getInt("barWidth")},grid:{tickColor:prefs.getString("gridLineColor")}}}},yTickFormatter:function(a){return a=parseInt(a),isNaN(a)?"":0==a?"":a/1e6+"M"}}),e=0;e<this.chartData.volume.length;e++)if(0==this.chartData.volume[e].length){b=!1;break}this.volume&&(this.volume.vis.destroy(),this.volume=null),b&&(this.volume=new envision.templates.VolumeChart(d)),$(".envision-finance-volume").css("border-color",prefs.getString("axisLineColor"))},RiseVision.FinancialChart.Controller.prototype.getTicks=function(){return"Day"==this.duration?this.getDailyTicks():"Week"==this.duration?this.getWeeklyTicks():"1M"==this.duration||"3M"==this.duration?this.getMonthlyTicks():"6M"==this.duration?this.get6MonthTicks():"1Y"==this.duration||"5Y"==this.duration?this.getYearlyTicks():void 0},RiseVision.FinancialChart.Controller.prototype.getDailyTicks=function(){var d,e,f,g,a=this.chartData.summaryTicks.length,b=new Date(this.charts[0].primary.collectionStartTime),c=new Date(this.charts[0].primary.collectionEndTime),h=[],i=0;if(null!=this.charts[0].primary.collectionStartTime&&null!=this.charts[0].primary.collectionEndTime)for(;b.isBefore(c);){if(g=b.getMinutes(),0==g){for(0==i&&(this.isLabelFirst=!0),h.push([i,b.toString("HH:mm")]),e=new Date(b.getTime()),e=e.addHours(2),b.addMinutes(5);b.isBefore(c);){if(Date.equals(b,e)){for(;i<a;i++){if(d=new Date(this.chartData.summaryTicks[i].date),f=Date.equals(new Date(this.charts[0].primary.collectionStartTime).clearTime(),Date.today())?new Date(d):new Date(b),
    f.setHours(new Date(b).getHours()),f.setMinutes(new Date(b).getMinutes()),f.setSeconds(0),d.equals(f)){h.push([i,e.toString("HH:mm")]);break}if(d.isAfter(f)){h.push([i-1,e.toString("HH:mm")]);break}}e=e.addHours(2)}b.addMinutes(5)}break}b.addMinutes(5),i++}return h},RiseVision.FinancialChart.Controller.prototype.getWeeklyTicks=function(){for(var a=this.chartData.summaryTicks.length,b=null,c=null,d=[],e=0;e<a;e++)b=new Date(this.chartData.summaryTicks[e].date).clearTime(),c&&b?Date.equals(b,c)||b.getDay()>=1&&b.getDay()<=5&&d.push([e,b.toString("ddd MMM d")]):b.getDay()>=1&&b.getDay()<=5&&d.push([e,b.toString("ddd MMM d")]),c=b;return this.isLabelFirst=!0,d.length>5&&d.splice(0,d.length-5),d},RiseVision.FinancialChart.Controller.prototype.getMonthlyTicks=function(){for(var c,a=this.chartData.summaryTicks.length,b=[],d=0;d<a;d++)c=new Date(this.chartData.summaryTicks[d].originalDate),5==c.getDay()&&(d<=1&&(this.isLabelFirst=!0),b.push([d,c.toString("MMM d")]));return b},RiseVision.FinancialChart.Controller.prototype.get6MonthTicks=function(){for(var c,d,e,a=this.chartData.summaryTicks.length,b=[],f=0;f<a;f++)e=new Date(this.chartData.summaryTicks[f].date),0==f?(b.push([f,e.toString("MMM")]),d=e.getMonth()):(c=e.getMonth(),c!=d&&b.push([f,e.toString("MMM")]),d=c);return this.isLabelFirst=!0,b},RiseVision.FinancialChart.Controller.prototype.getYearlyTicks=function(){for(var c,d,e,a=this.chartData.summaryTicks.length,b=[],f=0;f<a;f++)e=new Date(this.chartData.summaryTicks[f].date),c=e.getMonth(),0==c?c!=d&&(0==f&&(this.isLabelFirst=!0),b.push([f,e.toString("yyyy")])):c%3==0&&c!=d&&(0==f&&(this.isLabelFirst=!0),b.push([f,e.toString("MMM")])),d=c;return b},RiseVision.FinancialChart.Controller.prototype.calculateMin=function(){var a=this.getInstrumentValues();return this.doCompare()?Math.floor(Math.min.apply(null,a)*this.factor)/this.factor:(this.currentChart.primary.getHistoricCloseY().length>0&&a.push(parseFloat(this.currentChart.primary.getHistoricCloseY()[0])),Math.floor(Math.min.apply(null,a)*this.factor)/this.factor)},RiseVision.FinancialChart.Controller.prototype.calculateMax=function(){var a=this.getInstrumentValues();return this.doCompare()?Math.ceil(Math.max.apply(null,a)*this.factor)/this.factor:(this.currentChart.primary.getHistoricCloseY().length>0&&a.push(parseFloat(this.currentChart.primary.getHistoricCloseY()[0])),Math.ceil(Math.max.apply(null,a)*this.factor)/this.factor)},RiseVision.FinancialChart.Controller.prototype.getInstrumentValues=function(){var a,b,c,d=[];for(a=0;a<this.chartData.price.length;a++)for(c=this.chartData.price[a].data[1].length,b=0;b<c;b++)this.chartData.price[a].data[1][b]!=-1e3&&d.push(parseFloat(this.chartData.price[a].data[1][b]));return d},RiseVision.FinancialChart.Controller.prototype.showChart=function(a){var b=0;$(".duration").each(function(c){if($(this).data("type")==a)return b=c,!1}),this.charts[b].primary.isLoading&&"Day"!=this.charts[b].primary.duration||($(".duration").removeClass("selected"),$(".duration").eq(b).addClass("selected"),this.currentIndex=b,this.currentChart=this.charts[this.currentIndex],this.duration=a,this.setChartData(!0),this.drawPriceChart(),prefs.getBool("showVolume")&&this.drawVolumeChart())},RiseVision.FinancialChart.Controller.prototype.startRetryTimer=function(a){var b=this;this.isRetrying?this.callbacks.push(a):(this.callbacks=[a],this.isRetrying=!0,this.countdown=this.errorInterval/1e3,this.retryTimer=setInterval(function(){if(b.countdown--,0==b.countdown){b.isRetrying=!1,clearInterval(b.retryTimer);for(var a=0;a<b.callbacks.length;a++)b.callbacks[a]();b.callbacks=[]}},1e3))},RiseVision.FinancialChart.Controller.prototype.startRotateTimer=function(){for(var a=this,b=!1,c=this.currentIndex;c<this.charts.length;c++)if(!this.charts[c].primary.isLoading){b=!0;break}b?this.showDuration&&prefs.getInt("durRotate")>0&&(clearTimeout(this.rotateTimer),this.rotateTimer=setTimeout(function(){a.onRotateTimerExpired.call(a)},1e3*prefs.getInt("durRotate"))):this.showDuration&&prefs.getInt("durRotate")>0&&(clearTimeout(this.rotateTimer),this.rotateTimer=setTimeout(function(){a.isReloading||doneEvent()},1e3*prefs.getInt("durRotate")))},RiseVision.FinancialChart.Controller.prototype.onRotateTimerExpired=function(){!this.isReloading&&this.resumeRotation&&(this.currentIndex=this.currentIndex+1>=this.durations.length?0:this.currentIndex+1,this.currentChart=this.charts[this.currentIndex],0==this.currentIndex?doneEvent():(this.showChart($(".duration").eq(this.currentIndex).data("type")),this.startRotateTimer()))},RiseVision.FinancialChart.Controller.prototype.startRefreshTimer=function(){var a=this;this.notPermissioned||(clearTimeout(this.refreshTimer),this.refreshTimer=setTimeout(function(){a.isRefreshing=!0,a.setTotalCallbacks(),a.load()},this.refreshInterval))},RiseVision.FinancialChart.Controller.prototype.doCompare=function(){return!!prefs.getBool("showComparison")&&prefs.getString("compInstruments").split(",").length>0},RiseVision.FinancialChart.Controller.prototype.play=function(){this.resumeRotation=!0,!this.isDrawn&&!this.isRetrying&&this.isDataLoaded&&$("#container:visible").length>0?this.drawChart():!this.isDrawn||this.isRetrying||this.isReloading||this.startRotateTimer(),this.isPlaying=!0},RiseVision.FinancialChart.Controller.prototype.pause=function(){var b=this;clearTimeout(this.rotateTimer),clearTimeout(this.inactivityTimer),this.isDrawn&&this.showDuration&&0==this.currentIndex&&(clearTimeout(b.pauseTimer),b.pauseTimer=setTimeout(function(){b.showChart($(".duration").eq(b.currentIndex).data("type"))},500)),this.isPlaying=!1},RiseVision.FinancialChart.Instrument={},RiseVision.FinancialChart.Instrument=function(a){new gadgets.Prefs;a&&(this.instrument=a.instrument,this.id=a.id,this.displayID=a.displayID,this.duration=a.duration,this.name=a.name,this.callback=a.callback,this.retryLimit=3,this.historical=new RiseVision.Common.Financial.Historical(a.displayID,a.instrument,a.duration),this.reset(),"Day"==a.duration?this.interval=3e5:"Week"==a.duration&&(this.interval=18e5))},RiseVision.FinancialChart.Instrument.prototype.reset=function(){this.x=[],this.y=[],this.isLoading=!0,this.startIndex=0,this.numRetries=0},RiseVision.FinancialChart.Instrument.prototype.getIsLoading=function(){return this.isLoading},RiseVision.FinancialChart.Instrument.prototype.getX=function(){return this.x},RiseVision.FinancialChart.Instrument.prototype.getY=function(){return this.y},RiseVision.FinancialChart.Instrument.prototype.getDuration=function(){return this.duration},RiseVision.FinancialChart.Instrument.prototype.setInstrument=function(a){this.reset(),this.historical.setInstrument(a)},RiseVision.FinancialChart.Instrument.prototype.setRealTimeData=function(a){this.realTimeData=a},RiseVision.FinancialChart.Instrument.prototype.setIsUpdated=function(a){this.historical.setIsUpdated(a)},RiseVision.FinancialChart.Instrument.prototype.setDuration=function(a){this.reset(),this.duration=a,this.historical.setDuration(a),"Day"==a?this.interval=3e5:"Week"==a&&(this.interval=18e5)},RiseVision.FinancialChart.Instrument.prototype.loadHistoricalData=function(a,b){var c=this;this.ticks=a,this.historical.getHistoricalData(["percentChange","tradeTime"],function(a){null!=a?c.save(a,b):b(!0)})},RiseVision.FinancialChart.Instrument.prototype.save=function(a,b){var h,i,j,c=this,d=a.data.getNumberOfRows(),e=a.collectionData.timeZoneOffset,f=0,g=0;if(0==d||1==d&&(null==a.data.getFormattedValue(0,1)||""==a.data.getFormattedValue(0,1)))this.numRetries++,this.numRetries==this.retryLimit?(this.numRetries=0,console.log("Unable to load data for: "+this.instrument+" "+this.duration),b(!1)):$.event.trigger("retry",function(){c.loadHistoricalData(c.ticks,b)});else{for(var k=0;k<this.ticks.length;k++)f<d?(i=new Date(this.ticks[k].date),h=RiseVision.Common.Utility.adjustTime(new Date(a.data.getFormattedValue(f,1)),e),y=parseFloat(a.data.getValue(f,0)),this.x.push(g),this.y.push(y),this.startIndex++,g++,(Date.equals(h,i)||h.isBefore(i))&&f++):"Day"!=this.duration&&"Week"!=this.duration||(j=new Date,h.isBefore(j)?(this.x.push(g),this.y.push(y),this.startIndex++,h.addMilliseconds(this.interval),g++):(this.x.push(g),this.y.push(-1e3),g++));this.numRetries=0,this.ticks.length>0&&(this.lastTradeTime=new Date(this.ticks[this.startIndex-1].date)),this.plotRealTimeData(),b(!0)}},RiseVision.FinancialChart.Instrument.prototype.plotRealTimeData=function(){var b,c,a=this.realTimeData.getFormattedValue(0,7),d=!1;if(i=0,null!=this.realTimeData){if(this.isLoading)null!=this.realTimeData.getFormattedValue(0,2)&&""!=this.realTimeData.getFormattedValue(0,2)&&null!=this.lastTradeTime&&(b=RiseVision.Common.Utility.adjustTime(new Date(this.realTimeData.getFormattedValue(0,2)),a).clearTime(),"Day"!=this.duration&&"Week"!=this.duration&&(Date.equals(b,this.lastTradeTime)||(this.x.push(this.startIndex),this.y.push(parseFloat(this.realTimeData.getValue(0,1))),this.lastTradeTime=RiseVision.Common.Utility.adjustTime(new Date(this.realTimeData.getFormattedValue(0,2)),a)))),this.isLoading=!1;else if(null!=this.realTimeData.getFormattedValue(0,2)&&""!=this.realTimeData.getFormattedValue(0,2)&&null!=this.lastTradeTime)if(b=RiseVision.Common.Utility.adjustTime(new Date(this.realTimeData.getFormattedValue(0,2)),a),tradeDay=b.clone().clearTime(),lastTradeDay=this.lastTradeTime.clone().clearTime(),Date.equals(tradeDay,lastTradeDay))if("Day"==this.duration||"Week"==this.duration){for(i=0;i<this.ticks.length;i++)if(c=new Date(this.ticks[i].date),c.isAfter(b)||Date.equals(c,b)){d=!0;break}if(d)for(;(c.isAfter(b)||Date.equals(c,b))&&c.isBefore(new Date)&&i<this.y.length;)this.y[i]=parseFloat(this.realTimeData.getValue(0,1)),this.lastTradeTime=b,c.addMilliseconds(this.interval),i++}else this.y[this.startIndex-1]=parseFloat(this.realTimeData.getValue(0,1)),this.lastTradeTime=b;else this.isLoading=!0;null==this.name&&(this.name=this.realTimeData.getFormattedValue(0,3))}else this.isLoading=!1,null==this.name&&(this.name=this.realTimeData.getFormattedValue(0,3))},RiseVision.FinancialChart.PrimaryInstrument={},RiseVision.FinancialChart.PrimaryInstrument.prototype=new RiseVision.FinancialChart.Instrument,RiseVision.FinancialChart.PrimaryInstrument.prototype.constructor=RiseVision.FinancialChart.PrimaryInstrument,RiseVision.FinancialChart.PrimaryInstrument=function(a){this.doCompare=a.doCompare,this.reset(),RiseVision.FinancialChart.Instrument.call(this,{id:a.id,displayID:a.displayID,instrument:a.instrument,duration:a.duration,callback:a.callback})},RiseVision.FinancialChart.PrimaryInstrument.prototype.reset=function(){this.ticks=[],this.volumeX=[],this.volumeY=[],this.accumulatedVolume=0,this.historicCloseX=[],this.historicCloseY=[],this.doCompare&&(this.percentChange=[]),RiseVision.FinancialChart.Instrument.prototype.reset.call(this)},RiseVision.FinancialChart.PrimaryInstrument.prototype.getIsLoading=function(){return RiseVision.FinancialChart.Instrument.prototype.getIsLoading.call(this)},RiseVision.FinancialChart.PrimaryInstrument.prototype.getX=function(){return RiseVision.FinancialChart.Instrument.prototype.getX.call(this)},RiseVision.FinancialChart.PrimaryInstrument.prototype.getY=function(){return RiseVision.FinancialChart.Instrument.prototype.getY.call(this)},RiseVision.FinancialChart.PrimaryInstrument.prototype.getPercentChange=function(){return this.percentChange},RiseVision.FinancialChart.PrimaryInstrument.prototype.getTicks=function(){return this.ticks},RiseVision.FinancialChart.PrimaryInstrument.prototype.getVolumeX=function(){return this.volumeX},RiseVision.FinancialChart.PrimaryInstrument.prototype.getVolumeY=function(){return this.volumeY},RiseVision.FinancialChart.PrimaryInstrument.prototype.getHistoricCloseX=function(){return this.historicCloseX},RiseVision.FinancialChart.PrimaryInstrument.prototype.getHistoricCloseY=function(){return this.historicCloseY},RiseVision.FinancialChart.PrimaryInstrument.prototype.getDuration=function(){return RiseVision.FinancialChart.Instrument.prototype.getDuration.call(this)},RiseVision.FinancialChart.PrimaryInstrument.prototype.setInstrument=function(a){this.reset(),RiseVision.FinancialChart.Instrument.prototype.setInstrument.call(this,a)},RiseVision.FinancialChart.PrimaryInstrument.prototype.setDuration=function(a){this.reset(),RiseVision.FinancialChart.Instrument.prototype.setDuration.call(this,a)},RiseVision.FinancialChart.PrimaryInstrument.prototype.setRealTimeData=function(a){RiseVision.FinancialChart.Instrument.prototype.setRealTimeData.call(this,a)},RiseVision.FinancialChart.PrimaryInstrument.prototype.setIsUpdated=function(a){RiseVision.FinancialChart.Instrument.prototype.setIsUpdated.call(this,a)},RiseVision.FinancialChart.PrimaryInstrument.prototype.loadHistoricalData=function(a){var b=this,c={},d=null;d=this.doCompare?["closePrice","accumulatedVolume","tradeTime","percentChange"]:["closePrice","accumulatedVolume","tradeTime"],this.historical.getHistoricalData(d,function(c){null!=c?b.save(c,a):a(!0)},c)},RiseVision.FinancialChart.PrimaryInstrument.prototype.save=function(a,b){var l,m,c=this,d=0,e=0,f=0,g=0,h=0,i=0,j=null,k="";if(d=a.data.getNumberOfRows(),0==d||1==d&&"0"==a.data.getFormattedValue(0,0))this.numRetries++,this.numRetries==this.retryLimit?(this.numRetries=0,console.log("Unable to load data for: "+this.instrument+" "+this.duration),b(!1)):$.event.trigger("retry",function(){c.loadHistoricalData(b)});else{this.x.length>0&&this.reset(),m=a.collectionData.endTime.clone(),k=a.collectionData.timeZoneOffset,this.collectionStartTime=a.collectionData.startTime,this.collectionEndTime=a.collectionData.endTime;for(var n=0;n<d;n++)if("Day"==this.duration||"Week"==this.duration){for(j=RiseVision.Common.Utility.adjustTime(new Date(a.data.getFormattedValue(n,2)),k),0==n&&(l=new Date(j),l.setHours(this.collectionStartTime.getHours()),l.setMinutes(this.collectionStartTime.getMinutes()),"Day"==this.duration&&this.collectionStartTime.clone().clearTime().isBefore(l.clone().clearTime())&&l.add({days:-1}),lastTradeDay=l.clone().clearTime(),m.setFullYear(l.getFullYear()),m.setMonth(l.getMonth()),m.setDate(l.getDate()),Date.equals(a.collectionData.startTime.clone().clearTime(),a.collectionData.endTime.clone().clearTime())||m.addDays(1),this.doCompare?(f=parseFloat(a.data.getValue(n,0)),g=parseFloat(a.data.getValue(n,3))):f=parseFloat(a.data.getValue(n,0)),h=parseFloat(a.data.getValue(n,1)));j.isAfter(l)&&(l.isBefore(m)||Date.equals(l,m));)i=this.addDataPoint({plotTime:l,tradeTime:j,lastTradeTime:l,endTime:m,collectionStartTime:a.collectionData.startTime.clone().clearTime(),collectionEndTime:a.collectionData.endTime.clone().clearTime(),closePrice:f,volume:h,percentChange:g,index:i});l.isAfter(m)&&(l=new Date(j),l.setHours(this.collectionStartTime.getHours()),l.setMinutes(this.collectionStartTime.getMinutes()),lastTradeDay=l.clone().clearTime(),m.setFullYear(l.getFullYear()),m.setMonth(l.getMonth()),m.setDate(l.getDate())),this.doCompare?(e=parseFloat(a.data.getValue(n,0)),g=parseFloat(a.data.getValue(n,3))):e=parseFloat(a.data.getValue(n,0)),i=this.addDataPoint({plotTime:l,tradeTime:j,lastTradeTime:l,endTime:m,collectionStartTime:a.collectionData.startTime.clone().clearTime(),collectionEndTime:a.collectionData.endTime.clone().clearTime(),closePrice:e,volume:parseFloat(a.data.getValue(n,1)),percentChange:g,index:i}),f=e,h=parseFloat(a.data.getValue(n,1))}else this.doCompare?(e=parseFloat(a.data.getValue(n,0)),this.percentChange.push(parseFloat(a.data.getValue(n,3)))):e=parseFloat(a.data.getValue(n,0)),this.ticks.push({date:RiseVision.Common.Utility.adjustTime(new Date(a.data.getFormattedValue(n,2)),k).getTime(),originalDate:new Date(a.data.getFormattedValue(n,2)).getTime(),close:e,volume:parseInt(a.data.getFormattedValue(n,1))}),this.x.push(n),this.volumeX.push(n),this.y.push(parseFloat(a.data.getValue(n,0))),this.volumeY.push(parseFloat(a.data.getValue(n,1)));if("Day"==this.duration||"Week"==this.duration){var o=new Date;if(o.clone().clearTime().isAfter(l.clone().clearTime())||Date.equals(o.clone().clearTime(),l.clone().clearTime()))for(;l.isBefore(m)&&l.isBefore(o);)this.ticks.push({date:l.getTime(),close:f,volume:h}),this.x.push(i),this.volumeX.push(i),this.y.push(f),this.volumeY.push(h),this.doCompare&&this.percentChange.push(g),l.addMilliseconds(this.interval),i++;else for(;l.isBefore(o);)this.ticks.push({date:l.getTime(),close:f,volume:h}),this.x.push(i),this.volumeX.push(i),this.y.push(f),this.volumeY.push(h),this.doCompare&&this.percentChange.push(g),l.addMilliseconds(this.interval),i++;this.startIndex=i}else this.startIndex=d;"Day"==this.duration&&this.addExtraTicks(a.collectionData,new Date(this.ticks[this.ticks.length-1].date)),this.numRetries=0,this.lastTradeTime=new Date(this.ticks[this.startIndex-1].date),this.plotRealTimeData(),b(!0)}},RiseVision.FinancialChart.PrimaryInstrument.prototype.addDataPoint=function(a){var b,c;return this.ticks.push({date:a.plotTime.getTime(),close:a.closePrice,volume:a.volume}),this.x.push(a.index),this.volumeX.push(a.index),this.y.push(a.closePrice),this.volumeY.push(a.volume),this.doCompare&&this.percentChange.push(a.percentChange),c=a.lastTradeTime.clone().clearTime(),a.lastTradeTime.addMilliseconds(this.interval),b=a.lastTradeTime.clone().clearTime(),Date.equals(c,b)||Date.equals(c,a.tradeTime.clone().clearTime())||(a.lastTradeTime.setFullYear(a.tradeTime.getFullYear()),a.lastTradeTime.setMonth(a.tradeTime.getMonth()),a.lastTradeTime.setDate(a.tradeTime.getDate())),a.endTime.setFullYear(a.lastTradeTime.getFullYear()),a.endTime.setMonth(a.lastTradeTime.getMonth()),a.endTime.setDate(a.lastTradeTime.getDate()),Date.equals(a.collectionStartTime,a.collectionEndTime)||a.endTime.addDays(1),a.index+1},RiseVision.FinancialChart.PrimaryInstrument.prototype.plotRealTimeData=function(){var a,b,c,d,e,f=this.realTimeData.getFormattedValue(0,11),g=!1,i=0;if(null!=this.realTimeData){if(e=parseFloat(this.realTimeData.getValue(0,2)),this.isLoading){if(null!=this.realTimeData.getFormattedValue(0,5)&&""!=this.realTimeData.getFormattedValue(0,5)&&null!=this.lastTradeTime){if(a=RiseVision.Common.Utility.adjustTime(new Date(this.realTimeData.getFormattedValue(0,5)),f).clearTime(),"Day"==this.duration)for(i=0;i<this.x.length;i++)this.historicCloseX.push(i),this.historicCloseY.push(parseFloat(this.realTimeData.getValue(0,6)));"Day"!=this.duration&&"Week"!=this.duration&&(Date.equals(a,this.lastTradeTime)||(this.ticks.push({date:RiseVision.Common.Utility.adjustTime(new Date(this.realTimeData.getFormattedValue(0,5)),f).getTime(),close:e,volume:parseInt(this.realTimeData.getFormattedValue(0,4))}),this.x.push(this.startIndex),this.volumeX.push(this.startIndex),this.y.push(e),this.volumeY.push(parseFloat(this.realTimeData.getValue(0,4))),this.doCompare&&this.percentChange.push(parseFloat(this.realTimeData.getValue(0,7))),this.startIndex++))}this.isLoading=!1,this.lastTradeTime=RiseVision.Common.Utility.adjustTime(new Date(this.realTimeData.getFormattedValue(0,5)),f)}else if(null!=this.realTimeData.getFormattedValue(0,5)&&""!=this.realTimeData.getFormattedValue(0,5)&&null!=this.lastTradeTime)if(a=RiseVision.Common.Utility.adjustTime(new Date(this.realTimeData.getFormattedValue(0,5)),f),c=a.clone().clearTime(),d=this.lastTradeTime.clone().clearTime(),Date.equals(c,d))if("Day"==this.duration||"Week"==this.duration){for(i=0;i<this.ticks.length;i++)if(b=new Date(this.ticks[i].date),b.isAfter(a)||Date.equals(b,a)){g=!0;break}if(g)for(Date.equals(a,this.lastTradeTime)||(this.volume=parseFloat(this.realTimeData.getValue(0,4))-this.accumulatedVolume);(b.isAfter(a)||Date.equals(b,a))&&b.isBefore(new Date);)"Day"==this.duration?i<this.ticks.length&&(this.ticks[i].close=e,this.ticks[i].volume=this.volume,this.y[i]=e,this.volumeY[i]=this.volume,this.doCompare&&(this.percentChange[i]=parseFloat(this.realTimeData.getValue(0,7)))):(this.ticks.push({date:RiseVision.Common.Utility.adjustTime(new Date(this.realTimeData.getFormattedValue(0,5)),f).getTime(),close:e,volume:parseFloat(this.realTimeData.getValue(0,4))-this.accumulatedVolume}),this.x.push(i),this.volumeX.push(i),this.y.push(e),this.volumeY.push(parseFloat(this.realTimeData.getValue(0,4))-this.accumulatedVolume),this.doCompare&&this.percentChange.push(parseFloat(this.realTimeData.getValue(0,7)))),this.lastTradeTime=a,b.addMilliseconds(this.interval),i++}else this.ticks[this.startIndex-1].date=new Date(this.realTimeData.getFormattedValue(0,5)).getTime(),this.ticks[this.startIndex-1].close=e,this.ticks[this.startIndex-1].volume=parseFloat(this.realTimeData.getValue(0,4))-this.accumulatedVolume,this.y[this.startIndex-1]=e,this.volumeY[this.startIndex-1]=parseFloat(this.realTimeData.getValue(0,4))-this.accumulatedVolume,this.doCompare&&(this.percentChange[this.startIndex-1]=parseFloat(this.realTimeData.getValue(0,7))),this.lastTradeTime=a;else this.isLoading=!0;this.accumulatedVolume=parseFloat(this.realTimeData.getValue(0,4))}else this.isLoading=!1},RiseVision.FinancialChart.PrimaryInstrument.prototype.getNumDayIntervals=function(a,b,c){var d=a.getTime(),e=b.getTime(),f=e-d;return Math.round(f/c)},RiseVision.FinancialChart.PrimaryInstrument.prototype.addExtraTicks=function(a,b){var c=0,d=new Date(b),e=new Date(a.endTime);c=this.getNumDayIntervals(a.startTime,a.endTime,this.interval);for(var g=this.startIndex;g<c&&(b.add({milliseconds:this.interval}),d=new Date(b),d.isBefore(e));g++)this.ticks.push({date:b.getTime(),close:0,volume:0}),this.x.push(g),this.volumeX.push(g),this.y.push(-1e3),this.volumeY.push(""),null!=this.percentChange&&this.percentChange.push(-1e3)};